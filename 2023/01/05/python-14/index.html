<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hot5656.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"},"path":"/search.json","localsearch":{"enable":"enable","trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="說明check scrapy methoud JavaScript Require? check API supported - Network &gt; Fetch&#x2F;XHR check pagination">
<meta property="og:type" content="article">
<meta property="og:title" content="Python Scrapy Practice(Advanced)">
<meta property="og:url" content="https://hot5656.github.io/2023/01/05/python-14/index.html">
<meta property="og:site_name" content="Robert 雜記">
<meta property="og:description" content="說明check scrapy methoud JavaScript Require? check API supported - Network &gt; Fetch&#x2F;XHR check pagination">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://hot5656.github.io/2023/01/05/python-14/pic1.png">
<meta property="og:image" content="https://hot5656.github.io/2023/01/05/python-14/pic2.png">
<meta property="og:image" content="https://hot5656.github.io/2023/01/05/python-14/pic3.png">
<meta property="og:image" content="https://hot5656.github.io/2023/01/05/python-14/pic4.png">
<meta property="og:image" content="https://hot5656.github.io/2023/01/05/python-14/pic5.png">
<meta property="og:image" content="https://hot5656.github.io/2023/01/05/python-14/pic6.png">
<meta property="article:published_time" content="2023-01-05T01:18:23.000Z">
<meta property="article:modified_time" content="2023-01-16T07:02:12.564Z">
<meta property="article:author" content="Robert Kao">
<meta property="article:tag" content="python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hot5656.github.io/2023/01/05/python-14/pic1.png">


<link rel="canonical" href="https://hot5656.github.io/2023/01/05/python-14/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>
<title>Python Scrapy Practice(Advanced) | Robert 雜記</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Robert 雜記</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔列表</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AA%AA%E6%98%8E"><span class="nav-number">1.</span> <span class="nav-text">說明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#check-scrapy-methoud"><span class="nav-number">1.1.</span> <span class="nav-text">check scrapy methoud</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#scrapy-coding-checklist"><span class="nav-number">1.2.</span> <span class="nav-text">scrapy coding checklist</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Centris-Canada"><span class="nav-number">2.</span> <span class="nav-text">Centris Canada</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#get-1st-page-list"><span class="nav-number">2.1.</span> <span class="nav-text">get 1st page list</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#create-project-and-spider"><span class="nav-number">2.1.1.</span> <span class="nav-text">create project and spider</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#listing-py"><span class="nav-number">2.1.2.</span> <span class="nav-text">listing.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run"><span class="nav-number">2.1.3.</span> <span class="nav-text">run</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#add-paignation"><span class="nav-number">2.2.</span> <span class="nav-text">add paignation</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#listing-py-1"><span class="nav-number">2.2.1.</span> <span class="nav-text">listing.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-utf-8-output-for-json-settings-py"><span class="nav-number">2.2.2.</span> <span class="nav-text">set utf-8 output(for json) - settings.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-1"><span class="nav-number">2.2.3.</span> <span class="nav-text">run</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#add-splash-for-address-and-descript"><span class="nav-number">2.3.</span> <span class="nav-text">add splash for address and descript</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#settings-py"><span class="nav-number">2.3.1.</span> <span class="nav-text">settings.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#listing-py-2"><span class="nav-number">2.3.2.</span> <span class="nav-text">listing.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-2"><span class="nav-number">2.3.3.</span> <span class="nav-text">run</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#run-Aquarium"><span class="nav-number">2.4.</span> <span class="nav-text">run Aquarium</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#install-Aquarium"><span class="nav-number">2.4.1.</span> <span class="nav-text">install Aquarium</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-Aquarium-need-stop-all-splash"><span class="nav-number">2.4.2.</span> <span class="nav-text">run Aquarium (need stop all splash)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2nd-time-run-Aquarium"><span class="nav-number">2.4.3.</span> <span class="nav-text">2nd time run Aquarium</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#test-by-GUI-splash"><span class="nav-number">2.4.4.</span> <span class="nav-text">test by GUI(splash)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#test-by-GUI-General-process-information"><span class="nav-number">2.4.5.</span> <span class="nav-text">test by GUI(General process information)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#listing-py-3"><span class="nav-number">2.4.6.</span> <span class="nav-text">listing.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-3"><span class="nav-number">2.4.7.</span> <span class="nav-text">run</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Steam-Store"><span class="nav-number">3.</span> <span class="nav-text">Steam Store</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#get-best-selling-games"><span class="nav-number">3.1.</span> <span class="nav-text">get best selling games</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#create-project-and-spider-1"><span class="nav-number">3.1.1.</span> <span class="nav-text">create project and spider</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#scrapy-shell-test"><span class="nav-number">3.1.2.</span> <span class="nav-text">scrapy shell test</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#experiment-py-for-test"><span class="nav-number">3.1.3.</span> <span class="nav-text">experiment.py - for test</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#items-py"><span class="nav-number">3.1.4.</span> <span class="nav-text">items.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#best-selling-py"><span class="nav-number">3.1.5.</span> <span class="nav-text">best_selling.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-4"><span class="nav-number">3.1.6.</span> <span class="nav-text">run</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pagination"><span class="nav-number">3.2.</span> <span class="nav-text">pagination</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#items-py-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">items.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#more-best-py"><span class="nav-number">3.2.2.</span> <span class="nav-text">more_best.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-5"><span class="nav-number">3.2.3.</span> <span class="nav-text">run</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#change-to-ItemLoader"><span class="nav-number">3.3.</span> <span class="nav-text">change to ItemLoader</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#more-best-py-1"><span class="nav-number">3.3.1.</span> <span class="nav-text">more_best.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-6"><span class="nav-number">3.3.2.</span> <span class="nav-text">run</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#items-py-data-process"><span class="nav-number">3.4.</span> <span class="nav-text">items.py data process</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#items-py-2"><span class="nav-number">3.4.1.</span> <span class="nav-text">items.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#more-best-py-2"><span class="nav-number">3.4.2.</span> <span class="nav-text">more_best.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-7"><span class="nav-number">3.4.3.</span> <span class="nav-text">run</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zillow"><span class="nav-number">4.</span> <span class="nav-text">Zillow</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1st-run"><span class="nav-number">4.1.</span> <span class="nav-text">1st run</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#generate-project-amp-spider"><span class="nav-number">4.1.1.</span> <span class="nav-text">generate project &amp; spider</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#settings-py-change"><span class="nav-number">4.1.2.</span> <span class="nav-text">settings.py change</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#utils-py"><span class="nav-number">4.1.3.</span> <span class="nav-text">utils.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#zillow-houses-py"><span class="nav-number">4.1.4.</span> <span class="nav-text">zillow_houses.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-8"><span class="nav-number">4.1.5.</span> <span class="nav-text">run</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#add-cookie-to-headers-It-doesn%E2%80%99t-need-but-for-test"><span class="nav-number">4.2.</span> <span class="nav-text">add cookie to headers(It doesn’t need, but for test)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#utils-py-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">utils.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#zillow-houses-py-1"><span class="nav-number">4.2.2.</span> <span class="nav-text">zillow_houses.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-9"><span class="nav-number">4.2.3.</span> <span class="nav-text">run</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#initial-response-json"><span class="nav-number">4.2.4.</span> <span class="nav-text">initial_response.json</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pagination"><span class="nav-number">4.3.</span> <span class="nav-text">Pagination</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#utils-py-2"><span class="nav-number">4.3.1.</span> <span class="nav-text">utils.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#items-py-3"><span class="nav-number">4.3.2.</span> <span class="nav-text">items.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#zillow-houses-py-2"><span class="nav-number">4.3.3.</span> <span class="nav-text">zillow_houses.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-10"><span class="nav-number">4.3.4.</span> <span class="nav-text">run</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#download-images"><span class="nav-number">4.4.</span> <span class="nav-text">download images</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#install-pillow"><span class="nav-number">4.4.1.</span> <span class="nav-text">install pillow</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#settings-py-1"><span class="nav-number">4.4.2.</span> <span class="nav-text">settings.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#items-py-4"><span class="nav-number">4.4.3.</span> <span class="nav-text">items.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#zillow-houses-py-3"><span class="nav-number">4.4.4.</span> <span class="nav-text">zillow_houses.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-11"><span class="nav-number">4.4.5.</span> <span class="nav-text">run</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#change-image-name-to-id"><span class="nav-number">4.5.</span> <span class="nav-text">change image name to id</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#pipelines-py"><span class="nav-number">4.5.1.</span> <span class="nav-text">pipelines.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#settings-py-2"><span class="nav-number">4.5.2.</span> <span class="nav-text">settings.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-12"><span class="nav-number">4.5.3.</span> <span class="nav-text">run</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Desktop-App"><span class="nav-number">5.</span> <span class="nav-text">Desktop App</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#gui"><span class="nav-number">5.1.</span> <span class="nav-text">gui</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#gui-app-py"><span class="nav-number">5.1.1.</span> <span class="nav-text">gui_app.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-13"><span class="nav-number">5.1.2.</span> <span class="nav-text">run</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#link-to-spider"><span class="nav-number">5.2.</span> <span class="nav-text">link to spider</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#gui-app-py-1"><span class="nav-number">5.2.1.</span> <span class="nav-text">gui_app.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-14"><span class="nav-number">5.2.2.</span> <span class="nav-text">run</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Async-Crawl"><span class="nav-number">5.3.</span> <span class="nav-text">Async Crawl</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#gui-app-py-2"><span class="nav-number">5.3.1.</span> <span class="nav-text">gui_app.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-15"><span class="nav-number">5.3.2.</span> <span class="nav-text">run</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ref"><span class="nav-number">6.</span> <span class="nav-text">Ref</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Robert Kao"
      src="/images/head.png">
  <p class="site-author-name" itemprop="name">Robert Kao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">170</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://hot5656.github.io/2023/01/05/python-14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="Robert Kao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Robert 雜記">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Python Scrapy Practice(Advanced)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2023-01-05 09:18:23" itemprop="dateCreated datePublished" datetime="2023-01-05T09:18:23+08:00">2023-01-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新於</span>
        <time title="修改時間：2023-01-16 15:02:12" itemprop="dateModified" datetime="2023-01-16T15:02:12+08:00">2023-01-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Coding/" itemprop="url" rel="index"><span itemprop="name">Coding</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2023/01/05/python-14/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2023/01/05/python-14/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>93k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>1:24</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="說明"><a href="#說明" class="headerlink" title="說明"></a>說明</h3><h4 id="check-scrapy-methoud"><a href="#check-scrapy-methoud" class="headerlink" title="check scrapy methoud"></a>check scrapy methoud</h4><ul>
<li>JavaScript Require?</li>
<li>check API supported - Network &gt; Fetch&#x2F;XHR</li>
<li>check pagination</li>
</ul>
<span id="more"></span>

<h4 id="scrapy-coding-checklist"><a href="#scrapy-coding-checklist" class="headerlink" title="scrapy coding checklist"></a>scrapy coding checklist</h4><ul>
<li>field process by items.py</li>
</ul>
<h3 id="Centris-Canada"><a href="#Centris-Canada" class="headerlink" title="Centris Canada"></a><a target="_blank" rel="noopener" href="https://www.centris.ca/en">Centris Canada</a></h3><h4 id="get-1st-page-list"><a href="#get-1st-page-list" class="headerlink" title="get 1st page list"></a>get 1st page list</h4><h5 id="create-project-and-spider"><a href="#create-project-and-spider" class="headerlink" title="create project and spider"></a>create project and spider</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice&gt;scrapy startproject centris</span><br><span class="line">New Scrapy project <span class="string">&#x27;centris&#x27;</span>, using template directory <span class="string">&#x27;D:\app\python_env\myenv10_scrapy\lib\site-packages\scrapy\templates\project&#x27;</span>, created <span class="keyword">in</span>:</span><br><span class="line">    D:\work\run\python_crawler\108-scrapy-practice\centris</span><br><span class="line">You can start your first spider with:</span><br><span class="line">    <span class="built_in">cd</span> centris</span><br><span class="line">    scrapy genspider example example.com</span><br><span class="line"></span><br><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice&gt;<span class="built_in">cd</span> centris</span><br><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\centris&gt;scrapy genspider listing www.centris.ca/en</span><br><span class="line">Created spider <span class="string">&#x27;listing&#x27;</span> using template <span class="string">&#x27;basic&#x27;</span> <span class="keyword">in</span> module:</span><br><span class="line">  centris.spiders.listing</span><br></pre></td></tr></table></figure>

<h5 id="listing-py"><a href="#listing-py" class="headerlink" title="listing.py"></a>listing.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.selector <span class="keyword">import</span> Selector</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListingSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;listing&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;www.centris.ca&#x27;</span>]</span><br><span class="line">    position = &#123;</span><br><span class="line">        <span class="string">&quot;startPosition&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        query = &#123;</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;UseGeographyShapes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;Filters&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;MatchType&quot;</span>: <span class="string">&quot;CityDistrictAll&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Text&quot;</span>: <span class="string">&quot;Montréal (All boroughs)&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Id&quot;</span>: <span class="number">5</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;FieldsValues&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;CityDistrictAll&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">5</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;Category&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;Residential&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;SellingType&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;Rent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;LandArea&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;SquareFeet&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;IsLandArea&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;RentPrice&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;ForRent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;RentPrice&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">1500</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;ForRent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;isHomePage&quot;</span>: <span class="literal">True</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url=<span class="string">&quot;https://www.centris.ca/property/UpdateQuery&quot;</span>,</span><br><span class="line">            method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">            body=json.dumps(query),</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json; charset=utf-8&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            callback=self.update_query</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_query</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="comment"># print(&quot;=====================&quot;)</span></span><br><span class="line">        <span class="comment"># print(response.body)</span></span><br><span class="line">        <span class="comment"># print(&quot;=====================&quot;)</span></span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url=<span class="string">&quot;https://www.centris.ca/Property/GetInscriptions&quot;</span>,</span><br><span class="line">            method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">            body=json.dumps(self.position),</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json; charset=utf-8&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            callback=self.parse</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        resp_dict = json.loads(response.body)</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">type</span>(resp_dict))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=====================&quot;</span>)</span><br><span class="line">        <span class="comment"># print(response.body)</span></span><br><span class="line">        <span class="comment"># print(resp_dict)</span></span><br><span class="line">        <span class="comment"># resp_dict[&#x27;d&#x27;][&#x27;Result&#x27;][&#x27;html&#x27;] - same as below</span></span><br><span class="line"></span><br><span class="line">        html = resp_dict.get(<span class="string">&#x27;d&#x27;</span>).get(<span class="string">&#x27;Result&#x27;</span>).get(<span class="string">&#x27;html&#x27;</span>)</span><br><span class="line">        sel = Selector(text=html)</span><br><span class="line">        listings = sel.xpath(<span class="string">&quot;//div[@class=&#x27;shell&#x27;]&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># print html or write to file</span></span><br><span class="line">        <span class="comment"># print(html)</span></span><br><span class="line">        <span class="comment"># print(&quot;=====================&quot;)</span></span><br><span class="line">        <span class="comment"># with open(&#x27;index.html&#x27;, &#x27;w&#x27;) as f:</span></span><br><span class="line">        <span class="comment">#     f.write(html)</span></span><br><span class="line">        <span class="keyword">for</span> listing <span class="keyword">in</span> listings:</span><br><span class="line">            category = listing.xpath(<span class="string">&quot;normalize-space(.//span[@class=&#x27;category&#x27;]/div/text())&quot;</span>).get()</span><br><span class="line">            <span class="comment"># some room not include bed</span></span><br><span class="line">            bedrooms = listing.xpath(<span class="string">&quot;.//div[@class=&#x27;cac&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            bathrooms =  listing.xpath(<span class="string">&quot;.//div[@class=&#x27;sdb&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            <span class="keyword">if</span> bedrooms:</span><br><span class="line">                features = <span class="string">f&quot;<span class="subst">&#123;bedrooms&#125;</span> Bed, <span class="subst">&#123;bathrooms&#125;</span> Bath&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                features = <span class="string">f&quot;<span class="subst">&#123;bathrooms&#125;</span> Bath&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># remove character &quot;,&quot; space and $</span></span><br><span class="line">            price_str =  listing.xpath(<span class="string">&quot;.//div[@class=&#x27;price&#x27;]/span/text()&quot;</span>).get()</span><br><span class="line">            price = re.sub(<span class="string">&quot;[^0-9]&quot;</span>, <span class="string">&quot;&quot;</span>,  price_str)</span><br><span class="line">            city = listing.xpath(<span class="string">&quot;(.//span[@class=&#x27;address&#x27;]/div)[2]/text()&quot;</span>).get()</span><br><span class="line">            url = listing.xpath(<span class="string">&quot;.//a[@class=&#x27;property-thumbnail-summary-link&#x27;]/@href&quot;</span>).get()</span><br><span class="line">            <span class="keyword">yield</span> &#123;</span><br><span class="line">                <span class="string">&#x27;category&#x27;</span>: category,</span><br><span class="line">                <span class="string">&#x27;features&#x27;</span>: features,</span><br><span class="line">                <span class="string">&#x27;price&#x27;</span>: price,</span><br><span class="line">                <span class="string">&#x27;city&#x27;</span>: city,</span><br><span class="line">                <span class="string">&#x27;url&#x27;</span>: response.urljoin(url)</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h5 id="run"><a href="#run" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\centris&gt;scrapy crawl listing</span><br><span class="line">......</span><br><span class="line">2023-01-05 16:26:42 [scrapy.core.engine] DEBUG: Crawled (200) &lt;POST https://www.centris.ca/Property/GetInscriptions&gt; (referer: https://www.centris.ca/property/UpdateQuery)</span><br><span class="line">2023-01-05 16:26:42 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://www.centris.ca/Property/GetInscriptions&gt;</span><br><span class="line"><span class="comment"># 1st item</span></span><br><span class="line">&#123;	<span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;Condo / Appartement à louer&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;features&#x27;</span>: <span class="string">&#x27;1 Bed, 1 Bath&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;1350&#x27;</span>, <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;Montréal (Ville-Marie)&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;https://www.centris.ca/fr/condo-appartement~a-louer~montreal-ville-marie/16675303?view=Summary&#x27;</span>&#125;</span><br><span class="line">2023-01-05 16:26:42 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://www.centris.ca/Property/GetInscriptions&gt;</span><br><span class="line">&#123;<span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;Condo / Appartement à louer&#x27;</span>, <span class="string">&#x27;features&#x27;</span>: <span class="string">&#x27;1 Bed, 1 Bath&#x27;</span>, <span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;1310&#x27;</span>, <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;Montréal (LaSalle)&#x27;</span>, <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;https://www.centris.ca/fr/condo-appartement~a-louer~montreal-lasalle/10326169?view=Summary&#x27;</span>&#125;</span><br><span class="line">2023-01-05 16:26:42 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://www.centris.ca/Property/GetInscriptions&gt;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="add-paignation"><a href="#add-paignation" class="headerlink" title="add paignation"></a>add paignation</h4><h5 id="listing-py-1"><a href="#listing-py-1" class="headerlink" title="listing.py"></a>listing.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.selector <span class="keyword">import</span> Selector</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListingSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;listing&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;www.centris.ca&#x27;</span>]</span><br><span class="line">    position = &#123;</span><br><span class="line">        <span class="string">&quot;startPosition&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        query = &#123;</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;UseGeographyShapes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;Filters&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;MatchType&quot;</span>: <span class="string">&quot;CityDistrictAll&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Text&quot;</span>: <span class="string">&quot;Montréal (All boroughs)&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Id&quot;</span>: <span class="number">5</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;FieldsValues&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;CityDistrictAll&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">5</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;Category&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;Residential&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;SellingType&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;Rent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;LandArea&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;SquareFeet&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;IsLandArea&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;RentPrice&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;ForRent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;RentPrice&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">1500</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;ForRent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;isHomePage&quot;</span>: <span class="literal">True</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url=<span class="string">&quot;https://www.centris.ca/property/UpdateQuery&quot;</span>,</span><br><span class="line">            method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">            body=json.dumps(query),</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json; charset=utf-8&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            callback=self.update_query</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_query</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="comment"># print(&quot;=====================&quot;)</span></span><br><span class="line">        <span class="comment"># print(response.body)</span></span><br><span class="line">        <span class="comment"># print(&quot;=====================&quot;)</span></span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url=<span class="string">&quot;https://www.centris.ca/Property/GetInscriptions&quot;</span>,</span><br><span class="line">            method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">            body=json.dumps(self.position),</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json; charset=utf-8&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            callback=self.parse</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        resp_dict = json.loads(response.body)</span><br><span class="line">        <span class="comment"># print(type(resp_dict))</span></span><br><span class="line">        <span class="comment"># print(&quot;=====================&quot;)</span></span><br><span class="line">        <span class="comment"># print(response.body)</span></span><br><span class="line">        <span class="comment"># print(resp_dict)</span></span><br><span class="line">        <span class="comment"># resp_dict[&#x27;d&#x27;][&#x27;Result&#x27;][&#x27;html&#x27;] - same as below</span></span><br><span class="line"></span><br><span class="line">        html = resp_dict.get(<span class="string">&#x27;d&#x27;</span>).get(<span class="string">&#x27;Result&#x27;</span>).get(<span class="string">&#x27;html&#x27;</span>)</span><br><span class="line">        sel = Selector(text=html)</span><br><span class="line">        listings = sel.xpath(<span class="string">&quot;//div[@class=&#x27;shell&#x27;]&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># print html or write to file</span></span><br><span class="line">        <span class="comment"># print(html)</span></span><br><span class="line">        <span class="comment"># print(&quot;=====================&quot;)</span></span><br><span class="line">        <span class="comment"># with open(&#x27;index.html&#x27;, &#x27;w&#x27;) as f:</span></span><br><span class="line">        <span class="comment">#     f.write(html)</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;------------&gt; index <span class="subst">&#123;self.position[<span class="string">&#x27;startPosition&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> listing <span class="keyword">in</span> listings:</span><br><span class="line">            category = listing.xpath(<span class="string">&quot;normalize-space(.//span[@class=&#x27;category&#x27;]/div/text())&quot;</span>).get()</span><br><span class="line">            <span class="comment"># some room not include bed</span></span><br><span class="line">            bedrooms = listing.xpath(<span class="string">&quot;.//div[@class=&#x27;cac&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            bathrooms =  listing.xpath(<span class="string">&quot;.//div[@class=&#x27;sdb&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            <span class="keyword">if</span> bedrooms:</span><br><span class="line">                features = <span class="string">f&quot;<span class="subst">&#123;bedrooms&#125;</span> Bed, <span class="subst">&#123;bathrooms&#125;</span> Bath&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                features = <span class="string">f&quot;<span class="subst">&#123;bathrooms&#125;</span> Bath&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># price = &quot;1&amp;nbsp;500 $&quot;</span></span><br><span class="line">            <span class="comment"># price = listing.xpath(&quot;.//div[@class=&#x27;price&#x27;]/span/text()&quot;).get()</span></span><br><span class="line">            <span class="comment"># remove character &quot;,&quot; space and $</span></span><br><span class="line">            price_str =  listing.xpath(<span class="string">&quot;.//div[@class=&#x27;price&#x27;]/span/text()&quot;</span>).get()</span><br><span class="line">            price = price_str[-<span class="number">1</span>] + <span class="string">&quot; &quot;</span> + re.sub(<span class="string">&quot;[^0-9]&quot;</span>, <span class="string">&quot;&quot;</span>,  price_str)</span><br><span class="line">            city = listing.xpath(<span class="string">&quot;(.//span[@class=&#x27;address&#x27;]/div)[2]/text()&quot;</span>).get()</span><br><span class="line">            url = listing.xpath(<span class="string">&quot;.//a[@class=&#x27;property-thumbnail-summary-link&#x27;]/@href&quot;</span>).get()</span><br><span class="line">            <span class="comment"># print(&quot;=====================&quot;)</span></span><br><span class="line">            <span class="comment"># print(listing.xpath(&quot;.//div[@class=&#x27;price&#x27;]&quot;).get())</span></span><br><span class="line">            <span class="comment"># print(listing.xpath(&quot;.//div[@class=&#x27;price&#x27;]/span&quot;).getall())</span></span><br><span class="line">            <span class="keyword">yield</span> &#123;</span><br><span class="line">                <span class="string">&#x27;category&#x27;</span>: category,</span><br><span class="line">                <span class="string">&#x27;features&#x27;</span>: features,</span><br><span class="line">                <span class="string">&#x27;price&#x27;</span>: price,</span><br><span class="line">                <span class="string">&#x27;city&#x27;</span>: city,</span><br><span class="line">                <span class="string">&#x27;url&#x27;</span>: response.urljoin(url)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        count = resp_dict.get(<span class="string">&#x27;d&#x27;</span>).get(<span class="string">&#x27;Result&#x27;</span>).get(<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">        increment_number = resp_dict.get(<span class="string">&#x27;d&#x27;</span>).get(<span class="string">&#x27;Result&#x27;</span>).get(<span class="string">&#x27;inscNumberPerPage&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.position[<span class="string">&#x27;startPosition&#x27;</span>]+increment_number &lt;  count:</span><br><span class="line">            self.position[<span class="string">&#x27;startPosition&#x27;</span>] += increment_number</span><br><span class="line"></span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">                url=<span class="string">&quot;https://www.centris.ca/Property/GetInscriptions&quot;</span>,</span><br><span class="line">                method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">                body=json.dumps(self.position),</span><br><span class="line">                headers=&#123;</span><br><span class="line">                    <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json; charset=utf-8&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                callback=self.parse</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<h5 id="set-utf-8-output-for-json-settings-py"><a href="#set-utf-8-output-for-json-settings-py" class="headerlink" title="set utf-8 output(for json) - settings.py"></a>set utf-8 output(for json) - settings.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set JSON utf-8 format</span></span><br><span class="line">FEED_EXPORT_ENCODING = <span class="string">&#x27;utf-8&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="run-1"><a href="#run-1" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\centris&gt;scrapy crawl listing</span><br><span class="line">......</span><br><span class="line">2023-01-06 09:28:34 [scrapy.core.engine] DEBUG: Crawled (200) &lt;POST https://www.centris.ca/Property/GetInscriptions&gt; (referer: https://www.centris.ca/property/UpdateQuery)</span><br><span class="line">------------&gt; index 0</span><br><span class="line">2023-01-06 09:28:34 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://www.centris.ca/Property/GetInscriptions&gt;</span><br><span class="line"><span class="comment"># 1st item</span></span><br><span class="line">&#123;	<span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;Condo / Appartement à louer&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;features&#x27;</span>: <span class="string">&#x27;2 Bed, 1 Bath&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;$ 1330&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;Montréal (Ahuntsic-Cartierville)&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;https://www.centris.ca/fr/condo-appartement~a-louer~montreal-ahuntsic-cartierville/14983973?view=Summary&#x27;</span>&#125;</span><br><span class="line">2023-01-06 09:28:34 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://www.centris.ca/Property/GetInscriptions&gt;</span><br><span class="line">&#123;<span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;Condo / Appartement à louer&#x27;</span>, <span class="string">&#x27;features&#x27;</span>: <span class="string">&#x27;1 Bed, 1 Bath&#x27;</span>, <span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;$ 1275&#x27;</span>, <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;Montréal (Rosemont/La Petite-Patrie)&#x27;</span>, <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;https://www.centris.ca/fr/condo-appartement~a-louer~montreal-rosemont-la-petite-patrie/21322348?view=Summary&#x27;</span>&#125;</span><br><span class="line">2023-01-06 09:28:34 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://www.centris.ca/Property/GetInscriptions&gt;</span><br><span class="line">&#123;<span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;Condo / Appartement à louer&#x27;</span>, <span class="string">&#x27;features&#x27;</span>: <span class="string">&#x27;1 Bed, 1 Bath&#x27;</span>, <span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;$ 1500&#x27;</span>, <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;Montréal (Saint-Laurent)&#x27;</span>, <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;https://www.centris.ca/fr/condo-appartement~a-louer~montreal-saint-laurent/19322513?view=Summary&#x27;</span>&#125;</span><br><span class="line">......</span><br><span class="line">&#123;<span class="string">&#x27;downloader/request_bytes&#x27;</span>: 17270,</span><br><span class="line"> <span class="string">&#x27;downloader/request_count&#x27;</span>: 24,</span><br><span class="line"> <span class="string">&#x27;downloader/request_method_count/GET&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;downloader/request_method_count/POST&#x27;</span>: 23,</span><br><span class="line"> <span class="string">&#x27;downloader/response_bytes&#x27;</span>: 1696842,</span><br><span class="line"> <span class="string">&#x27;downloader/response_count&#x27;</span>: 24,</span><br><span class="line"> <span class="string">&#x27;downloader/response_status_count/200&#x27;</span>: 23,</span><br><span class="line"> <span class="string">&#x27;downloader/response_status_count/403&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;elapsed_time_seconds&#x27;</span>: 10.000307,</span><br><span class="line"> <span class="string">&#x27;finish_reason&#x27;</span>: <span class="string">&#x27;finished&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;finish_time&#x27;</span>: datetime.datetime(2023, 1, 6, 1, 43, 56, 271826),</span><br><span class="line"> <span class="comment"># item count</span></span><br><span class="line"> <span class="string">&#x27;item_scraped_count&#x27;</span>: 426,</span><br><span class="line"> <span class="string">&#x27;log_count/DEBUG&#x27;</span>: 457,</span><br><span class="line"> <span class="string">&#x27;log_count/INFO&#x27;</span>: 10,</span><br><span class="line"> <span class="string">&#x27;request_depth_max&#x27;</span>: 22,</span><br><span class="line"> <span class="string">&#x27;response_received_count&#x27;</span>: 24,</span><br><span class="line"> <span class="string">&#x27;robotstxt/request_count&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;robotstxt/response_count&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;robotstxt/response_status_count/403&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;scheduler/dequeued&#x27;</span>: 23,</span><br><span class="line"> <span class="string">&#x27;scheduler/dequeued/memory&#x27;</span>: 23,</span><br><span class="line"> <span class="string">&#x27;scheduler/enqueued&#x27;</span>: 23,</span><br><span class="line"> <span class="string">&#x27;scheduler/enqueued/memory&#x27;</span>: 23,</span><br><span class="line"> <span class="string">&#x27;start_time&#x27;</span>: datetime.datetime(2023, 1, 6, 1, 43, 46, 271519)&#125;</span><br></pre></td></tr></table></figure>

<h4 id="add-splash-for-address-and-descript"><a href="#add-splash-for-address-and-descript" class="headerlink" title="add splash for address and descript"></a>add splash for address and descript</h4><h5 id="settings-py"><a href="#settings-py" class="headerlink" title="settings.py"></a>settings.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable or disable spider middlewares</span></span><br><span class="line"><span class="comment"># See https://docs.scrapy.org/en/latest/topics/spider-middleware.html</span></span><br><span class="line"><span class="comment">#SPIDER_MIDDLEWARES = &#123;</span></span><br><span class="line"><span class="comment">#    &#x27;centris.middlewares.CentrisSpiderMiddleware&#x27;: 543,</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line">SPIDER_MIDDLEWARES = &#123;</span><br><span class="line">    <span class="string">&#x27;scrapy_splash.SplashDeduplicateArgsMiddleware&#x27;</span>: <span class="number">100</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable or disable downloader middlewares</span></span><br><span class="line"><span class="comment"># See https://docs.scrapy.org/en/latest/topics/downloader-middleware.html</span></span><br><span class="line"><span class="comment">#DOWNLOADER_MIDDLEWARES = &#123;</span></span><br><span class="line"><span class="comment">#    &#x27;centris.middlewares.CentrisDownloaderMiddleware&#x27;: 543,</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line">    <span class="string">&#x27;scrapy_splash.SplashCookiesMiddleware&#x27;</span>: <span class="number">723</span>,</span><br><span class="line">    <span class="string">&#x27;scrapy_splash.SplashMiddleware&#x27;</span>: <span class="number">725</span>,</span><br><span class="line">    <span class="string">&#x27;scrapy.downloadermiddlewares.httpcompression.HttpCompressionMiddleware&#x27;</span>: <span class="number">810</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DUPEFILTER_CLASS = <span class="string">&#x27;scrapy_splash.SplashAwareDupeFilter&#x27;</span></span><br><span class="line"></span><br><span class="line">SPLASH_URL = <span class="string">&#x27;http://localhost:8050/&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="listing-py-2"><a href="#listing-py-2" class="headerlink" title="listing.py"></a>listing.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.selector <span class="keyword">import</span> Selector</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="comment"># add splash</span></span><br><span class="line"><span class="keyword">from</span> scrapy_splash <span class="keyword">import</span> SplashRequest</span><br><span class="line"><span class="comment"># add for splash user+password(run Aquarium)</span></span><br><span class="line"><span class="comment"># from w3lib.http import basic_auth_header</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListingSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;listing&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;www.centris.ca&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    position = &#123;</span><br><span class="line">        <span class="string">&quot;startPosition&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># add splash</span></span><br><span class="line">    <span class="comment"># script = &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">#     function main(splash, args)</span></span><br><span class="line">    <span class="comment">#         assert(splash:go(args.url))</span></span><br><span class="line">    <span class="comment">#         assert(splash:wait(0.5))</span></span><br><span class="line">    <span class="comment">#         return splash:html()</span></span><br><span class="line">    <span class="comment">#     end</span></span><br><span class="line">    <span class="comment"># &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># add splash - add some condition</span></span><br><span class="line">    script = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        function main(splash, args)</span></span><br><span class="line"><span class="string">            splash:on_request(function(request)</span></span><br><span class="line"><span class="string">                if request.url:find(&#x27;css&#x27;) then</span></span><br><span class="line"><span class="string">                    request.abort()</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">            end)</span></span><br><span class="line"><span class="string">            splash.images_enabled = false</span></span><br><span class="line"><span class="string">            splash.js_enabled = false</span></span><br><span class="line"><span class="string">            assert(splash:go(args.url))</span></span><br><span class="line"><span class="string">            assert(splash:wait(0.5))</span></span><br><span class="line"><span class="string">            return splash:html()</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        query = &#123;</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;UseGeographyShapes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;Filters&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;MatchType&quot;</span>: <span class="string">&quot;CityDistrictAll&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Text&quot;</span>: <span class="string">&quot;Montréal (All boroughs)&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Id&quot;</span>: <span class="number">5</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;FieldsValues&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;CityDistrictAll&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">5</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;Category&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;Residential&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;SellingType&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;Rent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;LandArea&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;SquareFeet&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;IsLandArea&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;RentPrice&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;ForRent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;RentPrice&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">1500</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;ForRent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;isHomePage&quot;</span>: <span class="literal">True</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url=<span class="string">&quot;https://www.centris.ca/property/UpdateQuery&quot;</span>,</span><br><span class="line">            method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">            body=json.dumps(query),</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json; charset=utf-8&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            callback=self.update_query</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_query</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url=<span class="string">&quot;https://www.centris.ca/Property/GetInscriptions&quot;</span>,</span><br><span class="line">            method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">            body=json.dumps(self.position),</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json; charset=utf-8&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            callback=self.parse</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        resp_dict = json.loads(response.body)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># resp_dict[&#x27;d&#x27;][&#x27;Result&#x27;][&#x27;html&#x27;] - same as below</span></span><br><span class="line">        html = resp_dict.get(<span class="string">&#x27;d&#x27;</span>).get(<span class="string">&#x27;Result&#x27;</span>).get(<span class="string">&#x27;html&#x27;</span>)</span><br><span class="line">        sel = Selector(text=html)</span><br><span class="line">        listings = sel.xpath(<span class="string">&quot;//div[@class=&#x27;shell&#x27;]&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;------------&gt; index <span class="subst">&#123;self.position[<span class="string">&#x27;startPosition&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> listing <span class="keyword">in</span> listings:</span><br><span class="line">            category = listing.xpath(<span class="string">&quot;normalize-space(.//span[@class=&#x27;category&#x27;]/div/text())&quot;</span>).get()</span><br><span class="line">            <span class="comment"># some room not include bed</span></span><br><span class="line">            bedrooms = listing.xpath(<span class="string">&quot;.//div[@class=&#x27;cac&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            bathrooms =  listing.xpath(<span class="string">&quot;.//div[@class=&#x27;sdb&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            <span class="keyword">if</span> bedrooms:</span><br><span class="line">                features = <span class="string">f&quot;<span class="subst">&#123;bedrooms&#125;</span> Bed, <span class="subst">&#123;bathrooms&#125;</span> Bath&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                features = <span class="string">f&quot;<span class="subst">&#123;bathrooms&#125;</span> Bath&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># remove character &quot;,&quot; space and $</span></span><br><span class="line">            price_str =  listing.xpath(<span class="string">&quot;.//div[@class=&#x27;price&#x27;]/span/text()&quot;</span>).get()</span><br><span class="line">            price = price_str[-<span class="number">1</span>] + <span class="string">&quot; &quot;</span> + re.sub(<span class="string">&quot;[^0-9]&quot;</span>, <span class="string">&quot;&quot;</span>,  price_str)</span><br><span class="line">            city = listing.xpath(<span class="string">&quot;(.//span[@class=&#x27;address&#x27;]/div)[2]/text()&quot;</span>).get()</span><br><span class="line">            url = listing.xpath(<span class="string">&quot;.//a[@class=&#x27;property-thumbnail-summary-link&#x27;]/@href&quot;</span>).get()</span><br><span class="line">            abs_url = response.urljoin(url)</span><br><span class="line"></span><br><span class="line">            self.index += <span class="number">1</span></span><br><span class="line">            <span class="comment"># yield &#123;</span></span><br><span class="line">            <span class="comment">#     &#x27;index&#x27;: self.index,</span></span><br><span class="line">            <span class="comment">#     &#x27;category&#x27;: category,</span></span><br><span class="line">            <span class="comment">#     &#x27;features&#x27;: features,</span></span><br><span class="line">            <span class="comment">#     &#x27;price&#x27;: price,</span></span><br><span class="line">            <span class="comment">#     &#x27;city&#x27;: city,</span></span><br><span class="line">            <span class="comment">#     &#x27;url&#x27;: response.urljoin(url)</span></span><br><span class="line">            <span class="comment"># &#125;</span></span><br><span class="line">            <span class="keyword">yield</span> SplashRequest(</span><br><span class="line">                url= abs_url,</span><br><span class="line">                endpoint=<span class="string">&#x27;execute&#x27;</span>,</span><br><span class="line">                callback= self.parse_summary,</span><br><span class="line">                args = &#123;</span><br><span class="line">                    <span class="string">&#x27;lua_source&#x27;</span>: self.script</span><br><span class="line">                &#125;,</span><br><span class="line">                meta = &#123;</span><br><span class="line">                    <span class="string">&#x27;cat&#x27;</span>: category,</span><br><span class="line">                    <span class="string">&#x27;fea&#x27;</span>: features,</span><br><span class="line">                    <span class="string">&#x27;pri&#x27;</span>: price,</span><br><span class="line">                    <span class="string">&#x27;city&#x27;</span>: city,</span><br><span class="line">                    <span class="string">&#x27;url&#x27;</span>: abs_url</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment"># add for splash user+password(run Aquarium)</span></span><br><span class="line">                <span class="comment"># splash_headers=&#123;</span></span><br><span class="line">                <span class="comment">#     &#x27;Authorization&#x27;: basic_auth_header(&#x27;user&#x27;, &#x27;userpass&#x27;)</span></span><br><span class="line">                <span class="comment"># &#125;</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        count = resp_dict.get(<span class="string">&#x27;d&#x27;</span>).get(<span class="string">&#x27;Result&#x27;</span>).get(<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">        increment_number = resp_dict.get(<span class="string">&#x27;d&#x27;</span>).get(<span class="string">&#x27;Result&#x27;</span>).get(<span class="string">&#x27;inscNumberPerPage&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.position[<span class="string">&#x27;startPosition&#x27;</span>]+increment_number &lt;  count:</span><br><span class="line">            self.position[<span class="string">&#x27;startPosition&#x27;</span>] += increment_number</span><br><span class="line"></span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">                url=<span class="string">&quot;https://www.centris.ca/Property/GetInscriptions&quot;</span>,</span><br><span class="line">                method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">                body=json.dumps(self.position),</span><br><span class="line">                headers=&#123;</span><br><span class="line">                    <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json; charset=utf-8&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                callback=self.parse</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_summary</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        address = response.xpath(<span class="string">&quot;//h2[@itemprop=&#x27;address&#x27;]/text()&quot;</span>).get()</span><br><span class="line">        description = response.xpath(<span class="string">&quot;normalize-space(//div[@itemprop=&#x27;description&#x27;]/text())&quot;</span>).get()</span><br><span class="line">        category = response.request.meta[<span class="string">&#x27;cat&#x27;</span>]</span><br><span class="line">        features = response.request.meta[<span class="string">&#x27;fea&#x27;</span>]</span><br><span class="line">        price = response.request.meta[<span class="string">&#x27;pri&#x27;</span>]</span><br><span class="line">        city = response.request.meta[<span class="string">&#x27;city&#x27;</span>]</span><br><span class="line">        url = response.request.meta[<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">&#x27;address&#x27;</span>: address,</span><br><span class="line">            <span class="string">&#x27;description&#x27;</span>: description,</span><br><span class="line">            <span class="string">&#x27;category&#x27;</span>: category,</span><br><span class="line">            <span class="string">&#x27;features&#x27;</span>: features,</span><br><span class="line">            <span class="string">&#x27;price&#x27;</span>: price,</span><br><span class="line">            <span class="string">&#x27;city&#x27;</span>: city,</span><br><span class="line">            <span class="string">&#x27;url&#x27;</span>: url</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h5 id="run-2"><a href="#run-2" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\centris&gt;scrapy crawl listing</span><br><span class="line">.....</span><br><span class="line">2023-01-06 14:44:18 [scrapy.core.engine] DEBUG: Crawled (403) &lt;GET https://www.centris.ca/robots.txt&gt; (referer: None)</span><br><span class="line">......</span><br><span class="line"><span class="comment"># 1st item</span></span><br><span class="line">&#123;	<span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;6760, boulevard Newman, app. 806, Montreal (LaSalle)&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;description&#x27;</span>: <span class="string">&#x27;A 5 mins du metro/transport en commun,du parc &amp;Carrefour Angrignon.Unites spacieuses (1-2 CAC)disponibles pour une occupation immediate,finitions luxueuses,comptoirs de cuisine en quartz,hauts plafonds,grandes fenetres de qualite permettant une abondance de lumiere naturelle. Casier incl.Garage dispo&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;Condo / Appartement a louer&#x27;</span>, <span class="string">&#x27;</span></span><br><span class="line"><span class="string">	features&#x27;</span>: <span class="string">&#x27;1 Bed, 1 Bath&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;$ 1385&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;Montreal (LaSalle)&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;https://www.centris.ca/fr/condo-appartement~a-louer~montreal-lasalle/11685745?view=Summary&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">2023-01-06 14:44:32 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://www.centris.ca/fr/condo-appartement~a-louer~montreal-anjou/16844951?view=Summary&gt;</span><br><span class="line">&#123;<span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;6528, Avenue Baldwin, Montreal (Anjou)&#x27;</span>, <span class="string">&#x27;description&#x27;</span>: <span class="string">&quot;Appartement 4 et demi a louer situe dans le secteur d&#x27;Anjou a Montreal Tres bien localise, pres des axes routiers (40- A25 ) , des ecoles et plusieurs autres services. Disponible a partir du 1er Janvier ou fevrier 2023. Les animaux sont acceptes. Une enquete de credit sera effectuee.&quot;</span>, <span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;Condo / Appartement a louer&#x27;</span>, <span class="string">&#x27;features&#x27;</span>: <span class="string">&#x27;2 Bed, 1 Bath&#x27;</span>, <span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;$ 1350&#x27;</span>, <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;Montreal (Anjou)&#x27;</span>, <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;https://www.centris.ca/fr/condo-appartement~a-louer~montreal-anjou/16844951?view=Summary&#x27;</span>&#125;</span><br><span class="line">2023-01-06 14:44:32 [scrapy.core.engine] DEBUG: Crawled (200) &lt;POST https://www.centris.ca/Property/GetInscriptions&gt; (referer: https://www.centris.ca/Property/GetInscriptions)</span><br><span class="line">2023-01-06 14:44:33 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://www.centris.ca/fr/condo-appartement~a-louer~montreal-lasalle/15636601?view=Summary&gt;</span><br><span class="line">......</span><br><span class="line">&#123;<span class="string">&#x27;downloader/request_bytes&#x27;</span>: 617314,</span><br><span class="line"> <span class="string">&#x27;downloader/request_count&#x27;</span>: 450,</span><br><span class="line"> <span class="string">&#x27;downloader/request_method_count/GET&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;downloader/request_method_count/POST&#x27;</span>: 449,</span><br><span class="line"> <span class="string">&#x27;downloader/response_bytes&#x27;</span>: 133403913,</span><br><span class="line"> <span class="string">&#x27;downloader/response_count&#x27;</span>: 450,</span><br><span class="line"> <span class="string">&#x27;downloader/response_status_count/200&#x27;</span>: 449,</span><br><span class="line"> <span class="string">&#x27;downloader/response_status_count/403&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;elapsed_time_seconds&#x27;</span>: 206.48085,</span><br><span class="line"> <span class="string">&#x27;finish_reason&#x27;</span>: <span class="string">&#x27;finished&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;finish_time&#x27;</span>: datetime.datetime(2023, 1, 6, 6, 47, 43, 614184),</span><br><span class="line">  <span class="comment"># item count</span></span><br><span class="line"> <span class="string">&#x27;item_scraped_count&#x27;</span>: 426,</span><br><span class="line"> <span class="string">&#x27;log_count/DEBUG&#x27;</span>: 883,</span><br><span class="line"> <span class="string">&#x27;log_count/INFO&#x27;</span>: 13,</span><br><span class="line"> <span class="string">&#x27;log_count/WARNING&#x27;</span>: 3,</span><br><span class="line"> <span class="string">&#x27;request_depth_max&#x27;</span>: 23,</span><br><span class="line"> <span class="string">&#x27;response_received_count&#x27;</span>: 450,</span><br><span class="line"> <span class="string">&#x27;robotstxt/request_count&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;robotstxt/response_count&#x27;</span>: 1,</span><br><span class="line"> <span class="comment"># robots.txt</span></span><br><span class="line"> <span class="string">&#x27;robotstxt/response_status_count/403&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;scheduler/dequeued&#x27;</span>: 875,</span><br><span class="line"> <span class="string">&#x27;scheduler/dequeued/memory&#x27;</span>: 875,</span><br><span class="line"> <span class="string">&#x27;scheduler/enqueued&#x27;</span>: 875,</span><br><span class="line"> <span class="string">&#x27;scheduler/enqueued/memory&#x27;</span>: 875,</span><br><span class="line"> <span class="string">&#x27;splash/execute/request_count&#x27;</span>: 426,</span><br><span class="line"> <span class="string">&#x27;splash/execute/response_count/200&#x27;</span>: 426,</span><br><span class="line"> <span class="string">&#x27;start_time&#x27;</span>: datetime.datetime(2023, 1, 6, 6, 44, 17, 133334)&#125;</span><br><span class="line">2023-01-06 14:47:43 [scrapy.core.engine] INFO: Spider closed (finished)</span><br></pre></td></tr></table></figure>

<h4 id="run-Aquarium"><a href="#run-Aquarium" class="headerlink" title="run Aquarium"></a>run Aquarium</h4><h5 id="install-Aquarium"><a href="#install-Aquarium" class="headerlink" title="install Aquarium"></a>install Aquarium</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler&gt;pip install cookiecutter</span><br><span class="line"></span><br><span class="line">(myenv10_scrapy) D:\app\python_env\myenv10_scrapy&gt;cookiecutter gh:TeamHG-Memex/aquarium</span><br><span class="line">You<span class="string">&#x27;ve downloaded C:\Users\robertkao\.cookiecutters\aquarium before. Is it okay to delete and re-download it? [yes]: yes</span></span><br><span class="line"><span class="string">folder_name [aquarium]:</span></span><br><span class="line"><span class="string">num_splashes [3]:</span></span><br><span class="line"><span class="string">splash_version [3.0]: latest</span></span><br><span class="line"><span class="string">auth_user [user]:</span></span><br><span class="line"><span class="string">auth_password [userpass]:</span></span><br><span class="line"><span class="string">splash_verbosity [1]:</span></span><br><span class="line"><span class="string">max_timeout [3600]:</span></span><br><span class="line"><span class="string">maxrss_mb [3000]:</span></span><br><span class="line"><span class="string">splash_slots [5]:</span></span><br><span class="line"><span class="string">stats_enabled [1]:</span></span><br><span class="line"><span class="string">stats_auth [admin:adminpass]:</span></span><br><span class="line"><span class="string">tor [1]: 0</span></span><br></pre></td></tr></table></figure>

<h5 id="run-Aquarium-need-stop-all-splash"><a href="#run-Aquarium-need-stop-all-splash" class="headerlink" title="run Aquarium (need stop all splash)"></a>run Aquarium (need stop all splash)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\app\python_env\myenv10_scrapy&gt;<span class="built_in">cd</span> aquarium</span><br><span class="line">(myenv10_scrapy) D:\app\python_env\myenv10_scrapy\aquarium&gt;docker-compose up</span><br></pre></td></tr></table></figure>

<h5 id="2nd-time-run-Aquarium"><a href="#2nd-time-run-Aquarium" class="headerlink" title="2nd time run Aquarium"></a>2nd time run Aquarium</h5><div style="max-width:700px">
    <img src="/2023/01/05/python-14/pic1.png" class="" title="pic1">
</div>

<h5 id="test-by-GUI-splash"><a href="#test-by-GUI-splash" class="headerlink" title="test by GUI(splash)"></a>test by GUI(splash)</h5><p>user:userpass</p>
<div style="max-width:400px">
    <img src="/2023/01/05/python-14/pic2.png" class="" title="pic2">
</div>

<div style="max-width:700px">
    <img src="/2023/01/05/python-14/pic3.png" class="" title="pic3">
</div>

<h5 id="test-by-GUI-General-process-information"><a href="#test-by-GUI-General-process-information" class="headerlink" title="test by GUI(General process information)"></a>test by GUI(General process information)</h5><p>admin:adminpass</p>
<div style="max-width:400px">
    <img src="/2023/01/05/python-14/pic4.png" class="" title="pic4">
</div>

<div style="max-width:700px">
    <img src="/2023/01/05/python-14/pic5.png" class="" title="pic5">
</div>

<h5 id="listing-py-3"><a href="#listing-py-3" class="headerlink" title="listing.py"></a>listing.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.selector <span class="keyword">import</span> Selector</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="comment"># add splash</span></span><br><span class="line"><span class="keyword">from</span> scrapy_splash <span class="keyword">import</span> SplashRequest</span><br><span class="line"><span class="comment"># add for splash user+password(run Aquarium)</span></span><br><span class="line"><span class="keyword">from</span> w3lib.http <span class="keyword">import</span> basic_auth_header</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListingSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;listing&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;www.centris.ca&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    position = &#123;</span><br><span class="line">        <span class="string">&quot;startPosition&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># add splash</span></span><br><span class="line">    <span class="comment"># script = &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment">#     function main(splash, args)</span></span><br><span class="line">    <span class="comment">#         assert(splash:go(args.url))</span></span><br><span class="line">    <span class="comment">#         assert(splash:wait(0.5))</span></span><br><span class="line">    <span class="comment">#         return splash:html()</span></span><br><span class="line">    <span class="comment">#     end</span></span><br><span class="line">    <span class="comment"># &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># add splash - add some condition</span></span><br><span class="line">    script = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        function main(splash, args)</span></span><br><span class="line"><span class="string">            splash:on_request(function(request)</span></span><br><span class="line"><span class="string">                if request.url:find(&#x27;css&#x27;) then</span></span><br><span class="line"><span class="string">                    request.abort()</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">            end)</span></span><br><span class="line"><span class="string">            splash.images_enabled = false</span></span><br><span class="line"><span class="string">            splash.js_enabled = false</span></span><br><span class="line"><span class="string">            assert(splash:go(args.url))</span></span><br><span class="line"><span class="string">            assert(splash:wait(0.5))</span></span><br><span class="line"><span class="string">            return splash:html()</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        query = &#123;</span><br><span class="line">            <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;UseGeographyShapes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;Filters&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;MatchType&quot;</span>: <span class="string">&quot;CityDistrictAll&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Text&quot;</span>: <span class="string">&quot;Montréal (All boroughs)&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Id&quot;</span>: <span class="number">5</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;FieldsValues&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;CityDistrictAll&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">5</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;Category&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;Residential&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;SellingType&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;Rent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;LandArea&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;SquareFeet&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;IsLandArea&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;RentPrice&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;ForRent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;fieldId&quot;</span>: <span class="string">&quot;RentPrice&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: <span class="number">1500</span>,</span><br><span class="line">                        <span class="string">&quot;fieldConditionId&quot;</span>: <span class="string">&quot;ForRent&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;valueConditionId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;isHomePage&quot;</span>: <span class="literal">True</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url=<span class="string">&quot;https://www.centris.ca/property/UpdateQuery&quot;</span>,</span><br><span class="line">            method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">            body=json.dumps(query),</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json; charset=utf-8&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            callback=self.update_query</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_query</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url=<span class="string">&quot;https://www.centris.ca/Property/GetInscriptions&quot;</span>,</span><br><span class="line">            method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">            body=json.dumps(self.position),</span><br><span class="line">            headers=&#123;</span><br><span class="line">                <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json; charset=utf-8&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            callback=self.parse</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        resp_dict = json.loads(response.body)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># resp_dict[&#x27;d&#x27;][&#x27;Result&#x27;][&#x27;html&#x27;] - same as below</span></span><br><span class="line">        html = resp_dict.get(<span class="string">&#x27;d&#x27;</span>).get(<span class="string">&#x27;Result&#x27;</span>).get(<span class="string">&#x27;html&#x27;</span>)</span><br><span class="line">        sel = Selector(text=html)</span><br><span class="line">        listings = sel.xpath(<span class="string">&quot;//div[@class=&#x27;shell&#x27;]&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;------------&gt; index <span class="subst">&#123;self.position[<span class="string">&#x27;startPosition&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> listing <span class="keyword">in</span> listings:</span><br><span class="line">            category = listing.xpath(<span class="string">&quot;normalize-space(.//span[@class=&#x27;category&#x27;]/div/text())&quot;</span>).get()</span><br><span class="line">            <span class="comment"># some room not include bed</span></span><br><span class="line">            bedrooms = listing.xpath(<span class="string">&quot;.//div[@class=&#x27;cac&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            bathrooms =  listing.xpath(<span class="string">&quot;.//div[@class=&#x27;sdb&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            <span class="keyword">if</span> bedrooms:</span><br><span class="line">                features = <span class="string">f&quot;<span class="subst">&#123;bedrooms&#125;</span> Bed, <span class="subst">&#123;bathrooms&#125;</span> Bath&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                features = <span class="string">f&quot;<span class="subst">&#123;bathrooms&#125;</span> Bath&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># remove character &quot;,&quot; space and $</span></span><br><span class="line">            price_str =  listing.xpath(<span class="string">&quot;.//div[@class=&#x27;price&#x27;]/span/text()&quot;</span>).get()</span><br><span class="line">            price = price_str[-<span class="number">1</span>] + <span class="string">&quot; &quot;</span> + re.sub(<span class="string">&quot;[^0-9]&quot;</span>, <span class="string">&quot;&quot;</span>,  price_str)</span><br><span class="line">            city = listing.xpath(<span class="string">&quot;(.//span[@class=&#x27;address&#x27;]/div)[2]/text()&quot;</span>).get()</span><br><span class="line">            url = listing.xpath(<span class="string">&quot;.//a[@class=&#x27;property-thumbnail-summary-link&#x27;]/@href&quot;</span>).get()</span><br><span class="line">            abs_url = response.urljoin(url)</span><br><span class="line"></span><br><span class="line">            self.index += <span class="number">1</span></span><br><span class="line">            <span class="comment"># yield &#123;</span></span><br><span class="line">            <span class="comment">#     &#x27;index&#x27;: self.index,</span></span><br><span class="line">            <span class="comment">#     &#x27;category&#x27;: category,</span></span><br><span class="line">            <span class="comment">#     &#x27;features&#x27;: features,</span></span><br><span class="line">            <span class="comment">#     &#x27;price&#x27;: price,</span></span><br><span class="line">            <span class="comment">#     &#x27;city&#x27;: city,</span></span><br><span class="line">            <span class="comment">#     &#x27;url&#x27;: response.urljoin(url)</span></span><br><span class="line">            <span class="comment"># &#125;</span></span><br><span class="line">            <span class="keyword">yield</span> SplashRequest(</span><br><span class="line">                url= abs_url,</span><br><span class="line">                endpoint=<span class="string">&#x27;execute&#x27;</span>,</span><br><span class="line">                callback= self.parse_summary,</span><br><span class="line">                args = &#123;</span><br><span class="line">                    <span class="string">&#x27;lua_source&#x27;</span>: self.script</span><br><span class="line">                &#125;,</span><br><span class="line">                meta = &#123;</span><br><span class="line">                    <span class="string">&#x27;cat&#x27;</span>: category,</span><br><span class="line">                    <span class="string">&#x27;fea&#x27;</span>: features,</span><br><span class="line">                    <span class="string">&#x27;pri&#x27;</span>: price,</span><br><span class="line">                    <span class="string">&#x27;city&#x27;</span>: city,</span><br><span class="line">                    <span class="string">&#x27;url&#x27;</span>: abs_url</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment"># add for splash user+password(run Aquarium)</span></span><br><span class="line">                splash_headers=&#123;</span><br><span class="line">                    <span class="string">&#x27;Authorization&#x27;</span>: basic_auth_header(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;userpass&#x27;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        count = resp_dict.get(<span class="string">&#x27;d&#x27;</span>).get(<span class="string">&#x27;Result&#x27;</span>).get(<span class="string">&#x27;count&#x27;</span>)</span><br><span class="line">        increment_number = resp_dict.get(<span class="string">&#x27;d&#x27;</span>).get(<span class="string">&#x27;Result&#x27;</span>).get(<span class="string">&#x27;inscNumberPerPage&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.position[<span class="string">&#x27;startPosition&#x27;</span>]+increment_number &lt;  count:</span><br><span class="line">            self.position[<span class="string">&#x27;startPosition&#x27;</span>] += increment_number</span><br><span class="line"></span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">                url=<span class="string">&quot;https://www.centris.ca/Property/GetInscriptions&quot;</span>,</span><br><span class="line">                method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">                body=json.dumps(self.position),</span><br><span class="line">                headers=&#123;</span><br><span class="line">                    <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json; charset=utf-8&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                callback=self.parse</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_summary</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        address = response.xpath(<span class="string">&quot;//h2[@itemprop=&#x27;address&#x27;]/text()&quot;</span>).get()</span><br><span class="line">        description = response.xpath(<span class="string">&quot;normalize-space(//div[@itemprop=&#x27;description&#x27;]/text())&quot;</span>).get()</span><br><span class="line">        category = response.request.meta[<span class="string">&#x27;cat&#x27;</span>]</span><br><span class="line">        features = response.request.meta[<span class="string">&#x27;fea&#x27;</span>]</span><br><span class="line">        price = response.request.meta[<span class="string">&#x27;pri&#x27;</span>]</span><br><span class="line">        city = response.request.meta[<span class="string">&#x27;city&#x27;</span>]</span><br><span class="line">        url = response.request.meta[<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">        <span class="keyword">yield</span> &#123;</span><br><span class="line">            <span class="string">&#x27;address&#x27;</span>: address,</span><br><span class="line">            <span class="string">&#x27;description&#x27;</span>: description,</span><br><span class="line">            <span class="string">&#x27;category&#x27;</span>: category,</span><br><span class="line">            <span class="string">&#x27;features&#x27;</span>: features,</span><br><span class="line">            <span class="string">&#x27;price&#x27;</span>: price,</span><br><span class="line">            <span class="string">&#x27;city&#x27;</span>: city,</span><br><span class="line">            <span class="string">&#x27;url&#x27;</span>: url</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h5 id="run-3"><a href="#run-3" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\centris&gt;scrapy crawl listing</span><br><span class="line">......</span><br><span class="line">2023-01-06 16:48:12 [scrapy.core.engine] DEBUG: Crawled (403) &lt;GET https://www.centris.ca/robots.txt&gt; (referer: None)</span><br><span class="line">......</span><br><span class="line"><span class="comment"># 1st item</span></span><br><span class="line">&#123;	<span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;1406, Rue Sainte-Élisabeth, app. 405, Montréal (Ville-Marie), Quartier Centre&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;description&#x27;</span>: <span class="string">&quot;ELI CONDOS - Centre-ville, nouveau condo/studio près de Quartier des Spectacles et à quelques pas des stations de métro Berri-UQAM, Saint Laurent et Place des Arts. À côté de l&#x27;hôpital CHUM et université UQAM. Vieux-Port et quartier chinois à distance de marche. Studio aire ouverte avec un nouveau lit escamotable, sofa, finition moderne, grandes fenêtres, lumineux. À proximité de tous les services, universités, transports en commun, restaurants, bars, magasins et etc.&quot;</span>, </span><br><span class="line">	<span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;Condo à louer&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;features&#x27;</span>: <span class="string">&#x27;1 Bed, 1 Bath&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;$ 1450&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;Montréal (Ville-Marie)&#x27;</span>, </span><br><span class="line">	<span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;https://www.centris.ca/fr/condo~a-vendre~montreal-ville-marie/21291499?view=Summary&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">2023-01-06 16:48:15 [scrapy.core.engine] DEBUG: Crawled (200) &lt;GET https://www.centris.ca/fr/condo-appartement~a-louer~montreal-ville-marie/16592244?view=Summary via http://localhost:8050/execute&gt; (referer: None)</span><br><span class="line">2023-01-06 16:48:16 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://www.centris.ca/fr/loft-studio~a-louer~montreal-montreal-nord/24620310?view=Summary&gt;</span><br><span class="line">&#123;<span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;3311, boulevard Gouin Est, app. C, Montréal (Montréal-Nord)&#x27;</span>, <span class="string">&#x27;description&#x27;</span>: <span class="string">&quot;RÉSIDENCE DESTINÉE AUX 55 ANS ET +. Appartement 4 1/2 confortable et sécuritaire. Chauffage, électricité, câble, téléphone, poêle, frigo compris dans le prix du loyer. Les Résidences du Confort sont situées le long de la Rivière-des-Prairies à Montréal-Nord. Nombreux services offerts et activités variées et divertissantes. Vous pouvez profiter de votre mode de vie autonome ou bénéficier d&#x27;une assistance en plus d&#x27;être en sécurité 24/24. Éligible au crédit d&#x27;impôt pour maintien à domicile. Plusieurs modèles d&#x27;unités disponibles. VISITE sur rendez-vous avec moi du lundi au vendredi de 9h à 17h. Contactez- moi.&quot;</span>, <span class="string">&#x27;category&#x27;</span>: <span class="string">&#x27;Loft / Studio à louer&#x27;</span>, <span class="string">&#x27;features&#x27;</span>: <span class="string">&#x27;2 Bed, 1 Bath&#x27;</span>, <span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;$ 1401&#x27;</span>, <span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;Montréal (Montréal-Nord)&#x27;</span>, <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;https://www.centris.ca/fr/loft-studio~a-louer~montreal-montreal-nord/24620310?view=Summary&#x27;</span>&#125;</span><br><span class="line">......</span><br><span class="line">&#123;<span class="string">&#x27;downloader/request_bytes&#x27;</span>: 634600,</span><br><span class="line"> <span class="string">&#x27;downloader/request_count&#x27;</span>: 450,</span><br><span class="line"> <span class="string">&#x27;downloader/request_method_count/GET&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;downloader/request_method_count/POST&#x27;</span>: 449,</span><br><span class="line"> <span class="string">&#x27;downloader/response_bytes&#x27;</span>: 23763564,</span><br><span class="line"> <span class="string">&#x27;downloader/response_count&#x27;</span>: 450,</span><br><span class="line"> <span class="string">&#x27;downloader/response_status_count/200&#x27;</span>: 449,</span><br><span class="line"> <span class="string">&#x27;downloader/response_status_count/403&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;elapsed_time_seconds&#x27;</span>: 266.406545,</span><br><span class="line"> <span class="string">&#x27;finish_reason&#x27;</span>: <span class="string">&#x27;finished&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;finish_time&#x27;</span>: datetime.datetime(2023, 1, 6, 8, 52, 38, 10140),</span><br><span class="line"> <span class="string">&#x27;httpcompression/response_bytes&#x27;</span>: 131658461,</span><br><span class="line"> <span class="string">&#x27;httpcompression/response_count&#x27;</span>: 426,</span><br><span class="line"> <span class="comment"># item</span></span><br><span class="line"> <span class="string">&#x27;item_scraped_count&#x27;</span>: 426,</span><br><span class="line"> <span class="string">&#x27;log_count/DEBUG&#x27;</span>: 883,</span><br><span class="line"> <span class="string">&#x27;log_count/INFO&#x27;</span>: 14,</span><br><span class="line"> <span class="string">&#x27;log_count/WARNING&#x27;</span>: 2,</span><br><span class="line"> <span class="string">&#x27;request_depth_max&#x27;</span>: 23,</span><br><span class="line"> <span class="string">&#x27;response_received_count&#x27;</span>: 450,</span><br><span class="line"> <span class="string">&#x27;robotstxt/request_count&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;robotstxt/response_count&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;robotstxt/response_status_count/403&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;scheduler/dequeued&#x27;</span>: 875,</span><br><span class="line"> <span class="string">&#x27;scheduler/dequeued/memory&#x27;</span>: 875,</span><br><span class="line"> <span class="string">&#x27;scheduler/enqueued&#x27;</span>: 875,</span><br><span class="line"> <span class="string">&#x27;scheduler/enqueued/memory&#x27;</span>: 875,</span><br><span class="line"> <span class="string">&#x27;splash/execute/request_count&#x27;</span>: 426,</span><br><span class="line"> <span class="string">&#x27;splash/execute/response_count/200&#x27;</span>: 426,</span><br><span class="line"> <span class="string">&#x27;start_time&#x27;</span>: datetime.datetime(2023, 1, 6, 8, 48, 11, 603595)&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Steam-Store"><a href="#Steam-Store" class="headerlink" title="Steam Store"></a><a target="_blank" rel="noopener" href="https://store.steampowered.com/search/?filter=topsellers">Steam Store</a></h3><h4 id="get-best-selling-games"><a href="#get-best-selling-games" class="headerlink" title="get best selling games"></a>get best selling games</h4><h5 id="create-project-and-spider-1"><a href="#create-project-and-spider-1" class="headerlink" title="create project and spider"></a>create project and spider</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">myenv10_scrapy) D:\work\git\python_crawler\108-scrapy-practice&gt;scrapy startproject steam</span><br><span class="line">New Scrapy project <span class="string">&#x27;steam&#x27;</span>, using template directory <span class="string">&#x27;D:\app\python_env\myenv10_scrapy\lib\site-packages\scrapy\templates\project&#x27;</span>, created <span class="keyword">in</span>:</span><br><span class="line">    D:\work\git\python_crawler\108-scrapy-practice\steam</span><br><span class="line">You can start your first spider with:</span><br><span class="line">    <span class="built_in">cd</span> steam</span><br><span class="line">    scrapy genspider example example.com</span><br><span class="line"></span><br><span class="line">(myenv10_scrapy) D:\work\git\python_crawler\108-scrapy-practice&gt;<span class="built_in">cd</span> steam</span><br><span class="line">(myenv10_scrapy) D:\work\git\python_crawler\108-scrapy-practice\steam&gt;scrapy genspider best_selling https://store.steampowered.com/search/?filter=topsellers</span><br><span class="line">Created spider <span class="string">&#x27;best_selling&#x27;</span> using template <span class="string">&#x27;basic&#x27;</span> <span class="keyword">in</span> module:</span><br><span class="line">  steam.spiders.best_selling</span><br></pre></td></tr></table></figure>

<h5 id="scrapy-shell-test"><a href="#scrapy-shell-test" class="headerlink" title="scrapy shell test"></a>scrapy shell test</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\steam&gt;scrapy shell https://store.steampowered.com/search/?filter=topsellers</span><br><span class="line">......</span><br><span class="line">In [1]: games = response.xpath(<span class="string">&quot;//div[@id=&#x27;search_resultsRows&#x27;]/a&quot;</span>)</span><br><span class="line">In [2]: games</span><br><span class="line">Out[2]:</span><br><span class="line">[&lt;Selector xpath=<span class="string">&quot;//div[@id=&#x27;search_resultsRows&#x27;]/a&quot;</span> data=<span class="string">&#x27;&lt;a href=&quot;https://store.steampowered.c...&#x27;</span>&gt;,</span><br><span class="line">......</span><br><span class="line"> &lt;Selector xpath=<span class="string">&quot;//div[@id=&#x27;search_resultsRows&#x27;]/a&quot;</span> data=<span class="string">&#x27;&lt;a href=&quot;https://store.steampowered.c...&#x27;</span>&gt;,</span><br><span class="line"> &lt;Selector xpath=<span class="string">&quot;//div[@id=&#x27;search_resultsRows&#x27;]/a&quot;</span> data=<span class="string">&#x27;&lt;a href=&quot;https://store.steampowered.c...&#x27;</span>&gt;,</span><br><span class="line"> &lt;Selector xpath=<span class="string">&quot;//div[@id=&#x27;search_resultsRows&#x27;]/a&quot;</span> data=<span class="string">&#x27;&lt;a href=&quot;https://store.steampowered.c...&#x27;</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [3]: <span class="keyword">for</span> game <span class="keyword">in</span> games:</span><br><span class="line">   ...:     url = game.xpath(<span class="string">&quot;.//@href&quot;</span>).get()</span><br><span class="line">   ...:     <span class="built_in">print</span>(url)</span><br><span class="line">   ...:</span><br><span class="line">https://store.steampowered.com/app/1172470/Apex_Legends/?snr=1_7_7_7000_150_1</span><br><span class="line">https://store.steampowered.com/app/730/CounterStrike_Global_Offensive/?snr=1_7_7_7000_150_1</span><br><span class="line">https://store.steampowered.com/app/1938090/Call_of_Duty_Modern_Warfare_II/?snr=1_7_7_7000_150_1</span><br><span class="line">https://store.steampowered.com/app/230410/Warframe/?snr=1_7_7_7000_150_1</span><br><span class="line">......</span><br><span class="line">https://store.steampowered.com/app/1049590/Eternal_Return/?snr=1_7_7_7000_150_1</span><br><span class="line">https://store.steampowered.com/app/1599660/Sackboy_A_Big_Adventure/?snr=1_7_7_7000_150_1</span><br><span class="line">https://store.steampowered.com/app/1680880/Forspoken/?snr=1_7_7_7000_150_1</span><br><span class="line"></span><br><span class="line">In [5]: games[5].xpath(<span class="string">&quot;.//div[@class=&#x27;col search_capsule&#x27;]/img/@src&quot;</span>).get()</span><br><span class="line">Out[5]: <span class="string">&#x27;https://cdn.cloudflare.steamstatic.com/steam/apps/1377580/capsule_sm_120.jpg?t=1672884608&#x27;</span></span><br><span class="line"></span><br><span class="line">In [8]: games[5].xpath(<span class="string">&quot;.//div[@class=&#x27;col search_released responsive_secondrow&#x27;]/text()&quot;</span>).get()</span><br><span class="line">Out[8]: <span class="string">&#x27;12 May, 2021&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="experiment-py-for-test"><a href="#experiment-py-for-test" class="headerlink" title="experiment.py - for test"></a>experiment.py - for test</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">classes = [</span><br><span class="line">    <span class="string">&#x27;platform_img win&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;platform_img mac&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;platform_img linux&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vr_supported&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_platforms</span>(<span class="params">list_classes</span>):</span></span><br><span class="line">    platforms = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> list_classes:</span><br><span class="line">        platform = item.split(<span class="string">&#x27; &#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> platform == <span class="string">&#x27;win&#x27;</span>:</span><br><span class="line">            platforms.append(<span class="string">&#x27;Windows&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> platform == <span class="string">&#x27;mac&#x27;</span>:</span><br><span class="line">            platforms.append(<span class="string">&#x27;Mac os&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> platform == <span class="string">&#x27;linux&#x27;</span>:</span><br><span class="line">            platforms.append(<span class="string">&#x27;Linux&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> platform == <span class="string">&#x27;vr_supported&#x27;</span>:</span><br><span class="line">            platforms.append(<span class="string">&#x27;VR supported&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> platforms</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(get_platforms(classes))</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS D:\work\run\python_crawler\108-scrapy-practice\steam\steam&gt; python .\experiment.py</span><br><span class="line">[<span class="string">&#x27;Windows&#x27;</span>, <span class="string">&#x27;Mac os&#x27;</span>, <span class="string">&#x27;Linux&#x27;</span>, <span class="string">&#x27;VR supported&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h5 id="items-py"><a href="#items-py" class="headerlink" title="items.py"></a>items.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define here the models for your scraped items</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See documentation in:</span></span><br><span class="line"><span class="comment"># https://docs.scrapy.org/en/latest/topics/items.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SteamItem</span>(<span class="params">scrapy.Item</span>):</span></span><br><span class="line">    game_url = scrapy.Field()</span><br><span class="line">    img_url = scrapy.Field()</span><br><span class="line">    game_name = scrapy.Field()</span><br><span class="line">    release_date = scrapy.Field()</span><br><span class="line">    platforms = scrapy.Field()</span><br><span class="line">    reviews_summary = scrapy.Field()</span><br><span class="line">    original_price = scrapy.Field()</span><br><span class="line">    discounted_price = scrapy.Field()</span><br><span class="line">    discount_rate = scrapy.Field()</span><br></pre></td></tr></table></figure>

<h5 id="best-selling-py"><a href="#best-selling-py" class="headerlink" title="best_selling.py"></a>best_selling.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> ..items <span class="keyword">import</span> SteamItem</span><br><span class="line"><span class="keyword">from</span> w3lib.html <span class="keyword">import</span> remove_tags</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BestSellingSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;best_selling&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;store.steampowered.com&#x27;</span>]</span><br><span class="line">    start_urls = [<span class="string">&#x27;https://store.steampowered.com/search/?filter=topsellers&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_platforms</span>(<span class="params">self, list_classes</span>):</span></span><br><span class="line">        platforms = []</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> list_classes:</span><br><span class="line">            platform = item.split(<span class="string">&#x27; &#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;win&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;Windows&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;mac&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;Mac os&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;linux&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;Linux&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;vr_supported&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;VR supported&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> platforms</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove_html</span>(<span class="params">self, review_summary</span>):</span></span><br><span class="line">        cleaned_review_summary = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cleaned_review_summary = remove_tags(review_summary)</span><br><span class="line">        <span class="keyword">except</span> TypeError:</span><br><span class="line">            cleaned_review_summary = <span class="string">&#x27;No reviews&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> cleaned_review_summary</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_discount_rate</span>(<span class="params">self, discount_rate</span>):</span></span><br><span class="line">        <span class="keyword">if</span> discount_rate:</span><br><span class="line">            <span class="keyword">return</span> discount_rate.lstrip(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> discount_rate</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_original_price</span>(<span class="params">self, selector_obj</span>):</span></span><br><span class="line">        original_price = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        div_with_discount = selector_obj.xpath(<span class="string">&quot;.//div[contains(@class, &#x27;discounted&#x27;)]&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> div_with_discount:</span><br><span class="line">            original_price = selector_obj.xpath(<span class="string">&quot;.//span/strike/text()&quot;</span>).get()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            original_price = selector_obj.xpath(<span class="string">&quot;normalize-space(.//div[contains(@class, &#x27;search_price&#x27;)]/text())&quot;</span>).get()</span><br><span class="line">        <span class="keyword">return</span> original_price</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_discounted_price</span>(<span class="params">self, discounted_price</span>):</span></span><br><span class="line">        <span class="keyword">if</span> discounted_price:</span><br><span class="line">            <span class="keyword">return</span> discounted_price.strip()</span><br><span class="line">        <span class="keyword">return</span> discounted_price</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        steam_item = SteamItem()</span><br><span class="line">        games = response.xpath(<span class="string">&quot;//div[@id=&#x27;search_resultsRows&#x27;]/a&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> game <span class="keyword">in</span> games:</span><br><span class="line">            steam_item[<span class="string">&#x27;game_url&#x27;</span>] = game.xpath(<span class="string">&quot;.//@href&quot;</span>).get()</span><br><span class="line">            steam_item[<span class="string">&#x27;img_url&#x27;</span>] = game.xpath(<span class="string">&quot;.//div[@class=&#x27;col search_capsule&#x27;]/img/@src&quot;</span>).get()</span><br><span class="line">            steam_item[<span class="string">&#x27;game_name&#x27;</span>] = game.xpath(<span class="string">&quot;.//span[@class=&#x27;title&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            steam_item[<span class="string">&#x27;release_date&#x27;</span>] = game.xpath(<span class="string">&quot;.//div[@class=&#x27;col search_released responsive_secondrow&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            steam_item[<span class="string">&#x27;platforms&#x27;</span>] = self.get_platforms(game.xpath(<span class="string">&quot;.//span[contains(@class,&#x27;platform_img&#x27;) or @class=&#x27;VR Supported&#x27;]/@class&quot;</span>).getall())</span><br><span class="line">            steam_item[<span class="string">&#x27;reviews_summary&#x27;</span>] = self.remove_html(game.xpath(<span class="string">&quot;.//span[contains(@class,&#x27;search_review_summary&#x27;)]/@data-tooltip-html&quot;</span>).get())</span><br><span class="line">            steam_item[<span class="string">&#x27;discount_rate&#x27;</span>] = self.clean_discount_rate(game.xpath(<span class="string">&quot;.//div[contains(@class,&#x27;search_discount&#x27;)]/span/text()&quot;</span>).get())</span><br><span class="line">            steam_item[<span class="string">&#x27;original_price&#x27;</span>] = self.get_original_price(game.xpath(<span class="string">&quot;.//div[contains(@class,&#x27;search_price_discount_combined&#x27;)]&quot;</span>))</span><br><span class="line">            steam_item[<span class="string">&#x27;discounted_price&#x27;</span>] = self.clean_discounted_price(game.xpath(<span class="string">&quot;(.//div[contains(@class, &#x27;search_price discounted&#x27;)]/text())[2]&quot;</span>).get())</span><br><span class="line">            <span class="keyword">yield</span> steam_item</span><br></pre></td></tr></table></figure>

<h5 id="run-4"><a href="#run-4" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\steam&gt;scrapy crawl best_selling</span><br><span class="line">......</span><br><span class="line">&#123;<span class="string">&#x27;discount_rate&#x27;</span>: None,</span><br><span class="line"> <span class="string">&#x27;discounted_price&#x27;</span>: None,</span><br><span class="line"> <span class="string">&#x27;game_name&#x27;</span>: <span class="string">&#x27;Apex Legends™&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;game_url&#x27;</span>: <span class="string">&#x27;https://store.steampowered.com/app/1172470/Apex_Legends/?snr=1_7_7_7000_150_1&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;img_url&#x27;</span>: <span class="string">&#x27;https://cdn.cloudflare.steamstatic.com/steam/apps/1172470/capsule_sm_120.jpg?t=1670431796&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;original_price&#x27;</span>: <span class="string">&#x27;Free to Play&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;platforms&#x27;</span>: [<span class="string">&#x27;Windows&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;release_date&#x27;</span>: <span class="string">&#x27;4 Nov, 2020&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;reviews_summary&#x27;</span>: <span class="string">&#x27;Very Positive84% of the 565,774 user reviews for this &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;game are positive.&#x27;</span>&#125;</span><br><span class="line">2023-01-09 14:47:15 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://store.steampowered.com/search/?filter=topsellers&gt;</span><br><span class="line">&#123;<span class="string">&#x27;discount_rate&#x27;</span>: None,</span><br><span class="line"> <span class="string">&#x27;discounted_price&#x27;</span>: None,</span><br><span class="line"> <span class="string">&#x27;game_name&#x27;</span>: <span class="string">&#x27;Counter-Strike: Global Offensive&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;game_url&#x27;</span>: <span class="string">&#x27;https://store.steampowered.com/app/730/CounterStrike_Global_Offensive/?snr=1_7_7_7000_150_1&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;img_url&#x27;</span>: <span class="string">&#x27;https://cdn.cloudflare.steamstatic.com/steam/apps/730/capsule_sm_120.jpg?t=1668125812&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;original_price&#x27;</span>: <span class="string">&#x27;Free to Play&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;platforms&#x27;</span>: [<span class="string">&#x27;Windows&#x27;</span>, <span class="string">&#x27;Mac os&#x27;</span>, <span class="string">&#x27;Linux&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;release_date&#x27;</span>: <span class="string">&#x27;21 Aug, 2012&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;reviews_summary&#x27;</span>: <span class="string">&#x27;Very Positive88% of the 6,853,032 user reviews for this &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;game are positive.&#x27;</span>&#125;</span><br><span class="line">......</span><br><span class="line">&#123;<span class="string">&#x27;downloader/request_bytes&#x27;</span>: 479,</span><br><span class="line"> <span class="string">&#x27;downloader/request_count&#x27;</span>: 2,</span><br><span class="line"> <span class="string">&#x27;downloader/request_method_count/GET&#x27;</span>: 2,</span><br><span class="line"> <span class="string">&#x27;downloader/response_bytes&#x27;</span>: 44770,</span><br><span class="line"> <span class="string">&#x27;downloader/response_count&#x27;</span>: 2,</span><br><span class="line"> <span class="string">&#x27;downloader/response_status_count/200&#x27;</span>: 2,</span><br><span class="line"> <span class="string">&#x27;elapsed_time_seconds&#x27;</span>: 0.64364,</span><br><span class="line"> <span class="string">&#x27;finish_reason&#x27;</span>: <span class="string">&#x27;finished&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;finish_time&#x27;</span>: datetime.datetime(2023, 1, 9, 6, 47, 15, 164996),</span><br><span class="line"> <span class="string">&#x27;httpcompression/response_bytes&#x27;</span>: 712081,</span><br><span class="line"> <span class="string">&#x27;httpcompression/response_count&#x27;</span>: 1,</span><br><span class="line"> <span class="comment"># item count</span></span><br><span class="line"> <span class="string">&#x27;item_scraped_count&#x27;</span>: 50,</span><br><span class="line"> <span class="string">&#x27;log_count/DEBUG&#x27;</span>: 60,</span><br><span class="line"> <span class="string">&#x27;log_count/INFO&#x27;</span>: 10,</span><br><span class="line"> <span class="string">&#x27;response_received_count&#x27;</span>: 2,</span><br><span class="line"> <span class="string">&#x27;robotstxt/request_count&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;robotstxt/response_count&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;robotstxt/response_status_count/200&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;scheduler/dequeued&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;scheduler/dequeued/memory&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;scheduler/enqueued&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;scheduler/enqueued/memory&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;start_time&#x27;</span>: datetime.datetime(2023, 1, 9, 6, 47, 14, 521356)&#125;</span><br><span class="line">2023-01-09 14:47:15 [scrapy.core.engine] INFO: Spider closed (finished)</span><br></pre></td></tr></table></figure>

<h4 id="pagination"><a href="#pagination" class="headerlink" title="pagination"></a>pagination</h4><h5 id="items-py-1"><a href="#items-py-1" class="headerlink" title="items.py"></a>items.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define here the models for your scraped items</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See documentation in:</span></span><br><span class="line"><span class="comment"># https://docs.scrapy.org/en/latest/topics/items.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SteamItem</span>(<span class="params">scrapy.Item</span>):</span></span><br><span class="line">    index = scrapy.Field()</span><br><span class="line">    game_url = scrapy.Field()</span><br><span class="line">    img_url = scrapy.Field()</span><br><span class="line">    game_name = scrapy.Field()</span><br><span class="line">    release_date = scrapy.Field()</span><br><span class="line">    platforms = scrapy.Field()</span><br><span class="line">    reviews_summary = scrapy.Field()</span><br><span class="line">    original_price = scrapy.Field()</span><br><span class="line">    discounted_price = scrapy.Field()</span><br><span class="line">    discount_rate = scrapy.Field()</span><br></pre></td></tr></table></figure>

<h5 id="more-best-py"><a href="#more-best-py" class="headerlink" title="more_best.py"></a>more_best.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.selector <span class="keyword">import</span> Selector</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> ..items <span class="keyword">import</span> SteamItem</span><br><span class="line"><span class="keyword">from</span> w3lib.html <span class="keyword">import</span> remove_tags</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoreBestSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;more_best&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;store.steampowered.com&#x27;</span>]</span><br><span class="line">    offset_index = <span class="number">0</span></span><br><span class="line">    INCREASEMENT_COUNT = <span class="number">50</span></span><br><span class="line">    ITEM_MAX = <span class="number">230</span></span><br><span class="line">    <span class="comment"># print game_name + release_date</span></span><br><span class="line">    item_index = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        page_condition = <span class="string">f&quot;query&amp;start=<span class="subst">&#123;self.offset_index&#125;</span>&amp;count=50&amp;dynamic_data=&amp;sort_by=_ASC&amp;supportedlang=english&amp;snr=1_7_7_7000_7&amp;filter=topsellers&amp;infinite=1&quot;</span></span><br><span class="line">        url = <span class="string">f&quot;https://store.steampowered.com/search/results/?<span class="subst">&#123;page_condition&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url = url,</span><br><span class="line">            method = <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">            callback=self.update_query</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_platforms</span>(<span class="params">self, list_classes</span>):</span></span><br><span class="line">        platforms = []</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> list_classes:</span><br><span class="line">            platform = item.split(<span class="string">&#x27; &#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;win&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;Windows&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;mac&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;Mac os&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;linux&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;Linux&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;vr_supported&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;VR supported&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> platforms</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove_html</span>(<span class="params">self, review_summary</span>):</span></span><br><span class="line">        cleaned_review_summary = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cleaned_review_summary = remove_tags(review_summary)</span><br><span class="line">        <span class="keyword">except</span> TypeError:</span><br><span class="line">            cleaned_review_summary = <span class="string">&#x27;No reviews&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> cleaned_review_summary</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_discount_rate</span>(<span class="params">self, discount_rate</span>):</span></span><br><span class="line">        <span class="keyword">if</span> discount_rate:</span><br><span class="line">            <span class="keyword">return</span> discount_rate.lstrip(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> discount_rate</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_original_price</span>(<span class="params">self, selector_obj</span>):</span></span><br><span class="line">        original_price = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        div_with_discount = selector_obj.xpath(<span class="string">&quot;.//div[contains(@class, &#x27;discounted&#x27;)]&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> div_with_discount:</span><br><span class="line">            original_price = selector_obj.xpath(<span class="string">&quot;.//span/strike/text()&quot;</span>).get()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            original_price = selector_obj.xpath(<span class="string">&quot;normalize-space(.//div[contains(@class, &#x27;search_price&#x27;)]/text())&quot;</span>).get()</span><br><span class="line">        <span class="keyword">return</span> original_price</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_discounted_price</span>(<span class="params">self, discounted_price</span>):</span></span><br><span class="line">        <span class="keyword">if</span> discounted_price:</span><br><span class="line">            <span class="keyword">return</span> discounted_price.strip()</span><br><span class="line">        <span class="keyword">return</span> discounted_price</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_query</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        steam_item = SteamItem()</span><br><span class="line"></span><br><span class="line">        resp_dict = json.loads(response.body)</span><br><span class="line">        html = resp_dict[<span class="string">&#x27;results_html&#x27;</span>]</span><br><span class="line">        start_index = resp_dict[<span class="string">&#x27;start&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;==================&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;start=<span class="subst">&#123;start_index&#125;</span>, total_count=<span class="subst">&#123;resp_dict[<span class="string">&#x27;total_count&#x27;</span>]&#125;</span> &quot;</span>)</span><br><span class="line">        <span class="comment"># print(html)</span></span><br><span class="line">        <span class="comment"># print(&quot;==================&quot;)</span></span><br><span class="line">        <span class="comment"># with open(&#x27;index.html&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27;) as f:</span></span><br><span class="line">        <span class="comment">#     f.write(html)</span></span><br><span class="line"></span><br><span class="line">        sel = Selector(text=html)</span><br><span class="line">        games = sel.xpath(<span class="string">&quot;//a&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> game <span class="keyword">in</span> games:</span><br><span class="line">            steam_item[<span class="string">&#x27;game_url&#x27;</span>] = game.xpath(<span class="string">&quot;.//@href&quot;</span>).get()</span><br><span class="line">            steam_item[<span class="string">&#x27;img_url&#x27;</span>] = game.xpath(<span class="string">&quot;.//div[@class=&#x27;col search_capsule&#x27;]/img/@src&quot;</span>).get()</span><br><span class="line">            steam_item[<span class="string">&#x27;game_name&#x27;</span>] = game.xpath(<span class="string">&quot;.//span[@class=&#x27;title&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            steam_item[<span class="string">&#x27;release_date&#x27;</span>] = game.xpath(<span class="string">&quot;.//div[@class=&#x27;col search_released responsive_secondrow&#x27;]/text()&quot;</span>).get()</span><br><span class="line">            steam_item[<span class="string">&#x27;platforms&#x27;</span>] = self.get_platforms(game.xpath(<span class="string">&quot;.//span[contains(@class,&#x27;platform_img&#x27;) or @class=&#x27;VR Supported&#x27;]/@class&quot;</span>).getall())</span><br><span class="line">            steam_item[<span class="string">&#x27;reviews_summary&#x27;</span>] = self.remove_html(game.xpath(<span class="string">&quot;.//span[contains(@class,&#x27;search_review_summary&#x27;)]/@data-tooltip-html&quot;</span>).get())</span><br><span class="line">            steam_item[<span class="string">&#x27;discount_rate&#x27;</span>] = self.clean_discount_rate(game.xpath(<span class="string">&quot;.//div[contains(@class,&#x27;search_discount&#x27;)]/span/text()&quot;</span>).get())</span><br><span class="line">            steam_item[<span class="string">&#x27;original_price&#x27;</span>] = self.get_original_price(game.xpath(<span class="string">&quot;.//div[contains(@class,&#x27;search_price_discount_combined&#x27;)]&quot;</span>))</span><br><span class="line">            steam_item[<span class="string">&#x27;discounted_price&#x27;</span>] = self.clean_discounted_price(game.xpath(<span class="string">&quot;(.//div[contains(@class, &#x27;search_price discounted&#x27;)]/text())[2]&quot;</span>).get())</span><br><span class="line">            steam_item[<span class="string">&#x27;index&#x27;</span>] = self.item_index</span><br><span class="line"></span><br><span class="line">            <span class="comment"># print game_name + release_date</span></span><br><span class="line">            <span class="comment"># print(f&quot;(&#123;self.item_index&#125;) : &#123;steam_item[&#x27;game_name&#x27;]&#125; -  &#123;steam_item[&#x27;release_date&#x27;]&#125;&quot;)</span></span><br><span class="line">            self.item_index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># output</span></span><br><span class="line">            <span class="keyword">yield</span> steam_item</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (start_index + self.INCREASEMENT_COUNT) &lt; self.ITEM_MAX:</span><br><span class="line">            offset_index = start_index + self.INCREASEMENT_COUNT</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;2 ==================&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;next offset_index=<span class="subst">&#123;offset_index&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            page_condition = <span class="string">f&quot;query&amp;start=<span class="subst">&#123;offset_index&#125;</span>&amp;count=50&amp;dynamic_data=&amp;sort_by=_ASC&amp;supportedlang=english&amp;snr=1_7_7_7000_7&amp;filter=topsellers&amp;infinite=1&quot;</span></span><br><span class="line">            url = <span class="string">f&quot;https://store.steampowered.com/search/results/?<span class="subst">&#123;page_condition&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">                url = url,</span><br><span class="line">                method = <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">                callback=self.update_query</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<h5 id="run-5"><a href="#run-5" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\steam&gt;scrapy crawl more_best</span><br><span class="line">......</span><br><span class="line">==================</span><br><span class="line">start=0, total_count=2401</span><br><span class="line">2023-01-10 09:03:54 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://store.steampowered.com/search/results/?query&amp;start=0&amp;count=50&amp;dynamic_data=&amp;sort_by=_ASC&amp;supportedlang=english&amp;snr=1_7_7_7000_7&amp;filter=topsellers&amp;infinite=1&gt;</span><br><span class="line">&#123;<span class="string">&#x27;discount_rate&#x27;</span>: None,</span><br><span class="line"> <span class="string">&#x27;discounted_price&#x27;</span>: None,</span><br><span class="line"> <span class="string">&#x27;game_name&#x27;</span>: <span class="string">&#x27;Apex Legends™&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;game_url&#x27;</span>: <span class="string">&#x27;https://store.steampowered.com/app/1172470/Apex_Legends/?snr=1_7_7_7000_150_1&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;img_url&#x27;</span>: <span class="string">&#x27;https://cdn.cloudflare.steamstatic.com/steam/apps/1172470/capsule_sm_120.jpg?t=1670431796&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;index&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;original_price&#x27;</span>: <span class="string">&#x27;Free to Play&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;platforms&#x27;</span>: [<span class="string">&#x27;Windows&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;release_date&#x27;</span>: <span class="string">&#x27;4 Nov, 2020&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;reviews_summary&#x27;</span>: <span class="string">&#x27;Very Positive84% of the 566,306 user reviews for this &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;game are positive.&#x27;</span>&#125;</span><br><span class="line">2023-01-10 09:03:54 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://store.steampowered.com/search/results/?query&amp;start=0&amp;count=50&amp;dynamic_data=&amp;sort_by=_ASC&amp;supportedlang=english&amp;snr=1_7_7_7000_7&amp;filter=topsellers&amp;infinite=1&gt;</span><br><span class="line">&#123;<span class="string">&#x27;discount_rate&#x27;</span>: None,</span><br><span class="line"> <span class="string">&#x27;discounted_price&#x27;</span>: None,</span><br><span class="line"> <span class="string">&#x27;game_name&#x27;</span>: <span class="string">&#x27;Counter-Strike: Global Offensive&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;game_url&#x27;</span>: <span class="string">&#x27;https://store.steampowered.com/app/730/CounterStrike_Global_Offensive/?snr=1_7_7_7000_150_1&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;img_url&#x27;</span>: <span class="string">&#x27;https://cdn.cloudflare.steamstatic.com/steam/apps/730/capsule_sm_120.jpg?t=1668125812&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;index&#x27;</span>: 2,</span><br><span class="line"> <span class="string">&#x27;original_price&#x27;</span>: <span class="string">&#x27;Free to Play&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;platforms&#x27;</span>: [<span class="string">&#x27;Windows&#x27;</span>, <span class="string">&#x27;Mac os&#x27;</span>, <span class="string">&#x27;Linux&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;release_date&#x27;</span>: <span class="string">&#x27;21 Aug, 2012&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;reviews_summary&#x27;</span>: <span class="string">&#x27;Very Positive88% of the 6,854,744 user reviews for this &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;game are positive.&#x27;</span>&#125;</span><br><span class="line">......</span><br><span class="line">&#123;<span class="string">&#x27;downloader/request_bytes&#x27;</span>: 3227,</span><br><span class="line"> <span class="string">&#x27;downloader/request_count&#x27;</span>: 6,</span><br><span class="line"> <span class="string">&#x27;downloader/request_method_count/GET&#x27;</span>: 6,</span><br><span class="line"> <span class="string">&#x27;downloader/response_bytes&#x27;</span>: 43572,</span><br><span class="line"> <span class="string">&#x27;downloader/response_count&#x27;</span>: 6,</span><br><span class="line"> <span class="string">&#x27;downloader/response_status_count/200&#x27;</span>: 6,</span><br><span class="line"> <span class="string">&#x27;elapsed_time_seconds&#x27;</span>: 2.884105,</span><br><span class="line"> <span class="string">&#x27;finish_reason&#x27;</span>: <span class="string">&#x27;finished&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;finish_time&#x27;</span>: datetime.datetime(2023, 1, 10, 1, 3, 56, 263832),</span><br><span class="line"> <span class="string">&#x27;httpcompression/response_bytes&#x27;</span>: 605551,</span><br><span class="line"> <span class="string">&#x27;httpcompression/response_count&#x27;</span>: 5,</span><br><span class="line"><span class="comment"># items count</span></span><br><span class="line"> <span class="string">&#x27;item_scraped_count&#x27;</span>: 250,</span><br><span class="line"> <span class="string">&#x27;log_count/DEBUG&#x27;</span>: 264,</span><br><span class="line"> <span class="string">&#x27;log_count/INFO&#x27;</span>: 10,</span><br><span class="line"> <span class="string">&#x27;request_depth_max&#x27;</span>: 4,</span><br><span class="line"> <span class="string">&#x27;response_received_count&#x27;</span>: 6,</span><br><span class="line"> <span class="string">&#x27;robotstxt/request_count&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;robotstxt/response_count&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;robotstxt/response_status_count/200&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;scheduler/dequeued&#x27;</span>: 5,</span><br><span class="line"> <span class="string">&#x27;scheduler/dequeued/memory&#x27;</span>: 5,</span><br><span class="line"> <span class="string">&#x27;scheduler/enqueued&#x27;</span>: 5,</span><br><span class="line"> <span class="string">&#x27;scheduler/enqueued/memory&#x27;</span>: 5,</span><br><span class="line"> <span class="string">&#x27;start_time&#x27;</span>: datetime.datetime(2023, 1, 10, 1, 3, 53, 379727)&#125;</span><br><span class="line">2023-01-10 09:03:56 [scrapy.core.engine] INFO: Spider closed (finished)</span><br></pre></td></tr></table></figure>

<h4 id="change-to-ItemLoader"><a href="#change-to-ItemLoader" class="headerlink" title="change to ItemLoader"></a>change to ItemLoader</h4><h5 id="more-best-py-1"><a href="#more-best-py-1" class="headerlink" title="more_best.py"></a>more_best.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.selector <span class="keyword">import</span> Selector</span><br><span class="line"><span class="comment"># add Itemloader</span></span><br><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> ..items <span class="keyword">import</span> SteamItem</span><br><span class="line"><span class="keyword">from</span> w3lib.html <span class="keyword">import</span> remove_tags</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoreBestSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;more_best&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;store.steampowered.com&#x27;</span>]</span><br><span class="line">    offset_index = <span class="number">0</span></span><br><span class="line">    INCREASEMENT_COUNT = <span class="number">50</span></span><br><span class="line">    ITEM_MAX = <span class="number">230</span></span><br><span class="line">    <span class="comment"># print game_name + release_date</span></span><br><span class="line">    item_index = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        page_condition = <span class="string">f&quot;query&amp;start=<span class="subst">&#123;self.offset_index&#125;</span>&amp;count=50&amp;dynamic_data=&amp;sort_by=_ASC&amp;supportedlang=english&amp;snr=1_7_7_7000_7&amp;filter=topsellers&amp;infinite=1&quot;</span></span><br><span class="line">        url = <span class="string">f&quot;https://store.steampowered.com/search/results/?<span class="subst">&#123;page_condition&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url = url,</span><br><span class="line">            method = <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">            callback=self.update_query</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_platforms</span>(<span class="params">self, list_classes</span>):</span></span><br><span class="line">        platforms = []</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> list_classes:</span><br><span class="line">            platform = item.split(<span class="string">&#x27; &#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;win&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;Windows&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;mac&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;Mac os&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;linux&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;Linux&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> platform == <span class="string">&#x27;vr_supported&#x27;</span>:</span><br><span class="line">                platforms.append(<span class="string">&#x27;VR supported&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> platforms</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">remove_html</span>(<span class="params">self, review_summary</span>):</span></span><br><span class="line">        cleaned_review_summary = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cleaned_review_summary = remove_tags(review_summary)</span><br><span class="line">        <span class="keyword">except</span> TypeError:</span><br><span class="line">            cleaned_review_summary = <span class="string">&#x27;No reviews&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> cleaned_review_summary</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_discount_rate</span>(<span class="params">self, discount_rate</span>):</span></span><br><span class="line">        <span class="keyword">if</span> discount_rate:</span><br><span class="line">            <span class="keyword">return</span> discount_rate.lstrip(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> discount_rate</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_original_price</span>(<span class="params">self, selector_obj</span>):</span></span><br><span class="line">        original_price = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        div_with_discount = selector_obj.xpath(<span class="string">&quot;.//div[contains(@class, &#x27;discounted&#x27;)]&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> div_with_discount:</span><br><span class="line">            original_price = selector_obj.xpath(<span class="string">&quot;.//span/strike/text()&quot;</span>).get()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            original_price = selector_obj.xpath(<span class="string">&quot;normalize-space(.//div[contains(@class, &#x27;search_price&#x27;)]/text())&quot;</span>).get()</span><br><span class="line">        <span class="keyword">return</span> original_price</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_discounted_price</span>(<span class="params">self, discounted_price</span>):</span></span><br><span class="line">        <span class="keyword">if</span> discounted_price:</span><br><span class="line">            <span class="keyword">return</span> discounted_price.strip()</span><br><span class="line">        <span class="keyword">return</span> discounted_price</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_query</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        steam_item = SteamItem()</span><br><span class="line"></span><br><span class="line">        resp_dict = json.loads(response.body)</span><br><span class="line">        html = resp_dict[<span class="string">&#x27;results_html&#x27;</span>]</span><br><span class="line">        start_index = resp_dict[<span class="string">&#x27;start&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;==================&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;start=<span class="subst">&#123;start_index&#125;</span>, total_count=<span class="subst">&#123;resp_dict[<span class="string">&#x27;total_count&#x27;</span>]&#125;</span> &quot;</span>)</span><br><span class="line">        <span class="comment"># print(html)</span></span><br><span class="line">        <span class="comment"># print(&quot;==================&quot;)</span></span><br><span class="line">        <span class="comment"># with open(&#x27;index.html&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27;) as f:</span></span><br><span class="line">        <span class="comment">#     f.write(html)</span></span><br><span class="line"></span><br><span class="line">        sel = Selector(text=html)</span><br><span class="line">        games = sel.xpath(<span class="string">&quot;//a&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> game <span class="keyword">in</span> games:</span><br><span class="line">            <span class="comment"># add Itemloader</span></span><br><span class="line">            loader = ItemLoader(item=SteamItem(), selector=game, response=response)</span><br><span class="line">            <span class="comment"># loader.add_css()</span></span><br><span class="line">            <span class="comment"># loader.add_value()</span></span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;game_url&#x27;</span>, <span class="string">&quot;.//@href&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;img_url&#x27;</span>, <span class="string">&quot;.//div[@class=&#x27;col search_capsule&#x27;]/img/@src&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;game_name&#x27;</span>, <span class="string">&quot;.//span[@class=&#x27;title&#x27;]/text()&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;release_date&#x27;</span>, <span class="string">&quot;.//div[@class=&#x27;col search_released responsive_secondrow&#x27;]/text()&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;platforms&#x27;</span>, <span class="string">&quot;.//span[contains(@class,&#x27;platform_img&#x27;) or @class=&#x27;VR Supported&#x27;]/@class&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;reviews_summary&#x27;</span>, <span class="string">&quot;.//span[contains(@class,&#x27;search_review_summary&#x27;)]/@data-tooltip-html&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;discount_rate&#x27;</span>, <span class="string">&quot;.//div[contains(@class,&#x27;search_discount&#x27;)]/span/text()&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;original_price&#x27;</span>, <span class="string">&quot;.//div[contains(@class,&#x27;search_price_discount_combined&#x27;)]&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;discounted_price&#x27;</span>, <span class="string">&quot;(.//div[contains(@class, &#x27;search_price discounted&#x27;)]/text())[2]&quot;</span>)</span><br><span class="line">            loader.add_value(<span class="string">&#x27;index&#x27;</span>, self.item_index)</span><br><span class="line">            self.item_index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># add Itemloader</span></span><br><span class="line">            <span class="comment"># output</span></span><br><span class="line">            <span class="keyword">yield</span> loader.load_item()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (start_index + self.INCREASEMENT_COUNT) &lt; self.ITEM_MAX:</span><br><span class="line">            offset_index = start_index + self.INCREASEMENT_COUNT</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;2 ==================&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;next offset_index=<span class="subst">&#123;offset_index&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            page_condition = <span class="string">f&quot;query&amp;start=<span class="subst">&#123;offset_index&#125;</span>&amp;count=50&amp;dynamic_data=&amp;sort_by=_ASC&amp;supportedlang=english&amp;snr=1_7_7_7000_7&amp;filter=topsellers&amp;infinite=1&quot;</span></span><br><span class="line">            url = <span class="string">f&quot;https://store.steampowered.com/search/results/?<span class="subst">&#123;page_condition&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">                url = url,</span><br><span class="line">                method = <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">                callback=self.update_query</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<h5 id="run-6"><a href="#run-6" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\steam&gt;scrapy crawl more_best</span><br><span class="line">......</span><br><span class="line">==================</span><br><span class="line">start=0, total_count=2396</span><br><span class="line">2023-01-10 10:41:30 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://store.steampowered.com/search/results/?query&amp;start=0&amp;count=50&amp;dynamic_data=&amp;sort_by=_ASC&amp;supportedlang=english&amp;snr=1_7_7_7000_7&amp;filter=topsellers&amp;infinite=1&gt;</span><br><span class="line">&#123;<span class="string">&#x27;game_name&#x27;</span>: [<span class="string">&#x27;Apex Legends™&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;game_url&#x27;</span>: [<span class="string">&#x27;https://store.steampowered.com/app/1172470/Apex_Legends/?snr=1_7_7_7000_150_1&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;img_url&#x27;</span>: [<span class="string">&#x27;https://cdn.cloudflare.steamstatic.com/steam/apps/1172470/capsule_sm_120.jpg?t=1670431796&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;index&#x27;</span>: [1],</span><br><span class="line"> <span class="string">&#x27;original_price&#x27;</span>: [<span class="string">&#x27;&lt;div class=&quot;col search_price_discount_combined &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;responsive_secondrow&quot; data-price-final=&quot;0&quot;&gt;\r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                    &lt;div class=&quot;col search_discount &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;responsive_secondrow&quot;&gt;\r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                        \r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                    &lt;/div&gt;\r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                    &lt;div class=&quot;col search_price  &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;responsive_secondrow&quot;&gt;\r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                        Free to Play                    &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&lt;/div&gt;\r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                &lt;/div&gt;&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;platforms&#x27;</span>: [<span class="string">&#x27;platform_img win&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;release_date&#x27;</span>: [<span class="string">&#x27;4 Nov, 2020&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;reviews_summary&#x27;</span>: [<span class="string">&#x27;Very Positive&lt;br&gt;84% of the 566,351 user reviews for &#x27;</span></span><br><span class="line">                     <span class="string">&#x27;this game are positive.&#x27;</span>]&#125;</span><br><span class="line">2023-01-10 10:41:30 [scrapy.core.scraper] DEBUG: Scraped from &lt;200 https://store.steampowered.com/search/results/?query&amp;start=0&amp;count=50&amp;dynamic_data=&amp;sort_by=_ASC&amp;supportedlang=english&amp;snr=1_7_7_7000_7&amp;filter=topsellers&amp;infinite=1&gt;</span><br><span class="line">&#123;<span class="string">&#x27;game_name&#x27;</span>: [<span class="string">&#x27;Counter-Strike: Global Offensive&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;game_url&#x27;</span>: [<span class="string">&#x27;https://store.steampowered.com/app/730/CounterStrike_Global_Offensive/?snr=1_7_7_7000_150_1&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;img_url&#x27;</span>: [<span class="string">&#x27;https://cdn.cloudflare.steamstatic.com/steam/apps/730/capsule_sm_120.jpg?t=1668125812&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;index&#x27;</span>: [2],</span><br><span class="line"> <span class="string">&#x27;original_price&#x27;</span>: [<span class="string">&#x27;&lt;div class=&quot;col search_price_discount_combined &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;responsive_secondrow&quot; data-price-final=&quot;42800&quot;&gt;\r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                    &lt;div class=&quot;col search_discount &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;responsive_secondrow&quot;&gt;\r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                        \r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                    &lt;/div&gt;\r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                    &lt;div class=&quot;col search_price  &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;responsive_secondrow&quot;&gt;\r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                        Free to Play                    &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&lt;/div&gt;\r\n&#x27;</span></span><br><span class="line">                    <span class="string">&#x27;                &lt;/div&gt;&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;platforms&#x27;</span>: [<span class="string">&#x27;platform_img win&#x27;</span>, <span class="string">&#x27;platform_img mac&#x27;</span>, <span class="string">&#x27;platform_img linux&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;release_date&#x27;</span>: [<span class="string">&#x27;21 Aug, 2012&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;reviews_summary&#x27;</span>: [<span class="string">&#x27;Very Positive&lt;br&gt;88% of the 6,854,852 user reviews for &#x27;</span></span><br><span class="line">                     <span class="string">&#x27;this game are positive.&#x27;</span>]&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="items-py-data-process"><a href="#items-py-data-process" class="headerlink" title="items.py data process"></a>items.py data process</h4><h5 id="items-py-2"><a href="#items-py-2" class="headerlink" title="items.py"></a>items.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define here the models for your scraped items</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See documentation in:</span></span><br><span class="line"><span class="comment"># https://docs.scrapy.org/en/latest/topics/items.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="comment"># change to string(list 1st), input Map</span></span><br><span class="line"><span class="keyword">from</span> scrapy.loader.processors <span class="keyword">import</span> TakeFirst, MapCompose, Join</span><br><span class="line"><span class="keyword">from</span> scrapy.selector <span class="keyword">import</span> Selector</span><br><span class="line"><span class="keyword">from</span> w3lib.html <span class="keyword">import</span> remove_tags</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove_html</span>(<span class="params">review_summary</span>):</span></span><br><span class="line">    cleaned_review_summary = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cleaned_review_summary = remove_tags(review_summary)</span><br><span class="line">    <span class="keyword">except</span> TypeError:</span><br><span class="line">        cleaned_review_summary = <span class="string">&#x27;No reviews&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> cleaned_review_summary</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_platforms</span>(<span class="params">one_class</span>):</span></span><br><span class="line">    platforms = []</span><br><span class="line">    platform = one_class.split(<span class="string">&#x27; &#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> platform == <span class="string">&#x27;win&#x27;</span>:</span><br><span class="line">        platforms.append(<span class="string">&#x27;Windows&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> platform == <span class="string">&#x27;mac&#x27;</span>:</span><br><span class="line">        platforms.append(<span class="string">&#x27;Mac os&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> platform == <span class="string">&#x27;linux&#x27;</span>:</span><br><span class="line">        platforms.append(<span class="string">&#x27;Linux&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> platform == <span class="string">&#x27;vr_supported&#x27;</span>:</span><br><span class="line">        platforms.append(<span class="string">&#x27;VR supported&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> platforms</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_original_price</span>(<span class="params">html_markup</span>):</span></span><br><span class="line">    original_price = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    selector_obj = Selector(text=html_markup)</span><br><span class="line">    div_with_discount = selector_obj.xpath(<span class="string">&quot;.//div[contains(@class, &#x27;discounted&#x27;)]&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> div_with_discount:</span><br><span class="line">        original_price = selector_obj.xpath(<span class="string">&quot;.//span/strike/text()&quot;</span>).get()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        original_price = selector_obj.xpath(<span class="string">&quot;.//div[contains(@class, &#x27;search_price&#x27;)]/text()&quot;</span>).getall()</span><br><span class="line">    <span class="keyword">return</span> original_price</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean_discounted_price</span>(<span class="params">discounted_price</span>):</span></span><br><span class="line">    <span class="keyword">if</span> discounted_price:</span><br><span class="line">        <span class="keyword">return</span> discounted_price.strip()</span><br><span class="line">    <span class="keyword">return</span> discounted_price</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean_discount_rate</span>(<span class="params">discount_rate</span>):</span></span><br><span class="line">    <span class="keyword">if</span> discount_rate:</span><br><span class="line">        <span class="keyword">return</span> discount_rate.lstrip(<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> discount_rate</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SteamItem</span>(<span class="params">scrapy.Item</span>):</span></span><br><span class="line">    index = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    game_url = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    img_url = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    game_name = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    release_date = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    platforms = scrapy.Field(</span><br><span class="line">        input_processor = MapCompose(get_platforms)</span><br><span class="line">    )</span><br><span class="line">    reviews_summary = scrapy.Field(</span><br><span class="line">        input_processor = MapCompose(remove_html),</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    original_price = scrapy.Field(</span><br><span class="line">        input_processor = MapCompose(get_original_price, <span class="built_in">str</span>.strip),</span><br><span class="line">        output_processor = Join(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    discounted_price = scrapy.Field(</span><br><span class="line">        input_processor = MapCompose(clean_discounted_price),</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    discount_rate = scrapy.Field(</span><br><span class="line">        input_processor = MapCompose(clean_discount_rate),</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h5 id="more-best-py-2"><a href="#more-best-py-2" class="headerlink" title="more_best.py"></a>more_best.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.selector <span class="keyword">import</span> Selector</span><br><span class="line"><span class="comment"># add Itemloader</span></span><br><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> ..items <span class="keyword">import</span> SteamItem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoreBestSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;more_best&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;store.steampowered.com&#x27;</span>]</span><br><span class="line">    offset_index = <span class="number">0</span></span><br><span class="line">    INCREASEMENT_COUNT = <span class="number">50</span></span><br><span class="line">    ITEM_MAX = <span class="number">100</span></span><br><span class="line">    <span class="comment"># print game_name + release_date</span></span><br><span class="line">    item_index = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        page_condition = <span class="string">f&quot;query&amp;start=<span class="subst">&#123;self.offset_index&#125;</span>&amp;count=50&amp;dynamic_data=&amp;sort_by=_ASC&amp;supportedlang=english&amp;snr=1_7_7_7000_7&amp;filter=topsellers&amp;infinite=1&quot;</span></span><br><span class="line">        url = <span class="string">f&quot;https://store.steampowered.com/search/results/?<span class="subst">&#123;page_condition&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url = url,</span><br><span class="line">            method = <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">            callback=self.update_query</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_query</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        steam_item = SteamItem()</span><br><span class="line"></span><br><span class="line">        resp_dict = json.loads(response.body)</span><br><span class="line">        html = resp_dict[<span class="string">&#x27;results_html&#x27;</span>]</span><br><span class="line">        start_index = resp_dict[<span class="string">&#x27;start&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;==================&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;start=<span class="subst">&#123;start_index&#125;</span>, total_count=<span class="subst">&#123;resp_dict[<span class="string">&#x27;total_count&#x27;</span>]&#125;</span> &quot;</span>)</span><br><span class="line">        <span class="comment"># print(html)</span></span><br><span class="line">        <span class="comment"># print(&quot;==================&quot;)</span></span><br><span class="line">        <span class="comment"># with open(&#x27;index.html&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27;) as f:</span></span><br><span class="line">        <span class="comment">#     f.write(html)</span></span><br><span class="line"></span><br><span class="line">        sel = Selector(text=html)</span><br><span class="line">        games = sel.xpath(<span class="string">&quot;//a&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> game <span class="keyword">in</span> games:</span><br><span class="line">            <span class="comment"># add Itemloader</span></span><br><span class="line">            loader = ItemLoader(item=SteamItem(), selector=game, response=response)</span><br><span class="line">            <span class="comment"># loader.add_css()</span></span><br><span class="line">            <span class="comment"># loader.add_value()</span></span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;game_url&#x27;</span>, <span class="string">&quot;.//@href&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;img_url&#x27;</span>, <span class="string">&quot;.//div[@class=&#x27;col search_capsule&#x27;]/img/@src&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;game_name&#x27;</span>, <span class="string">&quot;.//span[@class=&#x27;title&#x27;]/text()&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;release_date&#x27;</span>, <span class="string">&quot;.//div[@class=&#x27;col search_released responsive_secondrow&#x27;]/text()&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;platforms&#x27;</span>, <span class="string">&quot;.//span[contains(@class,&#x27;platform_img&#x27;) or @class=&#x27;VR Supported&#x27;]/@class&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;reviews_summary&#x27;</span>, <span class="string">&quot;.//span[contains(@class,&#x27;search_review_summary&#x27;)]/@data-tooltip-html&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;discount_rate&#x27;</span>, <span class="string">&quot;.//div[contains(@class,&#x27;search_discount&#x27;)]/span/text()&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;original_price&#x27;</span>, <span class="string">&quot;.//div[contains(@class,&#x27;search_price_discount_combined&#x27;)]&quot;</span>)</span><br><span class="line">            loader.add_xpath(<span class="string">&#x27;discounted_price&#x27;</span>, <span class="string">&quot;(.//div[contains(@class, &#x27;search_price discounted&#x27;)]/text())[2]&quot;</span>)</span><br><span class="line">            loader.add_value(<span class="string">&#x27;index&#x27;</span>, self.item_index)</span><br><span class="line">            self.item_index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># add Itemloader</span></span><br><span class="line">            <span class="comment"># output</span></span><br><span class="line">            <span class="keyword">yield</span> loader.load_item()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (start_index + self.INCREASEMENT_COUNT) &lt; self.ITEM_MAX:</span><br><span class="line">            offset_index = start_index + self.INCREASEMENT_COUNT</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;2 ==================&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;next offset_index=<span class="subst">&#123;offset_index&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            page_condition = <span class="string">f&quot;query&amp;start=<span class="subst">&#123;offset_index&#125;</span>&amp;count=50&amp;dynamic_data=&amp;sort_by=_ASC&amp;supportedlang=english&amp;snr=1_7_7_7000_7&amp;filter=topsellers&amp;infinite=1&quot;</span></span><br><span class="line">            url = <span class="string">f&quot;https://store.steampowered.com/search/results/?<span class="subst">&#123;page_condition&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">                url = url,</span><br><span class="line">                method = <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">                callback=self.update_query</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<h5 id="run-7"><a href="#run-7" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\steam&gt;scrapy crawl more_best</span><br><span class="line">......</span><br><span class="line">&#123;<span class="string">&#x27;game_name&#x27;</span>: <span class="string">&#x27;Apex Legends™&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;game_url&#x27;</span>: <span class="string">&#x27;https://store.steampowered.com/app/1172470/Apex_Legends/?snr=1_7_7_7000_150_1&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;img_url&#x27;</span>: <span class="string">&#x27;https://cdn.cloudflare.steamstatic.com/steam/apps/1172470/capsule_sm_120.jpg?t=1670431796&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;index&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;original_price&#x27;</span>: <span class="string">&#x27;Free to Play&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;platforms&#x27;</span>: [<span class="string">&#x27;Windows&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;release_date&#x27;</span>: <span class="string">&#x27;4 Nov, 2020&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;reviews_summary&#x27;</span>: <span class="string">&#x27;Very Positive84% of the 566,415 user reviews for this &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;game are positive.&#x27;</span>&#125;</span><br><span class="line">......</span><br><span class="line">&#123;<span class="string">&#x27;discount_rate&#x27;</span>: <span class="string">&#x27;10%&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;discounted_price&#x27;</span>: <span class="string">&#x27;NT$ 259&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;game_name&#x27;</span>: <span class="string">&#x27;Glimmer in Mirror&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;game_url&#x27;</span>: <span class="string">&#x27;https://store.steampowered.com/app/1035760/Glimmer_in_Mirror/?snr=1_7_7_7000_150_1&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;img_url&#x27;</span>: <span class="string">&#x27;https://cdn.cloudflare.steamstatic.com/steam/apps/1035760/capsule_sm_120.jpg?t=1673319346&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;index&#x27;</span>: 25,</span><br><span class="line"> <span class="string">&#x27;original_price&#x27;</span>: <span class="string">&#x27;NT$ 288&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;platforms&#x27;</span>: [<span class="string">&#x27;Windows&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;release_date&#x27;</span>: <span class="string">&#x27;9 Jan, 2023&#x27;</span>&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h3 id="Zillow"><a href="#Zillow" class="headerlink" title="Zillow"></a><a target="_blank" rel="noopener" href="https://www.zillow.com/">Zillow</a></h3><h4 id="1st-run"><a href="#1st-run" class="headerlink" title="1st run"></a>1st run</h4><h5 id="generate-project-amp-spider"><a href="#generate-project-amp-spider" class="headerlink" title="generate project &amp; spider"></a>generate project &amp; spider</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice&gt;scrapy startproject zillow</span><br><span class="line">New Scrapy project <span class="string">&#x27;zillow&#x27;</span>, using template directory <span class="string">&#x27;D:\app\python_env\myenv10_scrapy\lib\site-packages\scrapy\templates\project&#x27;</span>, created <span class="keyword">in</span>:</span><br><span class="line">    D:\work\run\python_crawler\108-scrapy-practice\zillow</span><br><span class="line">You can start your first spider with:</span><br><span class="line">    <span class="built_in">cd</span> zillow</span><br><span class="line">    scrapy genspider example example.com</span><br><span class="line"></span><br><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice&gt;<span class="built_in">cd</span> zillow</span><br><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\zillow&gt;scrapy genspider zillow_houses www.zillow.com</span><br><span class="line">Created spider <span class="string">&#x27;zillow_houses&#x27;</span> using template <span class="string">&#x27;basic&#x27;</span> <span class="keyword">in</span> module:</span><br><span class="line">  zillow.spiders.zillow_houses</span><br></pre></td></tr></table></figure>

<h5 id="settings-py-change"><a href="#settings-py-change" class="headerlink" title="settings.py change"></a>settings.py change</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Crawl responsibly by identifying yourself (and your website) on the user-agent</span></span><br><span class="line"><span class="comment">#USER_AGENT = &#x27;zillow (+http://www.yourdomain.com)&#x27;</span></span><br><span class="line">USER_AGENT = <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Obey robots.txt rules</span></span><br><span class="line"><span class="comment"># disable Obey robots.txt</span></span><br><span class="line">ROBOTSTXT_OBEY = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># add download delay</span></span><br><span class="line">DOWNLOAD_DELAY = <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h5 id="utils-py"><a href="#utils-py" class="headerlink" title="utils.py"></a>utils.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URL = <span class="string">&#x27;https://www.zillow.com/...&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="zillow-houses-py"><a href="#zillow-houses-py" class="headerlink" title="zillow_houses.py"></a>zillow_houses.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> ..utils <span class="keyword">import</span> URL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZillowHousesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;zillow_houses&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;www.zillow.com&#x27;</span>]</span><br><span class="line">    start_urls = [URL]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(response.body)</span><br></pre></td></tr></table></figure>

<h5 id="run-8"><a href="#run-8" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\zillow&gt;scrapy crawl zillow_houses</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h4 id="add-cookie-to-headers-It-doesn’t-need-but-for-test"><a href="#add-cookie-to-headers-It-doesn’t-need-but-for-test" class="headerlink" title="add cookie to headers(It doesn’t need, but for test)"></a>add cookie to headers(It doesn’t need, but for test)</h4><h5 id="utils-py-1"><a href="#utils-py-1" class="headerlink" title="utils.py"></a>utils.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> http.cookies <span class="keyword">import</span> SimpleCookie</span><br><span class="line"></span><br><span class="line">URL = <span class="string">&#x27;https://www.zillow.com/...&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cookie_parser</span>():</span></span><br><span class="line">    cookie_string = <span class="string">&#x27;x-amz-continuous-deployment-state=...&#x27;</span></span><br><span class="line">    cookie = SimpleCookie()</span><br><span class="line">    cookie.load(cookie_string)</span><br><span class="line"></span><br><span class="line">    cookies = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(cookie.items())</span></span><br><span class="line">    <span class="keyword">for</span> key, morsel <span class="keyword">in</span>  cookie.items():</span><br><span class="line">        cookies[key] = morsel.value</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(cookies)</span></span><br><span class="line">    <span class="keyword">return</span> cookies</span><br><span class="line"></span><br><span class="line"><span class="comment"># cookie_parser()</span></span><br></pre></td></tr></table></figure>

<h5 id="zillow-houses-py-1"><a href="#zillow-houses-py-1" class="headerlink" title="zillow_houses.py"></a>zillow_houses.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> ..utils <span class="keyword">import</span> URL, cookie_parser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZillowHousesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;zillow_houses&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;www.zillow.com&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url=URL,</span><br><span class="line">            callback=self.parse,</span><br><span class="line">            <span class="comment"># this site not need cookie, just try put cookie</span></span><br><span class="line">            cookies=cookie_parser()</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;initial_response.json&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(response.body)</span><br></pre></td></tr></table></figure>

<h5 id="run-9"><a href="#run-9" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\zillow&gt;scrapy crawl zillow_houses</span><br></pre></td></tr></table></figure>

<h5 id="initial-response-json"><a href="#initial-response-json" class="headerlink" title="initial_response.json"></a>initial_response.json</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;user&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;isLoggedIn&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;displayName&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;hasHousingConnectorPermission&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;savedSearchCount&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;savedHomesCount&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;personalizedSearchGaDataTag&quot;</span>: <span class="string">&quot;Home Recs&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;personalizedSearchTraceID&quot;</span>: <span class="string">&quot;63bfac101b43a418c290f126f636f3b8&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;searchPageRenderedCount&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;guid&quot;</span>: <span class="string">&quot;c77aeb82-e78d-4e30-ae12-99ebf68ee40c&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;zuid&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;isBot&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;userSpecializedSEORegion&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;mapState&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;customRegionPolygonWkt&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;schoolPolygonWkt&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;isCurrentLocationSearch&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;userPosition&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;lat&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">&quot;lon&quot;</span>: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">		......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Pagination"><a href="#Pagination" class="headerlink" title="Pagination"></a>Pagination</h4><h5 id="utils-py-2"><a href="#utils-py-2" class="headerlink" title="utils.py"></a>utils.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> http.cookies <span class="keyword">import</span> SimpleCookie</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse, parse_qs, urlencode</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">URL = <span class="string">&#x27;https://www.zillow.com/search/GetSearchPageState.htm...&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cookie_parser</span>():</span></span><br><span class="line">    cookie_string = <span class="string">&#x27;x-amz-continuous-deployment-state=...&#x27;</span></span><br><span class="line">    cookie = SimpleCookie()</span><br><span class="line">    cookie.load(cookie_string)</span><br><span class="line"></span><br><span class="line">    cookies = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(cookie.items())</span></span><br><span class="line">    <span class="keyword">for</span> key, morsel <span class="keyword">in</span>  cookie.items():</span><br><span class="line">        cookies[key] = morsel.value</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(cookies)</span></span><br><span class="line">    <span class="keyword">return</span> cookies</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_new_url</span>(<span class="params">url, page_number</span>):</span></span><br><span class="line">    url_parsed = urlparse(url)</span><br><span class="line">    <span class="comment"># convert string to dict</span></span><br><span class="line">    query_string = parse_qs(url_parsed.query)</span><br><span class="line">    search_query_state = json.loads(query_string.get(<span class="string">&#x27;searchQueryState&#x27;</span>)[<span class="number">0</span>])</span><br><span class="line">    search_query_state[<span class="string">&#x27;pagination&#x27;</span>] = &#123;<span class="string">&#x27;currentPage&#x27;</span>:page_number&#125;</span><br><span class="line">    query_string.get(<span class="string">&#x27;searchQueryState&#x27;</span>)[<span class="number">0</span>] = search_query_state</span><br><span class="line">    <span class="comment"># doseq=1, no change field sequencce</span></span><br><span class="line">    encode_qs = urlencode(query_string, doseq=<span class="number">1</span>)</span><br><span class="line">    new_url = <span class="string">f&quot;https://www.zillow.com/search/GetSearchPageState.htm?<span class="subst">&#123;encode_qs&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">return</span> new_url</span><br><span class="line"></span><br><span class="line"><span class="comment"># cookie_parser()</span></span><br><span class="line"><span class="comment"># parse_new_url(URL, 6)</span></span><br></pre></td></tr></table></figure>

<h5 id="items-py-3"><a href="#items-py-3" class="headerlink" title="items.py"></a>items.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define here the models for your scraped items</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See documentation in:</span></span><br><span class="line"><span class="comment"># https://docs.scrapy.org/en/latest/topics/items.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.loader.processors <span class="keyword">import</span> TakeFirst</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZillowItem</span>(<span class="params">scrapy.Item</span>):</span></span><br><span class="line">    index = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">id</span> = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    img_url = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    detail_url = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    status_type = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    status_text = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    price = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    address = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    beds = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    baths = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    area_sqft = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    latitude = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    longitude = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    broker_name = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h5 id="zillow-houses-py-2"><a href="#zillow-houses-py-2" class="headerlink" title="zillow_houses.py"></a>zillow_houses.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader</span><br><span class="line"><span class="keyword">from</span> ..utils <span class="keyword">import</span> URL, cookie_parser, parse_new_url</span><br><span class="line"><span class="keyword">from</span> ..items <span class="keyword">import</span> ZillowItem</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZillowHousesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;zillow_houses&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;www.zillow.com&#x27;</span>]</span><br><span class="line">    index = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url=URL,</span><br><span class="line">            callback=self.parse,</span><br><span class="line">            <span class="comment"># this site not need cookie, just try put cookie</span></span><br><span class="line">            cookies=cookie_parser(),</span><br><span class="line">            meta = &#123;</span><br><span class="line">                <span class="string">&#x27;currentPage&#x27;</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="comment"># with open(&#x27;initial_response.json&#x27;, &#x27;wb&#x27;) as f:</span></span><br><span class="line">        <span class="comment">#     f.write(response.body)</span></span><br><span class="line">        current_page = response.meta[<span class="string">&#x27;currentPage&#x27;</span>]</span><br><span class="line">        json_resp = json.loads(response.body)</span><br><span class="line">        <span class="comment"># print(type(json_resp))</span></span><br><span class="line">        houses = json_resp[<span class="string">&#x27;cat1&#x27;</span>][<span class="string">&#x27;searchResults&#x27;</span>][<span class="string">&#x27;listResults&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> house <span class="keyword">in</span> houses:</span><br><span class="line">            loader = ItemLoader(item=ZillowItem())</span><br><span class="line">            loader.add_value(<span class="string">&#x27;id&#x27;</span>, house[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;img_url&#x27;</span>, house[<span class="string">&#x27;imgSrc&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;detail_url&#x27;</span>, house[<span class="string">&#x27;detailUrl&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;status_type&#x27;</span>, house[<span class="string">&#x27;statusType&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;status_text&#x27;</span>, house[<span class="string">&#x27;statusText&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;price&#x27;</span>, house[<span class="string">&#x27;price&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;address&#x27;</span>, house[<span class="string">&#x27;address&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;beds&#x27;</span>, house[<span class="string">&#x27;beds&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;baths&#x27;</span>, house[<span class="string">&#x27;baths&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;area_sqft&#x27;</span>, house[<span class="string">&#x27;area&#x27;</span>])</span><br><span class="line">            <span class="comment"># dict field 某些地方一定要用 get()</span></span><br><span class="line">            loader.add_value(<span class="string">&#x27;latitude&#x27;</span>, house.get(<span class="string">&#x27;latLong&#x27;</span>).get(<span class="string">&#x27;latitude&#x27;</span>))</span><br><span class="line">            loader.add_value(<span class="string">&#x27;longitude&#x27;</span>, house.get(<span class="string">&#x27;latLong&#x27;</span>).get(<span class="string">&#x27;longitude&#x27;</span>))</span><br><span class="line">            loader.add_value(<span class="string">&#x27;broker_name&#x27;</span>, house.get(<span class="string">&#x27;brokerName&#x27;</span>))</span><br><span class="line">            loader.add_value(<span class="string">&#x27;index&#x27;</span>, self.index)</span><br><span class="line">            self.index += <span class="number">1</span></span><br><span class="line">            <span class="keyword">yield</span> loader.load_item()</span><br><span class="line"></span><br><span class="line">        total_pages = json_resp.get(<span class="string">&#x27;cat1&#x27;</span>).get(<span class="string">&#x27;searchList&#x27;</span>).get(<span class="string">&#x27;totalPages&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> current_page&lt; total_pages:</span><br><span class="line">            current_page += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;----&gt; <span class="subst">&#123;current_page&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">                url=parse_new_url(URL, current_page),</span><br><span class="line">                callback=self.parse,</span><br><span class="line">                cookies=cookie_parser(),</span><br><span class="line">                meta = &#123;</span><br><span class="line">                    <span class="string">&#x27;currentPage&#x27;</span>: current_page</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<h5 id="run-10"><a href="#run-10" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\zillow&gt;scrapy crawl zillow_houses -o miami.json</span><br></pre></td></tr></table></figure>

<h4 id="download-images"><a href="#download-images" class="headerlink" title="download images"></a>download images</h4><h5 id="install-pillow"><a href="#install-pillow" class="headerlink" title="install pillow"></a>install pillow</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pillow</span><br></pre></td></tr></table></figure>

<h5 id="settings-py-1"><a href="#settings-py-1" class="headerlink" title="settings.py"></a>settings.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configure item pipelines</span></span><br><span class="line"><span class="comment"># See https://docs.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line"><span class="comment">#ITEM_PIPELINES = &#123;</span></span><br><span class="line"><span class="comment">#    &#x27;zillow.pipelines.ZillowPipeline&#x27;: 300,</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"><span class="comment"># download images - activa images pipeline</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="string">&#x27;scrapy.pipelines.images.ImagesPipeline&#x27;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">IMAGES_STORE = <span class="string">&#x27;.&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="items-py-4"><a href="#items-py-4" class="headerlink" title="items.py"></a>items.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define here the models for your scraped items</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See documentation in:</span></span><br><span class="line"><span class="comment"># https://docs.scrapy.org/en/latest/topics/items.html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.loader.processors <span class="keyword">import</span> TakeFirst</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZillowItem</span>(<span class="params">scrapy.Item</span>):</span></span><br><span class="line">    index = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">id</span> = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># img_url = scrapy.Field(</span></span><br><span class="line">    <span class="comment">#     output_processor = TakeFirst()</span></span><br><span class="line">    <span class="comment"># )</span></span><br><span class="line">    <span class="comment"># download images</span></span><br><span class="line">    image_urls = scrapy.Field()</span><br><span class="line">    images = scrapy.Field()</span><br><span class="line">    detail_url = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    status_type = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    status_text = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    price = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    address = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    beds = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    baths = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    area_sqft = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    latitude = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    longitude = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br><span class="line">    broker_name = scrapy.Field(</span><br><span class="line">        output_processor = TakeFirst()</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h5 id="zillow-houses-py-3"><a href="#zillow-houses-py-3" class="headerlink" title="zillow_houses.py"></a>zillow_houses.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader</span><br><span class="line"><span class="keyword">from</span> ..utils <span class="keyword">import</span> URL, cookie_parser, parse_new_url</span><br><span class="line"><span class="keyword">from</span> ..items <span class="keyword">import</span> ZillowItem</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZillowHousesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;zillow_houses&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;www.zillow.com&#x27;</span>]</span><br><span class="line">    index = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">yield</span> scrapy.Request(</span><br><span class="line">            url=URL,</span><br><span class="line">            callback=self.parse,</span><br><span class="line">            <span class="comment"># this site not need cookie, just try put cookie</span></span><br><span class="line">            cookies=cookie_parser(),</span><br><span class="line">            meta = &#123;</span><br><span class="line">                <span class="string">&#x27;currentPage&#x27;</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="comment"># with open(&#x27;initial_response.json&#x27;, &#x27;wb&#x27;) as f:</span></span><br><span class="line">        <span class="comment">#     f.write(response.body)</span></span><br><span class="line">        current_page = response.meta[<span class="string">&#x27;currentPage&#x27;</span>]</span><br><span class="line">        json_resp = json.loads(response.body)</span><br><span class="line">        <span class="comment"># print(type(json_resp))</span></span><br><span class="line">        houses = json_resp[<span class="string">&#x27;cat1&#x27;</span>][<span class="string">&#x27;searchResults&#x27;</span>][<span class="string">&#x27;listResults&#x27;</span>]</span><br><span class="line">        <span class="keyword">for</span> house <span class="keyword">in</span> houses:</span><br><span class="line">            loader = ItemLoader(item=ZillowItem())</span><br><span class="line">            loader.add_value(<span class="string">&#x27;id&#x27;</span>, house[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">            <span class="comment"># download images</span></span><br><span class="line">            loader.add_value(<span class="string">&#x27;image_urls&#x27;</span>, house[<span class="string">&#x27;imgSrc&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;detail_url&#x27;</span>, house[<span class="string">&#x27;detailUrl&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;status_type&#x27;</span>, house[<span class="string">&#x27;statusType&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;status_text&#x27;</span>, house[<span class="string">&#x27;statusText&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;price&#x27;</span>, house[<span class="string">&#x27;price&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;address&#x27;</span>, house[<span class="string">&#x27;address&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;beds&#x27;</span>, house[<span class="string">&#x27;beds&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;baths&#x27;</span>, house[<span class="string">&#x27;baths&#x27;</span>])</span><br><span class="line">            loader.add_value(<span class="string">&#x27;area_sqft&#x27;</span>, house[<span class="string">&#x27;area&#x27;</span>])</span><br><span class="line">            <span class="comment"># dict field 某些地方一定要用 get()</span></span><br><span class="line">            loader.add_value(<span class="string">&#x27;latitude&#x27;</span>, house.get(<span class="string">&#x27;latLong&#x27;</span>).get(<span class="string">&#x27;latitude&#x27;</span>))</span><br><span class="line">            loader.add_value(<span class="string">&#x27;longitude&#x27;</span>, house.get(<span class="string">&#x27;latLong&#x27;</span>).get(<span class="string">&#x27;longitude&#x27;</span>))</span><br><span class="line">            loader.add_value(<span class="string">&#x27;broker_name&#x27;</span>, house.get(<span class="string">&#x27;brokerName&#x27;</span>))</span><br><span class="line">            loader.add_value(<span class="string">&#x27;index&#x27;</span>, self.index)</span><br><span class="line">            self.index += <span class="number">1</span></span><br><span class="line">            <span class="keyword">yield</span> loader.load_item()</span><br><span class="line"></span><br><span class="line">        total_pages = json_resp.get(<span class="string">&#x27;cat1&#x27;</span>).get(<span class="string">&#x27;searchList&#x27;</span>).get(<span class="string">&#x27;totalPages&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> current_page&lt; total_pages:</span><br><span class="line">            current_page += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;----&gt; <span class="subst">&#123;current_page&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># yield scrapy.Request(</span></span><br><span class="line">            <span class="comment">#     url=parse_new_url(URL, current_page),</span></span><br><span class="line">            <span class="comment">#     callback=self.parse,</span></span><br><span class="line">            <span class="comment">#     cookies=cookie_parser(),</span></span><br><span class="line">            <span class="comment">#     meta = &#123;</span></span><br><span class="line">            <span class="comment">#         &#x27;currentPage&#x27;: current_page</span></span><br><span class="line">            <span class="comment">#     &#125;</span></span><br><span class="line">            <span class="comment"># )</span></span><br></pre></td></tr></table></figure>

<h5 id="run-11"><a href="#run-11" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\zillow&gt;scrapy crawl zillow_houses</span><br><span class="line">......</span><br><span class="line">&#123;<span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;10855 SW 82nd Ave, Miami, FL 33156&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;area_sqft&#x27;</span>: 2327,</span><br><span class="line"> <span class="string">&#x27;baths&#x27;</span>: 3.0,</span><br><span class="line"> <span class="string">&#x27;beds&#x27;</span>: 3,</span><br><span class="line"> <span class="string">&#x27;broker_name&#x27;</span>: <span class="string">&#x27;ON Florida Realty, LLC.&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;detail_url&#x27;</span>: <span class="string">&#x27;https://www.zillow.com/homedetails/10855-SW-82nd-Ave-Miami-FL-33156/44283802_zpid/&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;44283802&#x27;</span>,</span><br><span class="line"><span class="comment"># image information </span></span><br><span class="line"> <span class="string">&#x27;image_urls&#x27;</span>: [<span class="string">&#x27;https://photos.zillowstatic.com/fp/44ae5bc3430d05f820acbd7d367abc67-p_e.jpg&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;images&#x27;</span>: [&#123;<span class="string">&#x27;checksum&#x27;</span>: <span class="string">&#x27;3efad256f0ec1c55213d06974679f999&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;full/e3d76a1cf0b56690a53be6c861f5ef5b670727f2.jpg&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;downloaded&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;https://photos.zillowstatic.com/fp/44ae5bc3430d05f820acbd7d367abc67-p_e.jpg&#x27;</span>&#125;],</span><br><span class="line"> <span class="string">&#x27;index&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;latitude&#x27;</span>: 25.669407,</span><br><span class="line"> <span class="string">&#x27;longitude&#x27;</span>: -80.3265,</span><br><span class="line"> <span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;$1,195,000&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;status_text&#x27;</span>: <span class="string">&#x27;House for sale&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;status_type&#x27;</span>: <span class="string">&#x27;FOR_SALE&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="change-image-name-to-id"><a href="#change-image-name-to-id" class="headerlink" title="change image name to id"></a>change image name to id</h4><h5 id="pipelines-py"><a href="#pipelines-py" class="headerlink" title="pipelines.py"></a>pipelines.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define your item pipelines here</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Don&#x27;t forget to add your pipeline to the ITEM_PIPELINES setting</span></span><br><span class="line"><span class="comment"># See: https://docs.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># useful for handling different item types with a single interface</span></span><br><span class="line"><span class="keyword">from</span> itemadapter <span class="keyword">import</span> ItemAdapter</span><br><span class="line"><span class="comment"># change download image name</span></span><br><span class="line"><span class="keyword">from</span> scrapy.pipelines.images <span class="keyword">import</span> ImagesPipeline</span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Request</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZillowPipeline</span>(<span class="params">ImagesPipeline</span>):</span></span><br><span class="line">    <span class="comment"># change download image name</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_media_requests</span>(<span class="params">self, item, info</span>):</span></span><br><span class="line">        urls = ItemAdapter(item).get(self.images_urls_field, [])</span><br><span class="line">        <span class="keyword">return</span> [Request(u, meta=&#123;<span class="string">&#x27;houseID&#x27;</span>: item.get(<span class="string">&#x27;id&#x27;</span>)&#125;) <span class="keyword">for</span> u <span class="keyword">in</span> urls]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># change download image name</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">file_path</span>(<span class="params">self, request, response=<span class="literal">None</span>, info=<span class="literal">None</span>, *, item=<span class="literal">None</span></span>):</span></span><br><span class="line">        image_name = request.meta[<span class="string">&#x27;houseID&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&#x27;full/<span class="subst">&#123;image_name&#125;</span>.jpg&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="settings-py-2"><a href="#settings-py-2" class="headerlink" title="settings.py"></a>settings.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configure item pipelines</span></span><br><span class="line"><span class="comment"># See https://docs.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line"><span class="comment">#ITEM_PIPELINES = &#123;</span></span><br><span class="line"><span class="comment">#    &#x27;zillow.pipelines.ZillowPipeline&#x27;: 300,</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"><span class="comment"># download images - activa images pipeline</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line"><span class="comment">#    &#x27;scrapy.pipelines.images.ImagesPipeline&#x27;: 1</span></span><br><span class="line">    <span class="string">&#x27;zillow.pipelines.ZillowPipeline&#x27;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">IMAGES_STORE = <span class="string">&#x27;.&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="run-12"><a href="#run-12" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\zillow&gt;scrapy crawl zillow_houses</span><br><span class="line">.....</span><br><span class="line">&#123;<span class="string">&#x27;address&#x27;</span>: <span class="string">&#x27;10822 SW 165th Ter, Miami, FL 33157&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;area_sqft&#x27;</span>: 1595,</span><br><span class="line"> <span class="string">&#x27;baths&#x27;</span>: 2.0,</span><br><span class="line"> <span class="string">&#x27;beds&#x27;</span>: 5,</span><br><span class="line"> <span class="string">&#x27;broker_name&#x27;</span>: <span class="string">&#x27;Sigma Real Estate &amp; Investment&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;detail_url&#x27;</span>: <span class="string">&#x27;https://www.zillow.com/homedetails/10822-SW-165th-Ter-Miami-FL-33157/44298616_zpid/&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;44298616&#x27;</span>,</span><br><span class="line"><span class="comment"># image information</span></span><br><span class="line"> <span class="string">&#x27;image_urls&#x27;</span>: [<span class="string">&#x27;https://photos.zillowstatic.com/fp/b5c1b3a40c525c8c96002c8a969b550d-p_e.jpg&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;images&#x27;</span>: [&#123;<span class="string">&#x27;checksum&#x27;</span>: <span class="string">&#x27;dded82b1a953d6d9ac5e681ec894b7b4&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;full/44298616.jpg&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;downloaded&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;https://photos.zillowstatic.com/fp/b5c1b3a40c525c8c96002c8a969b550d-p_e.jpg&#x27;</span>&#125;],</span><br><span class="line"> <span class="string">&#x27;index&#x27;</span>: 1,</span><br><span class="line"> <span class="string">&#x27;latitude&#x27;</span>: 25.615082,</span><br><span class="line"> <span class="string">&#x27;longitude&#x27;</span>: -80.368904,</span><br><span class="line"> <span class="string">&#x27;price&#x27;</span>: <span class="string">&#x27;$899,000&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;status_text&#x27;</span>: <span class="string">&#x27;House for sale&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;status_type&#x27;</span>: <span class="string">&#x27;FOR_SALE&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Desktop-App"><a href="#Desktop-App" class="headerlink" title="Desktop App"></a>Desktop App</h3><h4 id="gui"><a href="#gui" class="headerlink" title="gui"></a>gui</h4><h5 id="gui-app-py"><a href="#gui-app-py" class="headerlink" title="gui_app.py"></a>gui_app.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">app = Tk()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Spider List</span></span><br><span class="line">spider_label = Label(app, text=<span class="string">&#x27;Chose a spider&#x27;</span>)</span><br><span class="line">spider_label.grid(row=<span class="number">0</span>, column=<span class="number">0</span>, sticky=W, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">spider_text = StringVar(app)</span><br><span class="line">spider_text.<span class="built_in">set</span>(<span class="string">&#x27;Chose a spider&#x27;</span>)</span><br><span class="line">spiders = [<span class="string">&#x27;Spider_1&#x27;</span>, <span class="string">&#x27;Spider_2&#x27;</span>]</span><br><span class="line"></span><br><span class="line">spider_dropdown = OptionMenu(app, spider_text, *spiders)</span><br><span class="line">spider_dropdown.grid(row=<span class="number">0</span>, column=<span class="number">1</span>, columnspan=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Feed Type</span></span><br><span class="line">feed_label = Label(app, text=<span class="string">&#x27;Chose a feed&#x27;</span>)</span><br><span class="line">feed_label.grid(row=<span class="number">1</span>, column=<span class="number">0</span>, sticky=W, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">feed_text = StringVar(app)</span><br><span class="line">feed_text.<span class="built_in">set</span>(<span class="string">&#x27;Chose a feed&#x27;</span>)</span><br><span class="line">feeds = [<span class="string">&#x27;JSON&#x27;</span>, <span class="string">&#x27;CSV&#x27;</span>]</span><br><span class="line"></span><br><span class="line">feed_dropdown = OptionMenu(app, feed_text, *feeds)</span><br><span class="line">feed_dropdown.grid(row=<span class="number">1</span>, column=<span class="number">1</span>, columnspan=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Path Entry</span></span><br><span class="line">folder_path_text = StringVar(app)</span><br><span class="line">folder_path_entry = Entry(app, textvariable=folder_path_text)</span><br><span class="line">folder_path_entry.grid(row=<span class="number">2</span>, column=<span class="number">0</span>, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dataset Entry</span></span><br><span class="line">dataset_path_text = StringVar(app)</span><br><span class="line">dataset_path_entry = Entry(app, textvariable=dataset_path_text, width=<span class="number">10</span>)</span><br><span class="line">dataset_path_entry.grid(row=<span class="number">2</span>, column=<span class="number">1</span>, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">browse_btn = Button(app, text=<span class="string">&#x27;Browse&#x27;</span>)</span><br><span class="line">browse_btn.grid(row=<span class="number">2</span>, column=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">execute_btn = Button(app, text=<span class="string">&#x27;Execute&#x27;</span>)</span><br><span class="line">execute_btn.grid(row=<span class="number">3</span>, column=<span class="number">0</span>, columnspan=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">app.title(<span class="string">&#x27;Spider Executer&#x27;</span>)</span><br><span class="line">app.geometry(<span class="string">&#x27;320x200&#x27;</span>)</span><br><span class="line">app.resizable(<span class="literal">False</span>, <span class="literal">False</span>)</span><br><span class="line">app.mainloop()</span><br></pre></td></tr></table></figure>

<h5 id="run-13"><a href="#run-13" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS D:\work\run\python_crawler\108-scrapy-practice\zillow&gt; python .\gui_app.py</span><br></pre></td></tr></table></figure>
<div style="max-width:400px">
    <img src="/2023/01/05/python-14/pic6.png" class="" title="pic6">
</div>

<h4 id="link-to-spider"><a href="#link-to-spider" class="headerlink" title="link to spider"></a>link to spider</h4><h5 id="gui-app-py-1"><a href="#gui-app-py-1" class="headerlink" title="gui_app.py"></a>gui_app.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> messagebox</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> filedialog</span><br><span class="line"><span class="keyword">from</span> scrapy.utils <span class="keyword">import</span> project</span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> spiderloader</span><br><span class="line"><span class="keyword">from</span> scrapy.utils.log <span class="keyword">import</span> configure_logging</span><br><span class="line"><span class="keyword">from</span> scrapy.crawler <span class="keyword">import</span> CrawlerRunner</span><br><span class="line"><span class="keyword">from</span> scrapy.utils.reactor <span class="keyword">import</span> install_reactor</span><br><span class="line"><span class="comment"># need put in front of &quot;from twisted.internet import reactor&quot;</span></span><br><span class="line">install_reactor(<span class="string">&#x27;twisted.internet.asyncioreactor.AsyncioSelectorReactor&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_spiders</span>():</span></span><br><span class="line">    settings = project.get_project_settings()</span><br><span class="line">    spider_loader = spiderloader.SpiderLoader.from_settings(settings)</span><br><span class="line">    <span class="keyword">return</span> spider_loader.<span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_chosen_spider</span>(<span class="params">value</span>):</span></span><br><span class="line">    <span class="keyword">global</span> chosen_spider</span><br><span class="line">    chosen_spider = value</span><br><span class="line">    <span class="keyword">return</span> chosen_spider</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_chosen_feed</span>(<span class="params">value</span>):</span></span><br><span class="line">    <span class="keyword">global</span> chosen_feed</span><br><span class="line">    chosen_feed = value</span><br><span class="line">    <span class="keyword">return</span> chosen_feed</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">browse_button</span>():</span></span><br><span class="line">    <span class="keyword">global</span> folder_path</span><br><span class="line">    folder_path = filedialog.askdirectory()</span><br><span class="line">    folder_path_entry.delete(<span class="number">0</span>, END)</span><br><span class="line">    folder_path_entry.insert(<span class="number">0</span>, folder_path)</span><br><span class="line">    <span class="keyword">return</span> folder_path</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_spider</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dataset_entry.get() == <span class="string">&#x27;&#x27;</span>) <span class="keyword">or</span> (chosen_feed <span class="keyword">not</span> <span class="keyword">in</span> feeds):</span><br><span class="line">        messagebox.showerror(<span class="string">&#x27;Error&#x27;</span>, <span class="string">&#x27;All_entries are required&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        feed_uri = <span class="string">f&quot;file:///<span class="subst">&#123;folder_path&#125;</span>/<span class="subst">&#123;dataset_entry.get()&#125;</span>.<span class="subst">&#123;chosen_feed&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">except</span> :</span><br><span class="line">        messagebox.showerror(<span class="string">&#x27;Error&#x27;</span>, <span class="string">&#x27;All_entries are required(except)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    settings = project.get_project_settings()</span><br><span class="line">    settings.<span class="built_in">set</span>(<span class="string">&#x27;FEED_URI&#x27;</span>, feed_uri)</span><br><span class="line">    settings.<span class="built_in">set</span>(<span class="string">&#x27;FEED_TYPE&#x27;</span>, chosen_feed)    </span><br><span class="line"></span><br><span class="line">    configure_logging()</span><br><span class="line">    runner = CrawlerRunner(settings)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;---&gt;<span class="subst">&#123;chosen_spider&#125;</span>&quot;</span>)</span><br><span class="line">    runner.crawl(chosen_spider)</span><br><span class="line"></span><br><span class="line">    reactor.run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Tk()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Spider List</span></span><br><span class="line">spider_label = Label(app, text=<span class="string">&#x27;Chose a spider&#x27;</span>)</span><br><span class="line">spider_label.grid(row=<span class="number">0</span>, column=<span class="number">0</span>, sticky=W, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">spider_text = StringVar(app)</span><br><span class="line">spider_text.<span class="built_in">set</span>(<span class="string">&#x27;Chose a spider&#x27;</span>)</span><br><span class="line">spiders = [spider <span class="keyword">for</span> spider <span class="keyword">in</span> get_spiders()]</span><br><span class="line"></span><br><span class="line">spider_dropdown = OptionMenu(app, spider_text, *spiders, command=get_chosen_spider)</span><br><span class="line">spider_dropdown.grid(row=<span class="number">0</span>, column=<span class="number">1</span>, columnspan=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Feed Type</span></span><br><span class="line">feed_label = Label(app, text=<span class="string">&#x27;Chose a feed&#x27;</span>)</span><br><span class="line">feed_label.grid(row=<span class="number">1</span>, column=<span class="number">0</span>, sticky=W, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">feed_text = StringVar(app)</span><br><span class="line">feed_text.<span class="built_in">set</span>(<span class="string">&#x27;Chose a feed&#x27;</span>)</span><br><span class="line">feeds = [<span class="string">&#x27;json&#x27;</span>, <span class="string">&#x27;csv&#x27;</span>]</span><br><span class="line">feed_dropdown = OptionMenu(app, feed_text, *feeds, command=get_chosen_feed)</span><br><span class="line">feed_dropdown.grid(row=<span class="number">1</span>, column=<span class="number">1</span>, columnspan=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Path Entry</span></span><br><span class="line">folder_path_text = StringVar(app)</span><br><span class="line">folder_path_entry = Entry(app, textvariable=folder_path_text)</span><br><span class="line">folder_path_entry.grid(row=<span class="number">2</span>, column=<span class="number">0</span>, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dataset Entry</span></span><br><span class="line">dataset_text = StringVar(app)</span><br><span class="line">dataset_entry = Entry(app, textvariable=dataset_text, width=<span class="number">10</span>)</span><br><span class="line">dataset_entry.grid(row=<span class="number">2</span>, column=<span class="number">1</span>, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">browse_btn = Button(app, text=<span class="string">&#x27;Browse&#x27;</span>, command=browse_button)</span><br><span class="line">browse_btn.grid(row=<span class="number">2</span>, column=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">execute_btn = Button(app, text=<span class="string">&#x27;Execute&#x27;</span>, command=execute_spider)</span><br><span class="line">execute_btn.grid(row=<span class="number">3</span>, column=<span class="number">0</span>, columnspan=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">app.title(<span class="string">&#x27;Spider Executer&#x27;</span>)</span><br><span class="line">app.geometry(<span class="string">&#x27;320x200&#x27;</span>)</span><br><span class="line">app.resizable(<span class="literal">False</span>, <span class="literal">False</span>)</span><br><span class="line">app.mainloop()</span><br></pre></td></tr></table></figure>

<h5 id="run-14"><a href="#run-14" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(myenv10_scrapy) D:\work\run\python_crawler\108-scrapy-practice\zillow&gt;python gui_app.py</span><br></pre></td></tr></table></figure>

<h4 id="Async-Crawl"><a href="#Async-Crawl" class="headerlink" title="Async Crawl"></a>Async Crawl</h4><h5 id="gui-app-py-2"><a href="#gui-app-py-2" class="headerlink" title="gui_app.py"></a>gui_app.py</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> messagebox</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> filedialog</span><br><span class="line"><span class="keyword">from</span> scrapy.utils <span class="keyword">import</span> project</span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> spiderloader</span><br><span class="line"><span class="keyword">from</span> scrapy.utils.log <span class="keyword">import</span> configure_logging</span><br><span class="line"><span class="keyword">from</span> scrapy.crawler <span class="keyword">import</span> CrawlerRunner</span><br><span class="line"><span class="keyword">from</span> scrapy.utils.reactor <span class="keyword">import</span> install_reactor</span><br><span class="line"><span class="comment"># need put in front of &quot;from twisted.internet import reactor&quot;</span></span><br><span class="line">install_reactor(<span class="string">&#x27;twisted.internet.asyncioreactor.AsyncioSelectorReactor&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_spiders</span>():</span></span><br><span class="line">    settings = project.get_project_settings()</span><br><span class="line">    spider_loader = spiderloader.SpiderLoader.from_settings(settings)</span><br><span class="line">    <span class="keyword">return</span> spider_loader.<span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_chosen_spider</span>(<span class="params">value</span>):</span></span><br><span class="line">    <span class="keyword">global</span> chosen_spider</span><br><span class="line">    chosen_spider = value</span><br><span class="line">    <span class="keyword">return</span> chosen_spider</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_chosen_feed</span>(<span class="params">value</span>):</span></span><br><span class="line">    <span class="keyword">global</span> chosen_feed</span><br><span class="line">    chosen_feed = value</span><br><span class="line">    <span class="keyword">return</span> chosen_feed</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">browse_button</span>():</span></span><br><span class="line">    <span class="keyword">global</span> folder_path</span><br><span class="line">    folder_path = filedialog.askdirectory()</span><br><span class="line">    folder_path_entry.delete(<span class="number">0</span>, END)</span><br><span class="line">    folder_path_entry.insert(<span class="number">0</span>, folder_path)</span><br><span class="line">    <span class="keyword">return</span> folder_path</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_spider</span>():</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dataset_entry.get() == <span class="string">&#x27;&#x27;</span>) <span class="keyword">or</span> (chosen_feed <span class="keyword">not</span> <span class="keyword">in</span> feeds):</span><br><span class="line">        messagebox.showerror(<span class="string">&#x27;Error&#x27;</span>, <span class="string">&#x27;All_entries are required&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># It doesn&#x27;t need - only try open file browser</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        feed_uri = <span class="string">f&quot;file:///<span class="subst">&#123;folder_path&#125;</span>/<span class="subst">&#123;dataset_entry.get()&#125;</span>.<span class="subst">&#123;chosen_feed&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">except</span> :</span><br><span class="line">        messagebox.showerror(<span class="string">&#x27;Error&#x27;</span>, <span class="string">&#x27;All_entries are required(except)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    settings = project.get_project_settings()</span><br><span class="line">    feed_name = <span class="string">f&quot;data/<span class="subst">&#123;dataset_entry.get()&#125;</span>.<span class="subst">&#123;chosen_feed&#125;</span>&quot;</span></span><br><span class="line">    feed_value = &#123;<span class="string">&#x27;format&#x27;</span>: chosen_feed&#125;</span><br><span class="line">    settings.<span class="built_in">set</span>(<span class="string">&#x27;FEEDS&#x27;</span>, &#123; feed_name : feed_value&#125;)</span><br><span class="line"></span><br><span class="line">    configure_logging()</span><br><span class="line">    runner = CrawlerRunner(settings)</span><br><span class="line">    runner.crawl(chosen_spider)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># add asyn crawl</span></span><br><span class="line">    d = runner.join()</span><br><span class="line">    d.addBoth(<span class="keyword">lambda</span> _: reactor.stop())</span><br><span class="line"></span><br><span class="line">    reactor.run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Tk()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Spider List</span></span><br><span class="line">spider_label = Label(app, text=<span class="string">&#x27;Chose a spider&#x27;</span>)</span><br><span class="line">spider_label.grid(row=<span class="number">0</span>, column=<span class="number">0</span>, sticky=W, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">spider_text = StringVar(app)</span><br><span class="line">spider_text.<span class="built_in">set</span>(<span class="string">&#x27;Chose a spider&#x27;</span>)</span><br><span class="line">spiders = [spider <span class="keyword">for</span> spider <span class="keyword">in</span> get_spiders()]</span><br><span class="line"></span><br><span class="line">spider_dropdown = OptionMenu(app, spider_text, *spiders, command=get_chosen_spider)</span><br><span class="line">spider_dropdown.grid(row=<span class="number">0</span>, column=<span class="number">1</span>, columnspan=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Feed Type</span></span><br><span class="line">feed_label = Label(app, text=<span class="string">&#x27;Chose a feed&#x27;</span>)</span><br><span class="line">feed_label.grid(row=<span class="number">1</span>, column=<span class="number">0</span>, sticky=W, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">feed_text = StringVar(app)</span><br><span class="line">feed_text.<span class="built_in">set</span>(<span class="string">&#x27;Chose a feed&#x27;</span>)</span><br><span class="line">feeds = [<span class="string">&#x27;json&#x27;</span>, <span class="string">&#x27;csv&#x27;</span>]</span><br><span class="line">feed_dropdown = OptionMenu(app, feed_text, *feeds, command=get_chosen_feed)</span><br><span class="line">feed_dropdown.grid(row=<span class="number">1</span>, column=<span class="number">1</span>, columnspan=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Path Entry</span></span><br><span class="line">folder_path_text = StringVar(app)</span><br><span class="line">folder_path_entry = Entry(app, textvariable=folder_path_text)</span><br><span class="line">folder_path_entry.grid(row=<span class="number">2</span>, column=<span class="number">0</span>, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dataset Entry</span></span><br><span class="line">dataset_text = StringVar(app)</span><br><span class="line">dataset_entry = Entry(app, textvariable=dataset_text, width=<span class="number">10</span>)</span><br><span class="line">dataset_entry.grid(row=<span class="number">2</span>, column=<span class="number">1</span>, pady=<span class="number">10</span>, padx=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">browse_btn = Button(app, text=<span class="string">&#x27;Browse&#x27;</span>, command=browse_button)</span><br><span class="line">browse_btn.grid(row=<span class="number">2</span>, column=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">execute_btn = Button(app, text=<span class="string">&#x27;Execute&#x27;</span>, command=execute_spider)</span><br><span class="line">execute_btn.grid(row=<span class="number">3</span>, column=<span class="number">0</span>, columnspan=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">app.title(<span class="string">&#x27;Spider Executer&#x27;</span>)</span><br><span class="line">app.geometry(<span class="string">&#x27;320x200&#x27;</span>)</span><br><span class="line">app.resizable(<span class="literal">False</span>, <span class="literal">False</span>)</span><br><span class="line">app.mainloop()</span><br></pre></td></tr></table></figure>

<h5 id="run-15"><a href="#run-15" class="headerlink" title="run"></a>run</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS D:\work\run\python_crawler\108-scrapy-practice\zillow&gt; python.exe .\gui_app.py</span><br></pre></td></tr></table></figure>

<h3 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.postman.com/downloads/">Postman</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/python/" rel="tag"># python</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/12/24/python-13/" rel="prev" title="python Selenium Example(自動化測試)">
                  <i class="fa fa-chevron-left"></i> python Selenium Example(自動化測試)
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/01/10/python-15/" rel="next" title="Python ScrapyRT 說明(Scrapy realtime)">
                  Python ScrapyRT 說明(Scrapy realtime) <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Robert Kao</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="總字數">2.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">40:58</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  




  


<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://hot5656-blog.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://hot5656.github.io/2023/01/05/python-14/";
    this.page.identifier = "2023/01/05/python-14/";
    this.page.title = "Python Scrapy Practice(Advanced)";
    };
  NexT.utils.loadComments('#disqus_thread', () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://hot5656-blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
