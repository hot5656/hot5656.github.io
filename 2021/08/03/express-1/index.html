<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hot5656.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"},"path":"/search.json","localsearch":{"enable":"enable","trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="node.js create web server1234567891011121314151617181920212223242526272829&#x2F;&#x2F; index.jsconst http &#x3D; require(&amp;#x27;http&amp;#x27;)const server &#x3D; http.createServer(handler)function handler(req, res) &amp;#123;	co">
<meta property="og:type" content="article">
<meta property="og:title" content="Express">
<meta property="og:url" content="https://hot5656.github.io/2021/08/03/express-1/index.html">
<meta property="og:site_name" content="Robert 雜記">
<meta property="og:description" content="node.js create web server1234567891011121314151617181920212223242526272829&#x2F;&#x2F; index.jsconst http &#x3D; require(&amp;#x27;http&amp;#x27;)const server &#x3D; http.createServer(handler)function handler(req, res) &amp;#123;	co">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://hot5656.github.io/2021/08/03/express-1/pic1.png">
<meta property="og:image" content="https://hot5656.github.io/2021/08/03/express-1/pic2.png">
<meta property="og:image" content="https://hot5656.github.io/2021/08/03/express-1/pic3.png">
<meta property="og:image" content="https://hot5656.github.io/2021/08/03/express-1/pic4.png">
<meta property="og:image" content="https://hot5656.github.io/2021/08/03/express-1/pic5.png">
<meta property="article:published_time" content="2021-08-03T13:53:42.000Z">
<meta property="article:modified_time" content="2022-06-09T03:38:34.681Z">
<meta property="article:author" content="Robert Kao">
<meta property="article:tag" content="express">
<meta property="article:tag" content="node.js">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hot5656.github.io/2021/08/03/express-1/pic1.png">


<link rel="canonical" href="https://hot5656.github.io/2021/08/03/express-1/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>
<title>Express | Robert 雜記</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Robert 雜記</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔列表</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#node-js-create-web-server"><span class="nav-number">1.</span> <span class="nav-text">node.js create web server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Express-server"><span class="nav-number">2.</span> <span class="nav-text">Express server</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Example-1"><span class="nav-number">2.1.</span> <span class="nav-text">Example #1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Example-2-add-template"><span class="nav-number">2.2.</span> <span class="nav-text">Example #2 - add template</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Example-3-MVC"><span class="nav-number">2.3.</span> <span class="nav-text">Example #3 - MVC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Example-4-add-mysql"><span class="nav-number">2.4.</span> <span class="nav-text">Example #4 - add mysql</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#express-middleware-%E4%B8%AD%E4%BB%8B%E8%BB%9F%E9%AB%94"><span class="nav-number">3.</span> <span class="nav-text">express middleware(中介軟體)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#example-simple-query-string"><span class="nav-number">3.1.</span> <span class="nav-text">example - simple ( query string)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#body-parser"><span class="nav-number">3.2.</span> <span class="nav-text">body parser</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#express-session"><span class="nav-number">3.3.</span> <span class="nav-text">express session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#connect-flash"><span class="nav-number">3.4.</span> <span class="nav-text">connect-flash</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B0%A1%E6%98%93%E6%9C%83%E5%93%A1%E8%A8%BB%E5%86%8A%E7%B3%BB%E7%B5%B1"><span class="nav-number">3.5.</span> <span class="nav-text">簡易會員註冊系統</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B0%A1%E6%98%93%E7%95%99%E8%A8%80%E6%9D%BF"><span class="nav-number">3.6.</span> <span class="nav-text">簡易留言板</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ORM-%E8%88%87-Sequelize"><span class="nav-number">4.</span> <span class="nav-text">ORM 與 Sequelize</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Sequelize-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-number">4.1.</span> <span class="nav-text">Sequelize 基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#insatll-sequelize"><span class="nav-number">4.1.1.</span> <span class="nav-text">insatll sequelize</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#link-DB-and-create-table%E2%80%99s-item"><span class="nav-number">4.1.2.</span> <span class="nav-text">link DB and create table’s item</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#get-x2F-modify-x2F-delete-table-item"><span class="nav-number">4.1.3.</span> <span class="nav-text">get&#x2F;modify&#x2F;delete table item</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#related-db-control"><span class="nav-number">4.1.4.</span> <span class="nav-text">related db control</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sequelize-CLI"><span class="nav-number">4.2.</span> <span class="nav-text">Sequelize CLI</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#install-sequelize-cli"><span class="nav-number">4.2.1.</span> <span class="nav-text">install sequelize-cli</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#init-sequeliz"><span class="nav-number">4.2.2.</span> <span class="nav-text">init sequeliz</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#create-model"><span class="nav-number">4.2.3.</span> <span class="nav-text">create model</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#migrate-generate-db-table"><span class="nav-number">4.2.4.</span> <span class="nav-text">migrate (generate db table)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%82%BA-model-%E5%8A%A0%E4%B8%8A%E9%97%9C%E8%81%AF"><span class="nav-number">4.2.5.</span> <span class="nav-text">為 model 加上關聯</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#create-table-item"><span class="nav-number">4.2.6.</span> <span class="nav-text">create table item</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%94%B9%E9%80%A0%E7%95%99%E8%A8%80%E6%9D%BF"><span class="nav-number">4.3.</span> <span class="nav-text">改造留言板</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#data-%E6%93%8D%E4%BD%9C"><span class="nav-number">4.3.1.</span> <span class="nav-text">data 操作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#install-and-create-DB-migrate"><span class="nav-number">4.3.2.</span> <span class="nav-text">install and create DB(migrate)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#add-user-id-for-comment"><span class="nav-number">4.3.3.</span> <span class="nav-text">add user id for comment</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-username-unique"><span class="nav-number">4.3.4.</span> <span class="nav-text">set username unique</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%92%A4%E9%8A%B7migrate-then-migrate"><span class="nav-number">4.3.5.</span> <span class="nav-text">撤銷migrate then migrate</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#model-%E5%8A%A0%E4%B8%8A%E9%97%9C%E8%81%AF"><span class="nav-number">4.3.6.</span> <span class="nav-text">model 加上關聯</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#index-js"><span class="nav-number">4.3.7.</span> <span class="nav-text">index.js</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#view%E2%80%99s-template"><span class="nav-number">4.3.8.</span> <span class="nav-text">view’s template</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#view"><span class="nav-number">4.3.9.</span> <span class="nav-text">view</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#control"><span class="nav-number">4.3.10.</span> <span class="nav-text">control</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ngainx-and-PM2"><span class="nav-number">5.</span> <span class="nav-text">Ngainx and PM2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PM2"><span class="nav-number">5.1.</span> <span class="nav-text">PM2</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#command"><span class="nav-number">5.1.1.</span> <span class="nav-text">command</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nginx"><span class="nav-number">5.2.</span> <span class="nav-text">Nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#install"><span class="nav-number">5.2.1.</span> <span class="nav-text">install</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-web-server"><span class="nav-number">5.2.2.</span> <span class="nav-text">run web server</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#set-for-DNS"><span class="nav-number">5.3.</span> <span class="nav-text">set for DNS</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#configure-nginx-to-web-server"><span class="nav-number">5.3.1.</span> <span class="nav-text">configure nginx to web server</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#reload-nginx"><span class="nav-number">5.3.2.</span> <span class="nav-text">reload nginx</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Heroku"><span class="nav-number">6.</span> <span class="nav-text">Heroku</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#develop-node-js-no-db"><span class="nav-number">6.1.</span> <span class="nav-text">develop node.js - no db</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#install-Heroku-CLI"><span class="nav-number">6.1.1.</span> <span class="nav-text">install Heroku CLI</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#package-json-add-%E2%80%9Cscript-start%E2%80%9D-and-%E2%80%9Cengines%E2%80%9D"><span class="nav-number">6.1.2.</span> <span class="nav-text">package.json add “script start” and “engines”</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-env-port"><span class="nav-number">6.1.3.</span> <span class="nav-text">set env port</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-heroku-local-test"><span class="nav-number">6.1.4.</span> <span class="nav-text">run heroku local test</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#develop-to-heroku"><span class="nav-number">6.1.5.</span> <span class="nav-text">develop to heroku</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#develop-node-js-include-db"><span class="nav-number">6.2.</span> <span class="nav-text">develop node.js - include db</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#install-Heroku-CLI-1"><span class="nav-number">6.2.1.</span> <span class="nav-text">install Heroku CLI</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#package-json-add-%E2%80%9Cscript-start%E2%80%9D-and-%E2%80%9Cengines%E2%80%9D-1"><span class="nav-number">6.2.2.</span> <span class="nav-text">package.json add “script start” and “engines”</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-env-port-1"><span class="nav-number">6.2.3.</span> <span class="nav-text">set env port</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#run-heroku-local-test-1"><span class="nav-number">6.2.4.</span> <span class="nav-text">run heroku local test</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#develop-to-heroku-1"><span class="nav-number">6.2.5.</span> <span class="nav-text">develop to heroku</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#develop-db-for-heroku"><span class="nav-number">6.2.6.</span> <span class="nav-text">develop db for heroku</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#heidisql-link-to-heroku-db"><span class="nav-number">6.2.7.</span> <span class="nav-text">heidisql link to heroku db</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AWS-%E9%83%A8%E7%BD%B2-node-js-express-nginx"><span class="nav-number">7.</span> <span class="nav-text">AWS 部署(node.js + express + nginx)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#install-nginx-node-js-npm-pm2"><span class="nav-number">7.1.</span> <span class="nav-text">install nginx, node.js, npm, pm2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#install-mysql"><span class="nav-number">7.2.</span> <span class="nav-text">install mysql</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96-app-%E9%80%A3%E8%87%B3-MySQL"><span class="nav-number">7.3.</span> <span class="nav-text">其他 app 連至 MySQL</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Inbound-Rules-%E6%96%B0%E5%A2%9E-HTTP-TCP-port-3306"><span class="nav-number">7.3.1.</span> <span class="nav-text">Inbound Rules 新增 HTTP TCP port:3306</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mask-bind-address-%E5%85%81%E8%A8%B1%E9%80%A3%E7%B7%9A%E4%B8%BB%E6%A9%9F"><span class="nav-number">7.3.2.</span> <span class="nav-text">mask bind-address(允許連線主機)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#root-localhost-%E6%94%B9%E6%88%90"><span class="nav-number">7.3.3.</span> <span class="nav-text">root localhost 改成 %</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#heidisq-port-3306-setting"><span class="nav-number">7.3.4.</span> <span class="nav-text">heidisq port 3306 setting</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#install-and-start-app"><span class="nav-number">7.4.</span> <span class="nav-text">install and start app</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#run-nginx"><span class="nav-number">7.5.</span> <span class="nav-text">run nginx</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#npm-mysql"><span class="nav-number">8.</span> <span class="nav-text">npm mysql</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#example-1"><span class="nav-number">8.1.</span> <span class="nav-text">example #1</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><span class="nav-number">9.</span> <span class="nav-text">參考資料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Robert Kao"
      src="/images/head.png">
  <p class="site-author-name" itemprop="name">Robert Kao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">170</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
        <div class="back-to-top animated" role="button">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://hot5656.github.io/2021/08/03/express-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="Robert Kao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Robert 雜記">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Express
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2021-08-03 21:53:42" itemprop="dateCreated datePublished" datetime="2021-08-03T21:53:42+08:00">2021-08-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新於</span>
        <time title="修改時間：2022-06-09 11:38:34" itemprop="dateModified" datetime="2022-06-09T11:38:34+08:00">2022-06-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Back-End/" itemprop="url" rel="index"><span itemprop="name">Back End</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2021/08/03/express-1/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/08/03/express-1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>66k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>1:01</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h3 id="node-js-create-web-server"><a href="#node-js-create-web-server" class="headerlink" title="node.js create web server"></a>node.js create web server</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> server = http.createServer(handler)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(req.url)</span><br><span class="line">	<span class="keyword">if</span> (req.url === <span class="string">&#x27;/hello&#x27;</span>) &#123;</span><br><span class="line">		res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">			<span class="comment">// &#x27;Connect-Type&#x27;: &#x27;text/plain&#x27; - 沒有效果</span></span><br><span class="line">			<span class="string">&#x27;Connect-Type&#x27;</span>: <span class="string">&#x27;text/html&#x27;</span></span><br><span class="line">		&#125;)</span><br><span class="line">		res.write(<span class="string">&#x27;&lt;h1&gt;hello!&lt;/h1&gt;&#x27;</span>)</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> ( req.url === <span class="string">&#x27;/bye&#x27;</span>)&#123;</span><br><span class="line">		res.write(<span class="string">&#x27;bye&#x27;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> ( req.url === <span class="string">&#x27;/new&#x27;</span>)&#123;</span><br><span class="line">		<span class="comment">// 轉址</span></span><br><span class="line">		res.writeHead(<span class="number">301</span>, &#123;</span><br><span class="line">			<span class="string">&#x27;Location&#x27;</span>: <span class="string">&#x27;/bye&#x27;</span></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		res.write(<span class="string">&#x27;Invalid url&#x27;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	res.end()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">5001</span>)</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h3 id="Express-server"><a href="#Express-server" class="headerlink" title="Express server"></a>Express server</h3><h4 id="Example-1"><a href="#Example-1" class="headerlink" title="Example #1"></a>Example #1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install express</span></span><br><span class="line">npm install express</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span>&#123;</span><br><span class="line">	res.send(<span class="string">&#x27;Hello!&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/hello&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span>&#123;</span><br><span class="line">	res.send(<span class="string">&#x27;Hello man!&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/bye&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span>&#123;</span><br><span class="line">	res.send(<span class="string">&#x27;Bye!&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Example-2-add-template"><a href="#Example-2-add-template" class="headerlink" title="Example #2 - add template"></a>Example #2 - add template</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># template engine --&gt; ejs</span></span><br><span class="line"><span class="comment"># install </span></span><br><span class="line">npm install ejs</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// set view engine type - directory is ./views</span></span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span>&#123;</span><br><span class="line">	res.send(<span class="string">&#x27;index...&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todos = [</span><br><span class="line">	<span class="string">&#x27;first todo&#x27;</span>, <span class="string">&#x27;second todo&#x27;</span>, <span class="string">&#x27;third todo&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/todos&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span>&#123;</span><br><span class="line">	<span class="comment">// map to views</span></span><br><span class="line">	res.render(<span class="string">&#x27;todos&#x27;</span>, &#123;</span><br><span class="line">		<span class="comment">// ES6 可省略</span></span><br><span class="line">		<span class="comment">// todos: todos</span></span><br><span class="line">		todos</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/todos/:id&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">const</span> id = req.params.id</span><br><span class="line">	<span class="keyword">const</span> todo = todos[id]	</span><br><span class="line">	<span class="comment">// map to views</span></span><br><span class="line">	res.render(<span class="string">&#x27;todo&#x27;</span>, &#123;</span><br><span class="line">		todo</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/todos.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Todos<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">	&lt;% for(let i=0 ; i<span class="tag">&lt;<span class="name">todos.length</span> ; <span class="attr">i</span>++) &#123; %&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- &lt; % = 表要輸出 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">li</span>&gt;</span>&lt;%= todos[i] %&gt;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	&lt;% &#125; %&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/todo.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Todo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&lt;%= todo %&gt;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Example-3-MVC"><a href="#Example-3-MVC" class="headerlink" title="Example #3 - MVC"></a>Example #3 - MVC</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// set view engine type - directory is ./views</span></span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/todos&#x27;</span>, todoController.getAll)</span><br><span class="line">app.get(<span class="string">&#x27;/todos/:id&#x27;</span>, todoController.get)</span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./controllers/todo.js</span></span><br><span class="line"><span class="keyword">const</span> todoModel = <span class="built_in">require</span>(<span class="string">&#x27;../models/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = &#123;</span><br><span class="line">	getAll: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> todos = todoModel.getAll()</span><br><span class="line">		res.render(<span class="string">&#x27;todos&#x27;</span>, &#123;</span><br><span class="line">			todos</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> id = req.params.id</span><br><span class="line">		<span class="keyword">const</span> todo = todoModel.get(id)</span><br><span class="line">		res.render(<span class="string">&#x27;todo&#x27;</span>, &#123;</span><br><span class="line">			todo</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoController</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./modules/todo.js</span></span><br><span class="line"><span class="keyword">const</span> todos = [</span><br><span class="line">	<span class="string">&#x27;first todo&#x27;</span>, <span class="string">&#x27;second todo&#x27;</span>, <span class="string">&#x27;third todo&#x27;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> todoModel = &#123;</span><br><span class="line">	getAll: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> todos</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> todos[id]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoModel</span><br></pre></td></tr></table></figure>

<h4 id="Example-4-add-mysql"><a href="#Example-4-add-mysql" class="headerlink" title="Example #4 - add mysql"></a>Example #4 - add mysql</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;./db&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// set view engine type - directory is ./views</span></span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/todos&#x27;</span>, todoController.getAll)</span><br><span class="line">app.get(<span class="string">&#x27;/todos/:id&#x27;</span>, todoController.get)</span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// add todo db</span></span><br><span class="line">	db.connect()</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// db.js</span></span><br><span class="line"><span class="keyword">var</span> mysql      = <span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> connection = mysql.createConnection(&#123;</span><br><span class="line">  host     : <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  user     : <span class="string">&#x27;robert&#x27;</span>,</span><br><span class="line">  password : <span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">  database : <span class="string">&#x27;app&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = connection</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./controllers/todo.js</span></span><br><span class="line"><span class="keyword">const</span> todoModel = <span class="built_in">require</span>(<span class="string">&#x27;../models/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = &#123;</span><br><span class="line">	getAll: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		todoModel.getAll(<span class="function">(<span class="params">err,results</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.render(<span class="string">&#x27;todos&#x27;</span>, &#123;</span><br><span class="line">				todos : results</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> id = req.params.id</span><br><span class="line">		todoModel.get(id, <span class="function">(<span class="params">err,results</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.render(<span class="string">&#x27;todo&#x27;</span>, &#123;</span><br><span class="line">				todo : results</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoController</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./modules/todo.js</span></span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;../db&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todos = [</span><br><span class="line">	<span class="string">&#x27;first todo&#x27;</span>, <span class="string">&#x27;second todo&#x27;</span>, <span class="string">&#x27;third todo&#x27;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> todoModel = &#123;</span><br><span class="line">	getAll: <span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;SELECT * FROM todos&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">			cb(<span class="literal">null</span>, results)</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">id,cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;SELECT * FROM todos WHERE id=?&#x27;</span>, [id], </span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">				cb(<span class="literal">null</span>, results)</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoModel</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/todos.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Todos<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">	&lt;% for(let i=0 ; i<span class="tag">&lt;<span class="name">todos.length</span> ; <span class="attr">i</span>++) &#123; %&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- &lt; % = 表要輸出 --&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- &lt;li&gt;&lt;%= todos[i].id %&gt;: &lt;%= todos[i].content %&gt;&lt;/li&gt; --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">li</span>&gt;</span>&lt;%= todos[i].id + &#x27;: &#x27; + todos[i].content %&gt;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	&lt;% &#125; %&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/todo.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Todo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&lt;% if (todo.length &gt;0) &#123; %&gt;</span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span>&gt;</span>&lt;%= todo[0].content %&gt;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">&lt;% &#125; %&gt; </span><br></pre></td></tr></table></figure>

<h3 id="express-middleware-中介軟體"><a href="#express-middleware-中介軟體" class="headerlink" title="express middleware(中介軟體)"></a>express middleware(中介軟體)</h3><h4 id="example-simple-query-string"><a href="#example-simple-query-string" class="headerlink" title="example - simple ( query string)"></a>example - simple ( query string)</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;./db&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// set view engine type - directory is ./views</span></span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// total middleware</span></span><br><span class="line"><span class="comment">// app.use((req, rep, next) =&gt; &#123;</span></span><br><span class="line"><span class="comment">// 	// middlewate test </span></span><br><span class="line"><span class="comment">// 	// console.log(&#x27;Time:&#x27;, new Date())</span></span><br><span class="line"><span class="comment">// 	// run next step</span></span><br><span class="line"><span class="comment">// 	// next()</span></span><br><span class="line"><span class="comment">// 	// response end</span></span><br><span class="line"><span class="comment">// 	// rep.end()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 	// middleware test permission</span></span><br><span class="line"><span class="comment">// 	if (req.query.admin === &#x27;1&#x27;) &#123;</span></span><br><span class="line"><span class="comment">// 		next()</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// 	else &#123;</span></span><br><span class="line"><span class="comment">// 		rep.end(&#x27;Error!&#x27;)</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// add permision check (admin===1)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkPermission</span>(<span class="params">req, rep, next</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (req.query.admin === <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">		next()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		rep.end(<span class="string">&#x27;Error!&#x27;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// add permision check for one item</span></span><br><span class="line">app.get(<span class="string">&#x27;/todos&#x27;</span>, checkPermission, todoController.getAll)</span><br><span class="line">app.get(<span class="string">&#x27;/todos/:id&#x27;</span>, todoController.get)</span><br><span class="line">app.get(<span class="string">&#x27;/test&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// query string - &#123; a: &#x27;1&#x27;, b: &#x27;2&#x27; &#125;</span></span><br><span class="line">	<span class="built_in">console</span>.log(req.query)</span><br><span class="line">	<span class="comment">// response info</span></span><br><span class="line">	<span class="comment">// console.log(req)</span></span><br><span class="line">	res.send(<span class="string">&#x27;Test!&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// add todo db</span></span><br><span class="line">	db.connect()</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./controllers/todo.js</span></span><br><span class="line"><span class="keyword">const</span> todoModel = <span class="built_in">require</span>(<span class="string">&#x27;../models/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// add permision check (admin===1)</span></span><br><span class="line"><span class="comment">// function checkPermission(req) &#123;</span></span><br><span class="line"><span class="comment">// 	return (req.query.admin === &#x27;1&#x27;)</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = &#123;</span><br><span class="line">	getAll: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// add permision check (admin===1)</span></span><br><span class="line">		<span class="comment">// http://localhost:3000/todos?admin=1</span></span><br><span class="line">		<span class="comment">// if (!checkPermission(req)) return res.end()</span></span><br><span class="line">		todoModel.getAll(<span class="function">(<span class="params">err,results</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.render(<span class="string">&#x27;todos&#x27;</span>, &#123;</span><br><span class="line">				todos : results</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="comment">// add permision check (admin===1)</span></span><br><span class="line">		<span class="comment">// http://localhost:3000/todos/1?admin=1</span></span><br><span class="line">		<span class="comment">// if (!checkPermission(req)) return res.end()</span></span><br><span class="line">		<span class="keyword">const</span> id = req.params.id</span><br><span class="line">		todoModel.get(id, <span class="function">(<span class="params">err,results</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.render(<span class="string">&#x27;todo&#x27;</span>, &#123;</span><br><span class="line">				todo : results</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoController</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./modules/todo.js</span></span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;../db&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todos = [</span><br><span class="line">	<span class="string">&#x27;first todo&#x27;</span>, <span class="string">&#x27;second todo&#x27;</span>, <span class="string">&#x27;third todo&#x27;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> todoModel = &#123;</span><br><span class="line">	getAll: <span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;SELECT * FROM todos&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">			cb(<span class="literal">null</span>, results)</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">id,cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;SELECT * FROM todos WHERE id=?&#x27;</span>, [id], </span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">				cb(<span class="literal">null</span>, results)</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoModel</span><br></pre></td></tr></table></figure>

<h4 id="body-parser"><a href="#body-parser" class="headerlink" title="body parser"></a>body parser</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install body parser</span></span><br><span class="line">npm install body-parser</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;./db&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// set view engine type - directory is ./views</span></span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="comment">// parse application/x-www-form-urlencoded</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br><span class="line"><span class="comment">// parse application/json</span></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/todos&#x27;</span>, todoController.newTodo)</span><br><span class="line">app.get(<span class="string">&#x27;/todos&#x27;</span>, todoController.getAll)</span><br><span class="line">app.get(<span class="string">&#x27;/todos/:id&#x27;</span>, todoController.get)</span><br><span class="line"><span class="comment">// add add todo</span></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, todoController.addTodo)</span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// add todo db</span></span><br><span class="line">	db.connect()</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./controllers/todo.js</span></span><br><span class="line"><span class="keyword">const</span> todoModel = <span class="built_in">require</span>(<span class="string">&#x27;../models/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = &#123;</span><br><span class="line">	getAll: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		todoModel.getAll(<span class="function">(<span class="params">err,results</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.render(<span class="string">&#x27;todos&#x27;</span>, &#123;</span><br><span class="line">				todos : results</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> id = req.params.id</span><br><span class="line">		todoModel.get(id, <span class="function">(<span class="params">err,results</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.render(<span class="string">&#x27;todo&#x27;</span>, &#123;</span><br><span class="line">				todo : results</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	addTodo: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		res.render(<span class="string">&#x27;addTodo&#x27;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	newTodo:  <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="comment">// get body data</span></span><br><span class="line">		<span class="keyword">const</span> content = req.body.content</span><br><span class="line">		todoModel.add(content, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.redirect(<span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoController</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./modules/todo.js</span></span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;../db&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todos = [</span><br><span class="line">	<span class="string">&#x27;first todo&#x27;</span>, <span class="string">&#x27;second todo&#x27;</span>, <span class="string">&#x27;third todo&#x27;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> todoModel = &#123;</span><br><span class="line">	getAll: <span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;SELECT * FROM todos&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">			cb(<span class="literal">null</span>, results)</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">id,cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;SELECT * FROM todos WHERE id=?&#x27;</span>, [id], </span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">				cb(<span class="literal">null</span>, results)</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125;,</span><br><span class="line">	add: <span class="function">(<span class="params">content, cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;INSERT INTO todos(content) VALUES(?)&#x27;</span>, [content], </span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">				<span class="comment">// console.log(results)</span></span><br><span class="line">				cb(<span class="literal">null</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoModel</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/todos.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Todos<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>add todo<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">	&lt;% for(let i=0 ; i<span class="tag">&lt;<span class="name">todos.length</span> ; <span class="attr">i</span>++) &#123; %&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- &lt; % = 表要輸出 --&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- &lt;li&gt;&lt;%= todos[i].id %&gt;: &lt;%= todos[i].content %&gt;&lt;/li&gt; --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">li</span>&gt;</span>&lt;%= todos[i].id + &#x27;: &#x27; + todos[i].content %&gt;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	&lt;% &#125; %&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/todo.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Todo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&lt;% if (todo.length &gt;0) &#123; %&gt;</span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span>&gt;</span>&lt;%= todo[0].content %&gt;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">&lt;% &#125; %&gt; </span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/addTodo.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>AddTodo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&#x27;POST&#x27;</span> <span class="attr">action</span>=<span class="string">&quot;/todos&quot;</span>&gt;</span></span><br><span class="line">	Content: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;content&#x27;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="express-session"><a href="#express-session" class="headerlink" title="express session"></a>express session</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install</span></span><br><span class="line">npm install express-session</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="comment">// add express session</span></span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>)</span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;./db&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// set view engine type - directory is ./views</span></span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="comment">// parse application/x-www-form-urlencoded</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br><span class="line"><span class="comment">// parse application/json</span></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line"></span><br><span class="line"><span class="comment">// add express session</span></span><br><span class="line"><span class="comment">// app.set(&#x27;trust proxy&#x27;, 1) // if have proxy and using secure: tre, need run</span></span><br><span class="line"><span class="comment">// if https recommend set cookie: &#123; secure: true &#125;</span></span><br><span class="line"><span class="comment">// app.use(session(&#123;</span></span><br><span class="line"><span class="comment">// 	secret: &#x27;keyboard cat&#x27;,</span></span><br><span class="line"><span class="comment">// 	resave: false</span></span><br><span class="line"><span class="comment">// &#125;));</span></span><br><span class="line"><span class="comment">// app.use(session(&#123;</span></span><br><span class="line"><span class="comment">//   secret: &#x27;keyboard cat&#x27;,</span></span><br><span class="line"><span class="comment">//   resave: false,</span></span><br><span class="line"><span class="comment">//   saveUninitialized: true,</span></span><br><span class="line"><span class="comment">//   cookie: &#123; secure: true &#125;</span></span><br><span class="line"><span class="comment">// &#125;))</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret: <span class="string">&#x27;keyboard cat&#x27;</span>,</span><br><span class="line">  resave: <span class="literal">false</span>,</span><br><span class="line">  saveUninitialized: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/todos&#x27;</span>, todoController.newTodo)</span><br><span class="line">app.get(<span class="string">&#x27;/todos&#x27;</span>, todoController.getAll)</span><br><span class="line">app.get(<span class="string">&#x27;/todos/:id&#x27;</span>, todoController.get)</span><br><span class="line"><span class="comment">// add add todo</span></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, todoController.addTodo)</span><br><span class="line"><span class="comment">// login</span></span><br><span class="line">app.get(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span>&#123;</span><br><span class="line">	res.render(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.post(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (req.body.password === <span class="string">&#x27;abc&#x27;</span>) &#123;</span><br><span class="line">		req.session.isLogin = <span class="literal">true</span></span><br><span class="line">		res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		res.redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// logout</span></span><br><span class="line">app.get(<span class="string">&#x27;/logout&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	req.session.isLogin = <span class="literal">false</span></span><br><span class="line">	res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// add todo db</span></span><br><span class="line">	db.connect()</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./controllers/todo.js</span></span><br><span class="line"><span class="keyword">const</span> todoModel = <span class="built_in">require</span>(<span class="string">&#x27;../models/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = &#123;</span><br><span class="line">	getAll: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		todoModel.getAll(<span class="function">(<span class="params">err,results</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.render(<span class="string">&#x27;todos&#x27;</span>, &#123;</span><br><span class="line">				todos : results</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> id = req.params.id</span><br><span class="line">		todoModel.get(id, <span class="function">(<span class="params">err,results</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.render(<span class="string">&#x27;todo&#x27;</span>, &#123;</span><br><span class="line">				todo : results</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	addTodo: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		res.render(<span class="string">&#x27;addTodo&#x27;</span>, &#123;</span><br><span class="line">			isLogin: req.session.isLogin</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	newTodo:  <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="comment">// get body data</span></span><br><span class="line">		<span class="keyword">const</span> content = req.body.content</span><br><span class="line">		todoModel.add(content, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.redirect(<span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoController</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./modules/todo.js</span></span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;../db&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todos = [</span><br><span class="line">	<span class="string">&#x27;first todo&#x27;</span>, <span class="string">&#x27;second todo&#x27;</span>, <span class="string">&#x27;third todo&#x27;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> todoModel = &#123;</span><br><span class="line">	getAll: <span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;SELECT * FROM todos&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">			cb(<span class="literal">null</span>, results)</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">id,cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;SELECT * FROM todos WHERE id=?&#x27;</span>, [id], </span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">				cb(<span class="literal">null</span>, results)</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125;,</span><br><span class="line">	add: <span class="function">(<span class="params">content, cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;INSERT INTO todos(content) VALUES(?)&#x27;</span>, [content], </span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">				<span class="comment">// console.log(results)</span></span><br><span class="line">				cb(<span class="literal">null</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoModel</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/todos.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Todos<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>add todo<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">	&lt;% for(let i=0 ; i<span class="tag">&lt;<span class="name">todos.length</span> ; <span class="attr">i</span>++) &#123; %&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- &lt; % = 表要輸出 --&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- &lt;li&gt;&lt;%= todos[i].id %&gt;: &lt;%= todos[i].content %&gt;&lt;/li&gt; --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">li</span>&gt;</span>&lt;%= todos[i].id + &#x27;: &#x27; + todos[i].content %&gt;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	&lt;% &#125; %&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/todo.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Todo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&lt;% if (todo.length &gt;0) &#123; %&gt;</span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span>&gt;</span>&lt;%= todo[0].content %&gt;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">&lt;% &#125; %&gt; </span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/addTodo.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>AddTodo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">&lt;% if(isLogin) &#123; %&gt;</span><br><span class="line">	你已登入	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/logout&quot;</span>&gt;</span>logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">&lt;% &#125; else &#123; %&gt;</span><br><span class="line">	你未登入 </span><br><span class="line">&lt;% &#125; %&gt; 	</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&#x27;POST&#x27;</span> <span class="attr">action</span>=<span class="string">&quot;/todos&quot;</span>&gt;</span></span><br><span class="line">	Content: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;content&#x27;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/login.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&#x27;POST&#x27;</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span>&gt;</span></span><br><span class="line">	Password: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;password&#x27;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="connect-flash"><a href="#connect-flash" class="headerlink" title="connect-flash"></a>connect-flash</h4><ul>
<li>connect-flash</li>
<li>add global variable - use middleware</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install</span></span><br><span class="line">npm install connect-flash</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="comment">// add express session</span></span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>)</span><br><span class="line"><span class="comment">// add connect flash</span></span><br><span class="line"><span class="keyword">const</span> flash = <span class="built_in">require</span>(<span class="string">&#x27;connect-flash&#x27;</span>)</span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;./db&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// set view engine type - directory is ./views</span></span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="comment">// parse application/x-www-form-urlencoded</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br><span class="line"><span class="comment">// parse application/json</span></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line"><span class="comment">// add connect flash</span></span><br><span class="line">app.use(flash())</span><br><span class="line"></span><br><span class="line"><span class="comment">// add express session</span></span><br><span class="line"><span class="comment">// app.set(&#x27;trust proxy&#x27;, 1) // if have proxy and using secure: tre, need run</span></span><br><span class="line"><span class="comment">// if https recommend set cookie: &#123; secure: true &#125;</span></span><br><span class="line"><span class="comment">// app.use(session(&#123;</span></span><br><span class="line"><span class="comment">// 	secret: &#x27;keyboard cat&#x27;,</span></span><br><span class="line"><span class="comment">// 	resave: false</span></span><br><span class="line"><span class="comment">// &#125;));</span></span><br><span class="line"><span class="comment">// app.use(session(&#123;</span></span><br><span class="line"><span class="comment">//   secret: &#x27;keyboard cat&#x27;,</span></span><br><span class="line"><span class="comment">//   resave: false,</span></span><br><span class="line"><span class="comment">//   saveUninitialized: true,</span></span><br><span class="line"><span class="comment">//   cookie: &#123; secure: true &#125;</span></span><br><span class="line"><span class="comment">// &#125;))</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret: <span class="string">&#x27;keyboard cat&#x27;</span>,</span><br><span class="line">  resave: <span class="literal">false</span>,</span><br><span class="line">  saveUninitialized: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// add global variable - use middleware</span></span><br><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">	res.locals.isLogin = req.session.isLogin</span><br><span class="line">	<span class="comment">// add connect flash</span></span><br><span class="line">	res.locals.errorMessage = req.flash(<span class="string">&#x27;errorMessage&#x27;</span>)</span><br><span class="line">	next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/todos&#x27;</span>, todoController.newTodo)</span><br><span class="line">app.get(<span class="string">&#x27;/todos&#x27;</span>, todoController.getAll)</span><br><span class="line">app.get(<span class="string">&#x27;/todos/:id&#x27;</span>, todoController.get)</span><br><span class="line"><span class="comment">// add add todo</span></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, todoController.addTodo)</span><br><span class="line"><span class="comment">// login</span></span><br><span class="line">app.get(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span>&#123;</span><br><span class="line">	res.render(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.post(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (req.body.password === <span class="string">&#x27;abc&#x27;</span>) &#123;</span><br><span class="line">		req.session.isLogin = <span class="literal">true</span></span><br><span class="line">		res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// add connect flash</span></span><br><span class="line">		req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;Please input the correct password.&#x27;</span>)</span><br><span class="line">		res.redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// logout</span></span><br><span class="line">app.get(<span class="string">&#x27;/logout&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	req.session.isLogin = <span class="literal">false</span></span><br><span class="line">	res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// add todo db</span></span><br><span class="line">	db.connect()</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./controllers/todo.js</span></span><br><span class="line"><span class="keyword">const</span> todoModel = <span class="built_in">require</span>(<span class="string">&#x27;../models/todo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = &#123;</span><br><span class="line">	getAll: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		todoModel.getAll(<span class="function">(<span class="params">err,results</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.render(<span class="string">&#x27;todos&#x27;</span>, &#123;</span><br><span class="line">				todos : results</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> id = req.params.id</span><br><span class="line">		todoModel.get(id, <span class="function">(<span class="params">err,results</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.render(<span class="string">&#x27;todo&#x27;</span>, &#123;</span><br><span class="line">				todo : results</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	addTodo: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		res.render(<span class="string">&#x27;addTodo&#x27;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	newTodo:  <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="comment">// get body data</span></span><br><span class="line">		<span class="keyword">const</span> content = req.body.content</span><br><span class="line">		todoModel.add(content, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="built_in">console</span>.log(err)</span><br><span class="line">			res.redirect(<span class="string">&#x27;/todos&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoController</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./modules/todo.js</span></span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;../db&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todos = [</span><br><span class="line">	<span class="string">&#x27;first todo&#x27;</span>, <span class="string">&#x27;second todo&#x27;</span>, <span class="string">&#x27;third todo&#x27;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> todoModel = &#123;</span><br><span class="line">	getAll: <span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;SELECT * FROM todos&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">			cb(<span class="literal">null</span>, results)</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">id,cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;SELECT * FROM todos WHERE id=?&#x27;</span>, [id], </span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">				cb(<span class="literal">null</span>, results)</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125;,</span><br><span class="line">	add: <span class="function">(<span class="params">content, cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;INSERT INTO todos(content) VALUES(?)&#x27;</span>, [content], </span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">				<span class="comment">// console.log(results)</span></span><br><span class="line">				cb(<span class="literal">null</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoModel</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/login.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&lt;%= errorMessage %&gt; <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&#x27;POST&#x27;</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span>&gt;</span></span><br><span class="line">	Password: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;password&#x27;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="簡易會員註冊系統"><a href="#簡易會員註冊系統" class="headerlink" title="簡易會員註冊系統"></a>簡易會員註冊系統</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># insatll bcrypt</span></span><br><span class="line">npm install bcrypt</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="comment">// add express session</span></span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>)</span><br><span class="line"><span class="comment">// add connect flash</span></span><br><span class="line"><span class="keyword">const</span> flash = <span class="built_in">require</span>(<span class="string">&#x27;connect-flash&#x27;</span>)</span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;./db&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/todo&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> userController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/user&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// set view engine type - directory is ./views</span></span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="comment">// parse application/x-www-form-urlencoded</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br><span class="line"><span class="comment">// parse application/json</span></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line"><span class="comment">// add connect flash</span></span><br><span class="line">app.use(flash())</span><br><span class="line"></span><br><span class="line"><span class="comment">// add express session</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret: <span class="string">&#x27;keyboard cat&#x27;</span>,</span><br><span class="line">  resave: <span class="literal">false</span>,</span><br><span class="line">  saveUninitialized: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// add global variable - use middleware</span></span><br><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">	res.locals.username = req.session.username</span><br><span class="line">	<span class="comment">// add connect flash</span></span><br><span class="line">	res.locals.errorMessage = req.flash(<span class="string">&#x27;errorMessage&#x27;</span>)</span><br><span class="line">	next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">redirectBack</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">	res.redirect(<span class="string">&#x27;back&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>,  <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">	res.render(<span class="string">&#x27;user/index&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.get(<span class="string">&#x27;/register&#x27;</span>, userController.register)</span><br><span class="line">app.post(<span class="string">&#x27;/register&#x27;</span>, userController.handleRegister, redirectBack)</span><br><span class="line">app.get(<span class="string">&#x27;/login&#x27;</span>, userController.login)</span><br><span class="line">app.post(<span class="string">&#x27;/login&#x27;</span>, userController.handleLogin, redirectBack)</span><br><span class="line">app.get(<span class="string">&#x27;/logout&#x27;</span>, userController.logout)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// add todo db</span></span><br><span class="line">	db.connect()</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./controllers/user.js</span></span><br><span class="line"><span class="keyword">const</span> userModel = <span class="built_in">require</span>(<span class="string">&#x27;../models/user&#x27;</span>)</span><br><span class="line"><span class="comment">// add bcrypt</span></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&#x27;bcrypt&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> saltRounds = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userController = &#123;</span><br><span class="line">	register: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		res.render(<span class="string">&#x27;user/register&#x27;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	handleRegister: <span class="function">(<span class="params">req, res , next</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> &#123;username, password, nickname&#125; = req.body</span><br><span class="line">		<span class="keyword">if</span> (!username || !password || !nickname) &#123;</span><br><span class="line">			req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;缺少必要欄位!&#x27;</span>)</span><br><span class="line">			<span class="keyword">return</span> next() </span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		bcrypt.genSalt(saltRounds, <span class="function"><span class="keyword">function</span>(<span class="params">err, salt</span>) </span>&#123;</span><br><span class="line">			bcrypt.hash(password, salt, <span class="function"><span class="keyword">function</span>(<span class="params">err, hash</span>) </span>&#123;</span><br><span class="line">					<span class="keyword">if</span> (err) &#123;</span><br><span class="line">						req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, err.toString())</span><br><span class="line">						<span class="keyword">return</span> next() </span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					userModel.add(&#123;</span><br><span class="line">						username,</span><br><span class="line">						nickname,</span><br><span class="line">						password: hash</span><br><span class="line">					&#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">						<span class="keyword">if</span> (err) &#123;</span><br><span class="line">							req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, err.toString())</span><br><span class="line">							<span class="keyword">return</span> next() </span><br><span class="line">						&#125;</span><br><span class="line">						req.session.username = username</span><br><span class="line">						res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">					&#125;)</span><br><span class="line">			&#125;);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	&#125;,</span><br><span class="line">	login: <span class="function">(<span class="params">req, res </span>) =&gt;</span> &#123;</span><br><span class="line">		res.render(<span class="string">&#x27;user/login&#x27;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	handleLogin: <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> &#123;username, password&#125; = req.body</span><br><span class="line">			<span class="keyword">if</span> (!username || !password) &#123;</span><br><span class="line">				req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;該填未填!&#x27;</span>)</span><br><span class="line">				<span class="keyword">return</span> next()</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			userModel.get(username, <span class="function">(<span class="params">err, user</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) &#123;</span><br><span class="line">				req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, err.toString())</span><br><span class="line">				<span class="keyword">return</span> next()		</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!user) &#123;</span><br><span class="line">				req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;無此帳號!&#x27;</span>)</span><br><span class="line">				<span class="keyword">return</span> next()		</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			bcrypt.compare(password, user.password, <span class="function"><span class="keyword">function</span>(<span class="params">err, isSuccess</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (err || (!isSuccess)) &#123;</span><br><span class="line">					req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;密碼錯誤!&#x27;</span>)</span><br><span class="line">					<span class="keyword">return</span> next()		</span><br><span class="line">				&#125;</span><br><span class="line">				req.session.username = user.username </span><br><span class="line">				res.redirect(<span class="string">&#x27;/&#x27;</span>)		</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	logout: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		req.session.username = <span class="literal">null</span></span><br><span class="line">		res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = userController</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./modules/user.js</span></span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;../db&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todos = [</span><br><span class="line">	<span class="string">&#x27;first todo&#x27;</span>, <span class="string">&#x27;second todo&#x27;</span>, <span class="string">&#x27;third todo&#x27;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">const</span> userModel = &#123;</span><br><span class="line">	add: <span class="function">(<span class="params">user, cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;INSERT INTO users(username, password, nickname) VALUES(?, ?, ?)&#x27;</span>,</span><br><span class="line">		 	[user.username, user.password, user.nickname], </span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">				cb(<span class="literal">null</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">username,cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;SELECT * FROM users WHERE username=?&#x27;</span>, [username], </span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">				cb(<span class="literal">null</span>, results[<span class="number">0</span>])</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	&#125;,</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = userModel</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/user/index.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>簡易會員系統<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;% if (username) &#123; %&gt; </span><br><span class="line">	hello, &lt;%= username %&gt; <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 可執行 HTML --&gt;</span></span><br><span class="line">	hello, &lt;%- username %&gt; <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/logout&quot;</span>&gt;</span>登出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">&lt;% &#125; else &#123; %&gt; </span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>註冊<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/login&quot;</span>&gt;</span>登入<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">&lt;% &#125; %&gt; </span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/user/register.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>註冊頁面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&lt;%= errorMessage %&gt; <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&#x27;POST&#x27;</span> <span class="attr">action</span>=<span class="string">&quot;/register&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span>username: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;textd&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;username&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span>password: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;password&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span>nickname: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;nickname&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/user/login.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>登入頁面<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&lt;%= errorMessage %&gt; <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&#x27;POST&#x27;</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span>username: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;textd&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;username&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span>password: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;password&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="簡易留言板"><a href="#簡易留言板" class="headerlink" title="簡易留言板"></a>簡易留言板</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="comment">// add express session</span></span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>)</span><br><span class="line"><span class="comment">// add connect flash</span></span><br><span class="line"><span class="keyword">const</span> flash = <span class="built_in">require</span>(<span class="string">&#x27;connect-flash&#x27;</span>)</span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;./db&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/todo&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> userController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/user&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> commentController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/comment&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// set view engine type - directory is ./views</span></span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="comment">// parse application/x-www-form-urlencoded</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br><span class="line"><span class="comment">// parse application/json</span></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line"><span class="comment">// add connect flash</span></span><br><span class="line">app.use(flash())</span><br><span class="line"></span><br><span class="line"><span class="comment">// add express session</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret: <span class="string">&#x27;keyboard cat&#x27;</span>,</span><br><span class="line">  resave: <span class="literal">false</span>,</span><br><span class="line">  saveUninitialized: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// add global variable - use middleware</span></span><br><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">	res.locals.username = req.session.username</span><br><span class="line">	<span class="comment">// add connect flash</span></span><br><span class="line">	res.locals.errorMessage = req.flash(<span class="string">&#x27;errorMessage&#x27;</span>)</span><br><span class="line">	next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">redirectBack</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">	res.redirect(<span class="string">&#x27;back&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, commentController.index) </span><br><span class="line">app.get(<span class="string">&#x27;/register&#x27;</span>, userController.register)</span><br><span class="line">app.post(<span class="string">&#x27;/register&#x27;</span>, userController.handleRegister, redirectBack)</span><br><span class="line">app.get(<span class="string">&#x27;/login&#x27;</span>, userController.login)</span><br><span class="line">app.post(<span class="string">&#x27;/login&#x27;</span>, userController.handleLogin, redirectBack)</span><br><span class="line">app.get(<span class="string">&#x27;/logout&#x27;</span>, userController.logout)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/comments&#x27;</span>, commentController.add)</span><br><span class="line">app.get(<span class="string">&#x27;/comments_delete/:id&#x27;</span>, commentController.delete)</span><br><span class="line">app.get(<span class="string">&#x27;/comments_update/:id&#x27;</span>, commentController.update)</span><br><span class="line">app.post(<span class="string">&#x27;/comments_update/:id&#x27;</span>, commentController.handelUpdate)</span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="comment">// add todo db</span></span><br><span class="line">	db.connect()</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./controllers/comment.js</span></span><br><span class="line"><span class="keyword">const</span> commentModel = <span class="built_in">require</span>(<span class="string">&#x27;../models/comment&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commentController = &#123;</span><br><span class="line">	add:  <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="comment">// get body data</span></span><br><span class="line">		<span class="keyword">const</span> &#123;username&#125; = req.session</span><br><span class="line">		<span class="keyword">const</span> &#123;content&#125; = req.body</span><br><span class="line">		<span class="keyword">if</span> (!username || !content ) &#123;</span><br><span class="line">			req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;請輸入完整內容!&#x27;</span>)</span><br><span class="line">			<span class="keyword">return</span> res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		commentModel.add(username, content, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, err.toString())</span><br><span class="line">			res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	index: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		commentModel.getAll(<span class="function">(<span class="params">err, results</span>) =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (err) &#123;</span><br><span class="line">				req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, err.toString())</span><br><span class="line">			&#125;</span><br><span class="line">			res.render(<span class="string">&#x27;user/index&#x27;</span>, &#123;</span><br><span class="line">				comments: results</span><br><span class="line">			&#125; )</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="keyword">delete</span>: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		commentModel.delete(req.session.username, req.params.id, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">			res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	update: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		commentModel.get(req.params.id, <span class="function">(<span class="params">err, result</span>) =&gt;</span> &#123;</span><br><span class="line">			res.render(<span class="string">&#x27;user/update&#x27;</span>,&#123;</span><br><span class="line">				comment: result</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	handelUpdate: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		commentModel.update(req.session.username, req.params.id, req.body.content, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">			res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = commentController</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./modules/comment.js</span></span><br><span class="line"><span class="comment">// add todo db</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;../db&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoModel = &#123;</span><br><span class="line">	add: <span class="function">(<span class="params">username, content, cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(<span class="string">&#x27;INSERT INTO comments(username, content) VALUES(?, ?)&#x27;</span>, </span><br><span class="line">			[username ,content], </span><br><span class="line">			<span class="function"><span class="keyword">function</span> (<span class="params">error, results</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (error) <span class="keyword">return</span> cb(error)</span><br><span class="line">				cb(<span class="literal">null</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		)</span><br><span class="line">	&#125;,</span><br><span class="line">	getAll: <span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(</span><br><span class="line">			<span class="string">`SELECT U.nickname, C.content, C.id, U.username</span></span><br><span class="line"><span class="string">			FROM comments AS C LEFT JOIN users as U </span></span><br><span class="line"><span class="string">			on U.username = C.username ORDER BY C.id DESC`</span>,</span><br><span class="line">			(err, results) =&gt; &#123;</span><br><span class="line">				<span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err)</span><br><span class="line">				cb(<span class="literal">null</span>, results)</span><br><span class="line">			&#125;</span><br><span class="line">		)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="keyword">delete</span>: <span class="function">(<span class="params">username, id, cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(</span><br><span class="line">			<span class="string">`DELETE FROM comments WHERE id=? AND username=?`</span>, [id, username], </span><br><span class="line">			(err, results) =&gt; &#123;</span><br><span class="line">				<span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err)</span><br><span class="line">				cb(<span class="literal">null</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		)		</span><br><span class="line">	&#125;,</span><br><span class="line">	get: <span class="function">(<span class="params">id, cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(</span><br><span class="line">			<span class="string">`SELECT U.nickname, C.content, C.id, U.username</span></span><br><span class="line"><span class="string">			FROM comments AS C LEFT JOIN users as U </span></span><br><span class="line"><span class="string">			on U.username = C.username WHERE C.id=?`</span>, [id],</span><br><span class="line">			(err, results) =&gt; &#123;</span><br><span class="line">				<span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err)</span><br><span class="line">				cb(<span class="literal">null</span>, results[<span class="number">0</span>] || &#123;&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">		)</span><br><span class="line">	&#125;,</span><br><span class="line">	update: <span class="function">(<span class="params">username, id, content, cb</span>) =&gt;</span> &#123;</span><br><span class="line">		db.query(</span><br><span class="line">			<span class="string">`UPDATE comments SET content=? WHERE id=? AND username=?`</span>, </span><br><span class="line">			[content , id, username], </span><br><span class="line">			(err, results) =&gt; &#123;</span><br><span class="line">				<span class="keyword">if</span> (err) <span class="keyword">return</span> cb(err)</span><br><span class="line">				cb(<span class="literal">null</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		)		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = todoModel</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/user/index.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>簡易會員系統<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>&lt;%= errorMessage %&gt; <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;% if (username) &#123; %&gt; </span><br><span class="line">	hello, &lt;%= username %&gt; </span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/logout&quot;</span>&gt;</span>登出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/comments&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;content&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;% &#125; else &#123; %&gt; </span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>註冊<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/login&quot;</span>&gt;</span>登入<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">&lt;% &#125; %&gt; </span><br><span class="line"></span><br><span class="line">&lt;% comments.forEach( function(comment) &#123; %&gt; </span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span>&gt;</span>&lt;%= comment.nickname %&gt; </span><br><span class="line">		&lt;% if (username == comment.username) &#123; %&gt;</span><br><span class="line">			<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/comments_delete/&lt;%= comment.id %&gt;&quot;</span>&gt;</span>刪除<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/comments_update/&lt;%= comment.id %&gt;&quot;</span>&gt;</span>修改<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">		&lt;% &#125; %&gt; </span><br><span class="line">	<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">p</span>&gt;</span>&lt;%= comment.content %&gt; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&lt;% &#125;) %&gt; </span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/user/update.ejs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>編輯留言<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/comments_update/&lt;%= comment.id%&gt;&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;content&quot;</span>&gt;</span>&lt;%= comment.content %&gt; <span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="ORM-與-Sequelize"><a href="#ORM-與-Sequelize" class="headerlink" title="ORM 與 Sequelize"></a>ORM 與 Sequelize</h3><p>ORM : Object Relational Mapping</p>
<h4 id="Sequelize-基本操作"><a href="#Sequelize-基本操作" class="headerlink" title="Sequelize 基本操作"></a>Sequelize 基本操作</h4><h5 id="insatll-sequelize"><a href="#insatll-sequelize" class="headerlink" title="insatll sequelize"></a>insatll sequelize</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install sequelize</span><br></pre></td></tr></table></figure>

<h5 id="link-DB-and-create-table’s-item"><a href="#link-DB-and-create-table’s-item" class="headerlink" title="link DB and create table’s item"></a>link DB and create table’s item</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Sequelize = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"><span class="comment">// set db configuration</span></span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> Sequelize(<span class="string">&#x27;mydb&#x27;</span>, <span class="string">&#x27;robert&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, &#123;</span><br><span class="line">	host: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">	dialect: <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 驗證 DB </span></span><br><span class="line">sequelize</span><br><span class="line">	.authenticate()</span><br><span class="line">	.then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;Connection has been established successfully.&#x27;</span>);</span><br><span class="line">	&#125;)</span><br><span class="line">	.catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.error(<span class="string">&#x27;Unable to connect to the database:&#x27;</span>, err);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// define table field</span></span><br><span class="line"><span class="keyword">const</span> User = sequelize.define(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">	firstName: &#123;</span><br><span class="line">		type: Sequelize.STRING,</span><br><span class="line">		allowNull: <span class="literal">false</span></span><br><span class="line">	&#125;,</span><br><span class="line">	lastName: &#123;</span><br><span class="line">		type: Sequelize.STRING</span><br><span class="line">	&#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	<span class="comment">// timestamps: false,			// 關掉產生 timestamp 欄位</span></span><br><span class="line">	<span class="comment">// freezeTableName: true,	// 關掉 自動複數檔案名</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// create tabel item</span></span><br><span class="line">sequelize.sync().then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">	User.create(&#123;</span><br><span class="line">		firstName: <span class="string">&#x27;Bill&#x27;</span>,</span><br><span class="line">		lastName: <span class="string">&#x27;Chen&#x27;</span></span><br><span class="line">	&#125;).then (<span class="function">() =&gt;</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;created!&#x27;</span>)</span><br><span class="line">	&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err.toString())	</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="get-x2F-modify-x2F-delete-table-item"><a href="#get-x2F-modify-x2F-delete-table-item" class="headerlink" title="get&#x2F;modify&#x2F;delete table item"></a>get&#x2F;modify&#x2F;delete table item</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create tabel item</span></span><br><span class="line">sequelize.sync().then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">	User.create(&#123;</span><br><span class="line">		firstName: <span class="string">&#x27;Bill&#x27;</span>,</span><br><span class="line">		lastName: <span class="string">&#x27;Chen&#x27;</span></span><br><span class="line">	&#125;).then (<span class="function">() =&gt;</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;created!&#x27;</span>)</span><br><span class="line">	&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err.toString())	</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// get tabel all item </span></span><br><span class="line">sequelize.sync().then(<span class="function">() =&gt;</span>&#123;</span><br><span class="line">	User.findAll().then( <span class="function"><span class="params">users</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;All user:&quot;</span>, <span class="built_in">JSON</span>.stringify(users,<span class="literal">null</span>,<span class="number">4</span>))</span><br><span class="line">	&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err.toString())	</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// get table condition item</span></span><br><span class="line">sequelize.sync().then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">	User.findAll(&#123;</span><br><span class="line">		where: &#123;</span><br><span class="line">			firstName: <span class="string">&#x27;Bill2&#x27;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;).then( <span class="function"><span class="params">users</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(users[<span class="number">0</span>].id, users[<span class="number">0</span>].firstName)</span><br><span class="line">	&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err.toString())	</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// get table one item</span></span><br><span class="line">sequelize.sync().then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">	User.findOne(&#123;</span><br><span class="line">		where: &#123;</span><br><span class="line">			firstName: <span class="string">&#x27;Bill2&#x27;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;).then( <span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(user.id, user.firstName)</span><br><span class="line">	&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err.toString())	</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// update table&#x27;s item </span></span><br><span class="line">sequelize.sync().then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">	User.findOne(&#123;</span><br><span class="line">		where: &#123;</span><br><span class="line">			firstName: <span class="string">&#x27;Bill2&#x27;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;).then( <span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">		user.update(&#123;</span><br><span class="line">			lastName: <span class="string">&#x27;aaa&#x27;</span></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;done&#x27;</span>)	</span><br><span class="line">	&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err.toString())	</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// detelet table&#x27;s item </span></span><br><span class="line">sequelize.sync().then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">	User.findOne(&#123;</span><br><span class="line">		where: &#123;</span><br><span class="line">			firstName: <span class="string">&#x27;Bill2&#x27;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;).then( <span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">		user.destroy()</span><br><span class="line">	&#125;).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;done&#x27;</span>)	</span><br><span class="line">	&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err.toString())	</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="related-db-control"><a href="#related-db-control" class="headerlink" title="related db control"></a>related db control</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// define another table field</span></span><br><span class="line"><span class="keyword">const</span> Comment = sequelize.define(<span class="string">&#x27;comment&#x27;</span>, &#123;</span><br><span class="line">	content: &#123;</span><br><span class="line">		type: Sequelize.STRING,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// set mapping to low level table</span></span><br><span class="line">User.hasMany(Comment)</span><br><span class="line"></span><br><span class="line"><span class="comment">// create low level table item</span></span><br><span class="line">sequelize.sync().then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">	Comment.create(&#123;</span><br><span class="line">		userId:<span class="number">3</span>,</span><br><span class="line">		content: <span class="string">&#x27;Hi&#x27;</span></span><br><span class="line">	&#125;).then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;done&#x27;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// set mapping to up level table</span></span><br><span class="line">Comment.belongsTo(User)</span><br><span class="line"><span class="comment">// get low level item (include up level item)</span></span><br><span class="line">sequelize.sync().then(<span class="function">() =&gt;</span>&#123;</span><br><span class="line">	Comment.findOne(&#123;</span><br><span class="line">		where: &#123;</span><br><span class="line">			content: <span class="string">&#x27;hello&#x27;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		include: User</span><br><span class="line">	&#125;).then(<span class="function"><span class="params">comment</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(comment, <span class="literal">null</span>, <span class="number">4</span>)) <span class="comment">// 排列較易閱讀</span></span><br><span class="line">		<span class="built_in">console</span>.log(comment.id, comment.content)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">// get up level item (include low level item)</span></span><br><span class="line">sequelize.sync().then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">	User.findOne(&#123;</span><br><span class="line">		where: &#123;</span><br><span class="line">			firstName: <span class="string">&#x27;Bill&#x27;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		include: Comment</span><br><span class="line">	&#125;).then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(user.comments, <span class="literal">null</span>, <span class="number">4</span>)) <span class="comment">// 排列較易閱讀</span></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="Sequelize-CLI"><a href="#Sequelize-CLI" class="headerlink" title="Sequelize CLI"></a>Sequelize CLI</h4><h5 id="install-sequelize-cli"><a href="#install-sequelize-cli" class="headerlink" title="install sequelize-cli"></a>install sequelize-cli</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install </span></span><br><span class="line">npm install sequelize-cli</span><br></pre></td></tr></table></figure>

<h5 id="init-sequeliz"><a href="#init-sequeliz" class="headerlink" title="init sequeliz"></a>init sequeliz</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># init sequeliz</span></span><br><span class="line">npx sequelize-cli init</span><br></pre></td></tr></table></figure>

<p>config&#x2F;config.json<br>change db configuration</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;development&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;robert&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;database&quot;</span>: <span class="string">&quot;mydb2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;host&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dialect&quot;</span>: <span class="string">&quot;mysql&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;test&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;password&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;database&quot;</span>: <span class="string">&quot;database_test&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;host&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dialect&quot;</span>: <span class="string">&quot;mysql&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;production&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;password&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;database&quot;</span>: <span class="string">&quot;database_production&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;host&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dialect&quot;</span>: <span class="string">&quot;mysql&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="create-model"><a href="#create-model" class="headerlink" title="create model"></a>create model</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># npx sequelize-cli model:generate --name User --attributes firstName:string,lastName:string,email:string</span></span><br><span class="line"><span class="comment"># add field user_level:integer</span></span><br><span class="line"><span class="comment"># npx sequelize-cli model:generate --name User --attributes username:string,password:string,nickname:string,user_level:integer</span></span><br><span class="line"><span class="comment"># npx sequelize-cli model:generate --name Comment --attributes content:string</span></span><br><span class="line"><span class="comment"># 欄位加滿,不然有時會有問題</span></span><br><span class="line">npx sequelize-cli model:generate --name User --attributes username:string,password:string,nickname:string,user_level:<span class="built_in">integer</span></span><br><span class="line">npx sequelize-cli model:generate --name Comment --attributes content:text,UserId:<span class="built_in">integer</span></span><br></pre></td></tr></table></figure>

<h5 id="migrate-generate-db-table"><a href="#migrate-generate-db-table" class="headerlink" title="migrate (generate db table)"></a>migrate (generate db table)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 產生 table sequelizemeta, 存執行 log</span></span><br><span class="line">npx sequelize-cli db:migrate</span><br><span class="line"><span class="comment"># if env is test </span></span><br><span class="line"><span class="comment"># npx sequelize-cli db:migrate --env test</span></span><br></pre></td></tr></table></figure>

<h5 id="為-model-加上關聯"><a href="#為-model-加上關聯" class="headerlink" title="為 model 加上關聯"></a>為 model 加上關聯</h5><p>.&#x2F;models&#x2F;user.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  Model</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">sequelize, DataTypes</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Helper method for defining associations.</span></span><br><span class="line"><span class="comment">     * This method is not a part of Sequelize lifecycle.</span></span><br><span class="line"><span class="comment">     * The `models/index` file will call this method automatically.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">associate</span>(<span class="params">models</span>)</span> &#123;</span><br><span class="line">			<span class="comment">// 加上關聯設定</span></span><br><span class="line">			User.hasMany(models.Comment)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  User.init(&#123;</span><br><span class="line">    firstName: DataTypes.STRING,</span><br><span class="line">    lastName: DataTypes.STRING,</span><br><span class="line">    email: DataTypes.STRING</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    sequelize,</span><br><span class="line">    modelName: <span class="string">&#x27;User&#x27;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> User;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>.&#x2F;models&#x2F;comment.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  Model</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">sequelize, DataTypes</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Helper method for defining associations.</span></span><br><span class="line"><span class="comment">     * This method is not a part of Sequelize lifecycle.</span></span><br><span class="line"><span class="comment">     * The `models/index` file will call this method automatically.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">associate</span>(<span class="params">models</span>)</span> &#123;</span><br><span class="line">			<span class="comment">// 加上關聯設定</span></span><br><span class="line">			Comment.belongsTo(models.User)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  Comment.init(&#123;</span><br><span class="line">    content: DataTypes.STRING</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    sequelize,</span><br><span class="line">    modelName: <span class="string">&#x27;Comment&#x27;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> Comment;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="create-table-item"><a href="#create-table-item" class="headerlink" title="create table item"></a>create table item</h5><p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;./models&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> User = db.User</span><br><span class="line"><span class="keyword">const</span> Comment = db.Comment</span><br><span class="line"></span><br><span class="line">User.create(&#123;</span><br><span class="line">	firstName: <span class="string">&#x27;Bill&#x27;</span>,</span><br><span class="line">	lastName: <span class="string">&#x27;Chen&#x27;</span></span><br><span class="line">&#125;).then(<span class="function">() =&gt;</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;done!&#x27;</span>)</span><br><span class="line">&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(err.toString())	</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="改造留言板"><a href="#改造留言板" class="headerlink" title="改造留言板"></a>改造留言板</h4><h5 id="data-操作"><a href="#data-操作" class="headerlink" title="data 操作"></a>data 操作</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 ejs 可直接使用</span></span><br><span class="line">res.locals.isLogin = req.session.isLogin</span><br><span class="line">res.locals.errorMessage = req.flash(<span class="string">&#x27;errorMessage&#x27;</span>)</span><br><span class="line"><span class="comment">// get 傳入參數</span></span><br><span class="line">id: req.params.id,</span><br><span class="line"><span class="comment">// post 傳入參數</span></span><br><span class="line"><span class="keyword">const</span> &#123;	content &#125; = req.body</span><br><span class="line"><span class="comment">// session 參數</span></span><br><span class="line"><span class="keyword">const</span> &#123;	username,	userId&#125; = req.session</span><br><span class="line"><span class="comment">// flash</span></span><br><span class="line">req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;請輸入完整內容!&#x27;</span>)</span><br><span class="line">res.locals.errorMessage = req.flash(<span class="string">&#x27;errorMessage&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// migration - set field unique</span></span><br><span class="line">username: &#123;</span><br><span class="line">	type: Sequelize.STRING,</span><br><span class="line">	unique: <span class="literal">true</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// migration - add field</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="comment">// add UserId</span></span><br><span class="line">UserId: &#123;</span><br><span class="line">  type: Sequelize.INTEGER</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// controller - findAll add order </span></span><br><span class="line">Comment.findAll(&#123;</span><br><span class="line">	include: User,</span><br><span class="line">	<span class="comment">// 加入 order</span></span><br><span class="line">	order: [</span><br><span class="line">		[<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>]</span><br><span class="line">	]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// model 加上關聯</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Helper method for defining associations.</span></span><br><span class="line"><span class="comment">    * This method is not a part of Sequelize lifecycle.</span></span><br><span class="line"><span class="comment">    * The `models/index` file will call this method automatically.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">associate</span>(<span class="params">models</span>)</span> &#123;</span><br><span class="line">     <span class="comment">// 加上關聯設定</span></span><br><span class="line">		User.hasMany(models.Comment)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Helper method for defining associations.</span></span><br><span class="line"><span class="comment">    * This method is not a part of Sequelize lifecycle.</span></span><br><span class="line"><span class="comment">    * The `models/index` file will call this method automatically.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="title">associate</span>(<span class="params">models</span>)</span> &#123;</span><br><span class="line">		<span class="comment">// 加上關聯設定</span></span><br><span class="line">		Comment.belongsTo(models.User)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="install-and-create-DB-migrate"><a href="#install-and-create-DB-migrate" class="headerlink" title="install and create DB(migrate)"></a>install and create DB(migrate)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install</span></span><br><span class="line">npm install sequelize</span><br><span class="line">npm install sequelize-cli</span><br><span class="line">npm install mysql2</span><br><span class="line"><span class="comment"># init</span></span><br><span class="line">npx sequelize-cli init</span><br><span class="line"><span class="comment"># create model</span></span><br><span class="line"><span class="comment"># npx sequelize-cli model:generate --name User --attributes username:string,password:string,nickname:string</span></span><br><span class="line"><span class="comment"># npx sequelize-cli model:generate --name Comment --attributes content:text</span></span><br><span class="line"><span class="comment"># 欄位加滿,不然有時會有問題</span></span><br><span class="line">npx sequelize-cli model:generate --name User --attributes username:string,password:string,nickname:string,user_level:<span class="built_in">integer</span></span><br><span class="line">npx sequelize-cli model:generate --name Comment --attributes content:text,UserId:<span class="built_in">integer</span></span><br><span class="line"><span class="comment"># migrate </span></span><br><span class="line">npx sequelize-cli db:migrate</span><br></pre></td></tr></table></figure>

<h5 id="add-user-id-for-comment"><a href="#add-user-id-for-comment" class="headerlink" title="add user id for comment"></a>add user id for comment</h5><p>.&#x2F;migrations&#x2F;xxx-create-comment.js 加 user id</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  up: <span class="keyword">async</span> (queryInterface, Sequelize) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> queryInterface.createTable(<span class="string">&#x27;Comments&#x27;</span>, &#123;</span><br><span class="line">      id: &#123;</span><br><span class="line">        allowNull: <span class="literal">false</span>,</span><br><span class="line">        autoIncrement: <span class="literal">true</span>,</span><br><span class="line">        primaryKey: <span class="literal">true</span>,</span><br><span class="line">        type: Sequelize.INTEGER</span><br><span class="line">      &#125;,</span><br><span class="line">      content: &#123;</span><br><span class="line">        type: Sequelize.TEXT</span><br><span class="line">			&#125;,</span><br><span class="line">			<span class="comment">// add UserId</span></span><br><span class="line">			UserId: &#123;</span><br><span class="line">        type: Sequelize.INTEGER</span><br><span class="line">      &#125;,</span><br><span class="line">      createdAt: &#123;</span><br><span class="line">        allowNull: <span class="literal">false</span>,</span><br><span class="line">        type: Sequelize.DATE</span><br><span class="line">      &#125;,</span><br><span class="line">      updatedAt: &#123;</span><br><span class="line">        allowNull: <span class="literal">false</span>,</span><br><span class="line">        type: Sequelize.DATE</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  down: <span class="keyword">async</span> (queryInterface, Sequelize) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> queryInterface.dropTable(<span class="string">&#x27;Comments&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="set-username-unique"><a href="#set-username-unique" class="headerlink" title="set username unique"></a>set username unique</h5><p>.&#x2F;migrations&#x2F;xxx-create-comment.js set username unique</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username: &#123;</span><br><span class="line">	type: Sequelize.STRING,</span><br><span class="line">	unique: <span class="literal">true</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h5 id="撤銷migrate-then-migrate"><a href="#撤銷migrate-then-migrate" class="headerlink" title="撤銷migrate then migrate"></a>撤銷migrate then migrate</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 撤銷 上一次</span></span><br><span class="line">npx sequelize-cli db:migrate:undo</span><br><span class="line"><span class="comment"># 撤銷所有</span></span><br><span class="line">npx sequelize-cli db:migrate:undo:all</span><br><span class="line"><span class="comment"># migrate </span></span><br><span class="line">npx sequelize-cli db:migrate</span><br></pre></td></tr></table></figure>

<h5 id="model-加上關聯"><a href="#model-加上關聯" class="headerlink" title="model 加上關聯"></a>model 加上關聯</h5><p>.&#x2F;model&#x2F;user.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  Model</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">sequelize, DataTypes</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Helper method for defining associations.</span></span><br><span class="line"><span class="comment">     * This method is not a part of Sequelize lifecycle.</span></span><br><span class="line"><span class="comment">     * The `models/index` file will call this method automatically.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">associate</span>(<span class="params">models</span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 加上關聯設定</span></span><br><span class="line">			User.hasMany(models.Comment)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  User.init(&#123;</span><br><span class="line">    username: DataTypes.STRING,</span><br><span class="line">    password: DataTypes.STRING,</span><br><span class="line">    nickname: DataTypes.STRING</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    sequelize,</span><br><span class="line">    modelName: <span class="string">&#x27;User&#x27;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure>

<p>.&#x2F;model&#x2F;comment.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">  Model</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">sequelize, DataTypes</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Helper method for defining associations.</span></span><br><span class="line"><span class="comment">     * This method is not a part of Sequelize lifecycle.</span></span><br><span class="line"><span class="comment">     * The `models/index` file will call this method automatically.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">associate</span>(<span class="params">models</span>)</span> &#123;</span><br><span class="line">			<span class="comment">// 加上關聯設定</span></span><br><span class="line">			Comment.belongsTo(models.User)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  Comment.init(&#123;</span><br><span class="line">    content: DataTypes.TEXT</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    sequelize,</span><br><span class="line">    modelName: <span class="string">&#x27;Comment&#x27;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> Comment;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="comment">// add express session</span></span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>)</span><br><span class="line"><span class="comment">// add connect flash</span></span><br><span class="line"><span class="keyword">const</span> flash = <span class="built_in">require</span>(<span class="string">&#x27;connect-flash&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/user&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> commentController = <span class="built_in">require</span>(<span class="string">&#x27;./controllers/comment&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// set view engine type - directory is ./views</span></span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// add body parser</span></span><br><span class="line"><span class="comment">// parse application/x-www-form-urlencoded</span></span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;))</span><br><span class="line"><span class="comment">// parse application/json</span></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line"><span class="comment">// add connect flash</span></span><br><span class="line">app.use(flash())</span><br><span class="line"></span><br><span class="line"><span class="comment">// add express session</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret: <span class="string">&#x27;keyboard cat&#x27;</span>,</span><br><span class="line">  resave: <span class="literal">false</span>,</span><br><span class="line">  saveUninitialized: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// add global variable - use middleware</span></span><br><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">	res.locals.userId = req.session.userId</span><br><span class="line">	res.locals.username = req.session.username</span><br><span class="line">	<span class="comment">// add connect flash</span></span><br><span class="line">	res.locals.errorMessage = req.flash(<span class="string">&#x27;errorMessage&#x27;</span>)</span><br><span class="line">	next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">redirectBack</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">	res.redirect(<span class="string">&#x27;back&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, commentController.index) </span><br><span class="line">app.get(<span class="string">&#x27;/register&#x27;</span>, userController.register)</span><br><span class="line">app.post(<span class="string">&#x27;/register&#x27;</span>, userController.handleRegister, redirectBack)</span><br><span class="line">app.get(<span class="string">&#x27;/login&#x27;</span>, userController.login)</span><br><span class="line">app.post(<span class="string">&#x27;/login&#x27;</span>, userController.handleLogin, redirectBack)</span><br><span class="line">app.get(<span class="string">&#x27;/logout&#x27;</span>, userController.logout)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/comments&#x27;</span>, commentController.add)</span><br><span class="line">app.get(<span class="string">&#x27;/comments_delete/:id&#x27;</span>, commentController.delete)</span><br><span class="line">app.get(<span class="string">&#x27;/comments_update/:id&#x27;</span>, commentController.update)</span><br><span class="line">app.post(<span class="string">&#x27;/comments_update/:id&#x27;</span>, commentController.handelUpdate)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.listen(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">`Example app listening at http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="view’s-template"><a href="#view’s-template" class="headerlink" title="view’s template"></a>view’s template</h5><p>template&#x2F;head.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Bootstrap CSS --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css&quot;</span> <span class="attr">integrity</span>=<span class="string">&quot;sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l&quot;</span> <span class="attr">crossorigin</span>=<span class="string">&quot;anonymous&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>template&#x2F;navbar.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">&quot;navbar navbar-expand-lg navbar-light bg-light mb-3&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-brand&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>留言板<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;navbar-toggler&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">data-toggle</span>=<span class="string">&quot;collapse&quot;</span> <span class="attr">data-target</span>=<span class="string">&quot;#navbarNavAltMarkup&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">aria-controls</span>=<span class="string">&quot;navbarNavAltMarkup&quot;</span> <span class="attr">aria-expanded</span>=<span class="string">&quot;false&quot;</span> <span class="attr">aria-label</span>=<span class="string">&quot;Toggle navigation&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;navbar-toggler-icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;collapse navbar-collapse justify-content-end&quot;</span> <span class="attr">id</span>=<span class="string">&quot;navbarNavAltMarkup&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-nav&quot;</span>&gt;</span></span><br><span class="line">			&lt;% if (userId) &#123; %&gt;</span><br><span class="line">			<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/logout&quot;</span>&gt;</span>登出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">			&lt;% &#125; else &#123; %&gt;</span><br><span class="line">			<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>註冊<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/login&quot;</span>&gt;</span>登入<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">			&lt;% &#125; %&gt;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="view"><a href="#view" class="headerlink" title="view"></a>view</h5><p>user&#x2F;index.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/user/index.ejs --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	&lt;%- include(&#x27;../template/head&#x27;) %&gt;</span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	&lt;%- include(&#x27;../template/navbar&#x27;) %&gt;</span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">			&lt;% if(errorMessage &amp;&amp; errorMessage.length &gt; 0) &#123;  %&gt; </span><br><span class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-danger&quot;</span> <span class="attr">role</span>=<span class="string">&quot;alert&quot;</span>&gt;</span></span><br><span class="line">					&lt;%= errorMessage %&gt;</span><br><span class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			&lt;% &#125; %&gt; </span><br><span class="line"></span><br><span class="line">		&lt;% if (userId) &#123; %&gt;</span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;h3&quot;</span>&gt;</span>hello, &lt;%= username %&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="tag">&lt;<span class="name">form</span>  <span class="attr">class</span>=<span class="string">&quot;mb-3&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/comments&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;content&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">		&lt;% &#125; %&gt;</span><br><span class="line"></span><br><span class="line">		&lt;% comments.forEach( function(comment) &#123; %&gt;</span><br><span class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card border-light mb-3&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card-header&quot;</span>&gt;</span></span><br><span class="line">					&lt;%= comment.User.nickname %&gt;</span><br><span class="line">					&lt;% if (userId == comment.UserId) &#123; %&gt;</span><br><span class="line">					<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/comments_delete/&lt;%= comment.id %&gt;&quot;</span>&gt;</span>刪除<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/comments_update/&lt;%= comment.id %&gt;&quot;</span>&gt;</span>修改<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">					&lt;% &#125; %&gt;</span><br><span class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card-body&quot;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;card-text&quot;</span>&gt;</span>&lt;%= comment.content %&gt;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			&lt;% &#125;) %&gt;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>user&#x2F;register.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/user/register.ejs --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	&lt;%- include(&#x27;../template/head&#x27;) %&gt; </span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	&lt;%- include(&#x27;../template/navbar&#x27;) %&gt; </span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">		&lt;% if(errorMessage &amp;&amp; errorMessage.length &gt; 0) &#123;  %&gt; </span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-danger&quot;</span> <span class="attr">role</span>=<span class="string">&quot;alert&quot;</span>&gt;</span></span><br><span class="line">				&lt;%= errorMessage %&gt;</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		&lt;% &#125; %&gt; </span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&#x27;POST&#x27;</span> <span class="attr">action</span>=<span class="string">&quot;/register&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group row&quot;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;inputUsername&quot;</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-2 col-form-label&quot;</span>&gt;</span>username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-10&quot;</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&quot; <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inputUsername&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;username&#x27;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group row&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;inputPassword&quot;</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-2 col-form-label&quot;</span>&gt;</span>password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-10&quot;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inputPassword&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;password&#x27;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group row&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;inputUsername&quot;</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-2 col-form-label&quot;</span>&gt;</span>nickname<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-10&quot;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&quot; <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inputUsername&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;nickname&#x27;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>註冊<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>user&#x2F;login.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/user/login.ejs --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	&lt;%- include(&#x27;../template/head&#x27;) %&gt; </span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	&lt;%- include(&#x27;../template/navbar&#x27;) %&gt; </span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">		&lt;% if(errorMessage &amp;&amp; errorMessage.length &gt; 0) &#123;  %&gt; </span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-danger&quot;</span> <span class="attr">role</span>=<span class="string">&quot;alert&quot;</span>&gt;</span></span><br><span class="line">				&lt;%= errorMessage %&gt;</span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">		&lt;% &#125; %&gt; </span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&#x27;POST&#x27;</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group row&quot;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;inputUsername&quot;</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-2 col-form-label&quot;</span>&gt;</span>username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-10&quot;</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&quot; <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inputUsername&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;username&#x27;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group row&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;inputPassword&quot;</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-2 col-form-label&quot;</span>&gt;</span>password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-sm-10&quot;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;inputPassword&quot;</span> <span class="attr">name</span>=<span class="string">&#x27;password&#x27;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>登入<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>user&#x2F;update.ejs</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ./views/user/update.ejs --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	&lt;%- include(&#x27;../template/head&#x27;) %&gt; </span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	&lt;%- include(&#x27;../template/navbar&#x27;) %&gt; </span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">form</span>  <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/comments_update/&lt;%= comment.id%&gt;&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;content&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;3&quot;</span>&gt;</span>&lt;%= comment.content %&gt;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="control"><a href="#control" class="headerlink" title="control"></a>control</h5><p>controllers&#x2F;user.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./controllers/user.js</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;../models&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> User = db.User</span><br><span class="line"><span class="comment">// add bcrypt</span></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&#x27;bcrypt&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> saltRounds = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userController = &#123;</span><br><span class="line">	register: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		res.render(<span class="string">&#x27;user/register&#x27;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	handleRegister: <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> &#123;	username,	password,	nickname&#125; = req.body</span><br><span class="line">		<span class="keyword">if</span> (!username || !password || !nickname) &#123;</span><br><span class="line">			req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;缺少必要欄位!&#x27;</span>)</span><br><span class="line">			<span class="keyword">return</span> next()</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		bcrypt.genSalt(saltRounds, <span class="function"><span class="keyword">function</span> (<span class="params">err, salt</span>) </span>&#123;</span><br><span class="line">			bcrypt.hash(password, salt, <span class="function"><span class="keyword">function</span> (<span class="params">err, hash</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (err) &#123;</span><br><span class="line">					req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, err.toString())</span><br><span class="line">					<span class="keyword">return</span> next()</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				User.create(&#123;</span><br><span class="line">					username: username,</span><br><span class="line">					nickname: nickname,</span><br><span class="line">					password: hash</span><br><span class="line">				&#125;).then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">					req.session.userId = user.id</span><br><span class="line">					req.session.username = user.username</span><br><span class="line">					res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">				&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">					req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, err.toString())</span><br><span class="line">					<span class="keyword">return</span> next()</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	&#125;,</span><br><span class="line">	login: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		res.render(<span class="string">&#x27;user/login&#x27;</span>)</span><br><span class="line">	&#125;,</span><br><span class="line">	handleLogin: <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> &#123;username,password&#125; = req.body</span><br><span class="line">		<span class="keyword">if</span> (!username || !password) &#123;</span><br><span class="line">			req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;該填未填!&#x27;</span>)</span><br><span class="line">			<span class="keyword">return</span> next()</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		User.findOne(&#123;</span><br><span class="line">			where: &#123;</span><br><span class="line">				username: username</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;).then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (!user) &#123;</span><br><span class="line">				req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;無此帳號!&#x27;</span>)</span><br><span class="line">				<span class="keyword">return</span> next()</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			bcrypt.compare(password, user.password, <span class="function"><span class="keyword">function</span> (<span class="params">err, isSuccess</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (err || (!isSuccess)) &#123;</span><br><span class="line">					req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;密碼錯誤!&#x27;</span>)</span><br><span class="line">					<span class="keyword">return</span> next()</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// console.log(user)</span></span><br><span class="line">				req.session.userId = user.id</span><br><span class="line">				req.session.username = user.username</span><br><span class="line">				res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">			req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, err.toString())</span><br><span class="line">			<span class="keyword">return</span> next()</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	logout: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		req.session.userId = <span class="literal">null</span></span><br><span class="line">		req.session.username = <span class="literal">null</span></span><br><span class="line">		res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = userController</span><br></pre></td></tr></table></figure>

<p>controllers&#x2F;comment.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./controllers/comment.js</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&#x27;../models&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> User = db.User</span><br><span class="line"><span class="keyword">const</span> Comment = db.Comment</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> commentController = &#123;</span><br><span class="line">	add: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		<span class="comment">// get body data</span></span><br><span class="line">		<span class="comment">// username,	userId 應只在 ejs 有作用</span></span><br><span class="line">		<span class="keyword">const</span> &#123;	username,	userId&#125; = req.session</span><br><span class="line">		<span class="keyword">const</span> &#123;	content &#125; = req.body</span><br><span class="line">		<span class="keyword">if</span> (!username || !content) &#123;</span><br><span class="line">			req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, <span class="string">&#x27;請輸入完整內容!&#x27;</span>)</span><br><span class="line">			<span class="keyword">return</span> res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Comment.create(&#123;</span><br><span class="line">			UserId: userId,</span><br><span class="line">			content: content</span><br><span class="line">		&#125;).then(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">			res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">			req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, err.toString())</span><br><span class="line">			<span class="keyword">return</span> next()</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	index: <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">		Comment.findAll(&#123;</span><br><span class="line">				include: User,</span><br><span class="line">				<span class="comment">// 加入 order</span></span><br><span class="line">				order: [</span><br><span class="line">					[<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>]</span><br><span class="line">				]</span><br><span class="line">			&#125;).then(<span class="function"><span class="params">comments</span> =&gt;</span> &#123;</span><br><span class="line">				res.render(<span class="string">&#x27;user/index&#x27;</span>, &#123;</span><br><span class="line">					comments</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;)</span><br><span class="line">			.catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">				req.flash(<span class="string">&#x27;errorMessage&#x27;</span>, err.toString())</span><br><span class="line">				<span class="keyword">return</span> next()</span><br><span class="line">			&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="keyword">delete</span>: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		Comment.findOne(&#123;</span><br><span class="line">			where: &#123;</span><br><span class="line">				id: req.params.id,</span><br><span class="line">				UserId: req.session.userId</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;).then(<span class="function"><span class="params">comment</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="comment">// return 與 no return 無差別</span></span><br><span class="line">			<span class="comment">// return comment.destroy()</span></span><br><span class="line">			comment.destroy()</span><br><span class="line">		&#125;).then( <span class="function">() =&gt;</span> &#123;</span><br><span class="line">				res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(err.toString())</span><br><span class="line">			res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	update: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		Comment.findOne(&#123;</span><br><span class="line">			where: &#123;</span><br><span class="line">				id: req.params.id,</span><br><span class="line">				UserId: req.session.userId</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;).then(<span class="function"><span class="params">comment</span> =&gt;</span> &#123;</span><br><span class="line">			res.render(<span class="string">&#x27;user/update&#x27;</span>, &#123;</span><br><span class="line">				comment</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(err.toString())</span><br><span class="line">			res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	handelUpdate: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">		Comment.findOne(&#123;</span><br><span class="line">			where: &#123;</span><br><span class="line">				id: req.params.id,</span><br><span class="line">				UserId: req.session.userId</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;).then(<span class="function"><span class="params">comment</span> =&gt;</span> &#123;</span><br><span class="line">			comment.update(&#123;</span><br><span class="line">				content: req.body.content</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;).then(<span class="function">() =&gt;</span>&#123;</span><br><span class="line">			res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">		.catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(err.toString())</span><br><span class="line">			res.redirect(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = commentController</span><br></pre></td></tr></table></figure>

<h3 id="Ngainx-and-PM2"><a href="#Ngainx-and-PM2" class="headerlink" title="Ngainx and PM2"></a>Ngainx and PM2</h3><h4 id="PM2"><a href="#PM2" class="headerlink" title="PM2"></a>PM2</h4><h5 id="command"><a href="#command" class="headerlink" title="command"></a>command</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install</span></span><br><span class="line">npm install pm2 -g</span><br><span class="line"><span class="comment"># show pm2 status</span></span><br><span class="line">pm2 ls</span><br><span class="line"><span class="comment"># run index.js(node.js)</span></span><br><span class="line">pm2 start index.js</span><br><span class="line"><span class="comment"># get process log</span></span><br><span class="line">pm2 <span class="built_in">log</span> 0</span><br><span class="line"><span class="comment"># get process information</span></span><br><span class="line">pm2 info 0</span><br><span class="line"><span class="comment"># stop process information</span></span><br><span class="line">pm2 stop 0</span><br><span class="line"><span class="comment"># restart process information</span></span><br><span class="line">pm2 restart 0</span><br><span class="line"><span class="comment"># delete process information</span></span><br><span class="line">pm2 delete 0</span><br></pre></td></tr></table></figure>

<h4 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h4><h5 id="install"><a href="#install" class="headerlink" title="install"></a>install</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install nginx</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install nginx</span><br><span class="line"><span class="comment"># install node.js</span></span><br><span class="line">sudo apt-get install nodejs</span><br><span class="line">sudo apt install npm</span><br><span class="line">sudo npm install -g npm@latest <span class="comment"># in need - install lasted version</span></span><br><span class="line"><span class="comment"># dump status and start mginx</span></span><br><span class="line">sudo systemctl status nginx</span><br><span class="line">sudo systemctl start nginx</span><br></pre></td></tr></table></figure>

<h5 id="run-web-server"><a href="#run-web-server" class="headerlink" title="run web server"></a>run web server</h5><p>index.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const express &#x3D; require(&#39;express&#39;)</span><br><span class="line">const app &#x3D; express()</span><br><span class="line">const port &#x3D; 3001</span><br><span class="line"></span><br><span class="line">app.get(&#39;&#x2F;&#39;, (req,res) &#x3D;&gt;&#123;</span><br><span class="line">                res.send(&#39;Hello, 3001....&#39;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(port, () &#x3D;&gt; &#123;</span><br><span class="line">                console.log(&#96;Example app listening at http:&#x2F;&#x2F;localhost:$&#123;port&#125;&#96;)&#125;)</span><br></pre></td></tr></table></figure>

<p>index2.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const express &#x3D; require(&#39;express&#39;)</span><br><span class="line">const app &#x3D; express()</span><br><span class="line">const port &#x3D; 3002</span><br><span class="line"></span><br><span class="line">app.get(&#39;&#x2F;&#39;, (req,res) &#x3D;&gt;&#123;</span><br><span class="line">                res.send(&#39;Hi, 3002....&#39;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(port, () &#x3D;&gt; &#123;</span><br><span class="line">                console.log(&#96;Example app listening at http:&#x2F;&#x2F;localhost:$&#123;port&#125;&#96;)&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># start web server</span></span><br><span class="line">pm2 start index.js</span><br><span class="line">pm2 start index2.js</span><br></pre></td></tr></table></figure>

<h4 id="set-for-DNS"><a href="#set-for-DNS" class="headerlink" title="set for DNS"></a>set for DNS</h4><div style="maxwidth:1000px">
    <img src="/2021/08/03/express-1/pic1.png" class="" title="pic1">
</div>

<h5 id="configure-nginx-to-web-server"><a href="#configure-nginx-to-web-server" class="headerlink" title="configure nginx to web server"></a>configure nginx to web server</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/aaa.website</span><br><span class="line">sudo vim /etc/nginx/sites-available/bbb.website</span><br></pre></td></tr></table></figure>

<p>aaa.website</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">       listen <span class="number">80</span>;</span><br><span class="line">       server_name aaa.hot5656.website;</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">         proxy_pass http:<span class="comment">//127.0.0.1:3001;</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>bbb.website</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">       listen 80;</span><br><span class="line">       server_name bbb.hot5656.website;</span><br><span class="line"></span><br><span class="line">       location &#x2F; &#123;</span><br><span class="line">         proxy_pass http:&#x2F;&#x2F;127.0.0.1:3002;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>add soft link </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /etc/nginx/sites-available/aaa.website /etc/nginx/sites-enabled/</span><br><span class="line">sudo ln -s /etc/nginx/sites-available/bbb.website /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure>

<h5 id="reload-nginx"><a href="#reload-nginx" class="headerlink" title="reload nginx"></a>reload nginx</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reload nginx</span><br><span class="line">sudo systemctl status nginx</span><br></pre></td></tr></table></figure>

<h3 id="Heroku"><a href="#Heroku" class="headerlink" title="Heroku"></a>Heroku</h3><h4 id="develop-node-js-no-db"><a href="#develop-node-js-no-db" class="headerlink" title="develop node.js - no db"></a>develop node.js - no db</h4><h5 id="install-Heroku-CLI"><a href="#install-Heroku-CLI" class="headerlink" title="install Heroku CLI"></a>install <a target="_blank" rel="noopener" href="https://devcenter.heroku.com/articles/heroku-cli">Heroku CLI</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">heroku -v</span><br><span class="line">node -v</span><br></pre></td></tr></table></figure>

<h5 id="package-json-add-“script-start”-and-“engines”"><a href="#package-json-add-“script-start”-and-“engines”" class="headerlink" title="package.json add “script start” and “engines”"></a>package.json add “script start” and “engines”</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;start&quot;</span>: <span class="string">&quot;node app.js&quot;</span>,</span><br><span class="line">  <span class="string">&quot;test&quot;</span>: <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;engines&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;node&quot;</span>: <span class="string">&quot;14.x&quot;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h5 id="set-env-port"><a href="#set-env-port" class="headerlink" title="set env port"></a>set env port</h5><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">5001</span></span><br></pre></td></tr></table></figure>

<h5 id="run-heroku-local-test"><a href="#run-heroku-local-test" class="headerlink" title="run heroku local test"></a>run heroku local test</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heroku <span class="built_in">local</span> web</span><br></pre></td></tr></table></figure>

<h5 id="develop-to-heroku"><a href="#develop-to-heroku" class="headerlink" title="develop to heroku"></a>develop to heroku</h5><p>add .gitignore</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_modules&#x2F;</span><br></pre></td></tr></table></figure>

<p>git init and commit</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git init </span><br><span class="line">git add .</span><br><span class="line">git status</span><br><span class="line">git commit -m <span class="string">&quot;1st commit&quot;</span></span><br><span class="line">git show-ref</span><br></pre></td></tr></table></figure>

<p>push to heroku</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># login </span></span><br><span class="line">heroku login</span><br><span class="line"><span class="comment"># create app</span></span><br><span class="line">heroku create</span><br><span class="line"><span class="comment"># list app</span></span><br><span class="line">heroku lis</span><br><span class="line"><span class="comment"># delete app - if need detele other app</span></span><br><span class="line"><span class="comment"># heroku apps:destroy afternoon-plains-5751</span></span><br><span class="line">git remote -v</span><br><span class="line">	heroku  https://git.heroku.com/mysterious-ravine-06292.git (fetch)</span><br><span class="line">	heroku  https://git.heroku.com/mysterious-ravine-06292.git (push)</span><br><span class="line"><span class="comment"># push to heroku</span></span><br><span class="line">git push heroku master</span><br><span class="line"><span class="comment"># open by local browser</span></span><br><span class="line">heroku open</span><br></pre></td></tr></table></figure>

<h4 id="develop-node-js-include-db"><a href="#develop-node-js-include-db" class="headerlink" title="develop node.js - include db"></a>develop node.js - include db</h4><h5 id="install-Heroku-CLI-1"><a href="#install-Heroku-CLI-1" class="headerlink" title="install Heroku CLI"></a>install <a target="_blank" rel="noopener" href="https://devcenter.heroku.com/articles/heroku-cli">Heroku CLI</a></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">heroku -v</span><br><span class="line">node -v</span><br></pre></td></tr></table></figure>

<h5 id="package-json-add-“script-start”-and-“engines”-1"><a href="#package-json-add-“script-start”-and-“engines”-1" class="headerlink" title="package.json add “script start” and “engines”"></a>package.json add “script start” and “engines”</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;start&quot;</span>: <span class="string">&quot;node index.js&quot;</span>,</span><br><span class="line">  <span class="string">&quot;test&quot;</span>: <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;engines&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;node&quot;</span>: <span class="string">&quot;14.x&quot;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h5 id="set-env-port-1"><a href="#set-env-port-1" class="headerlink" title="set env port"></a>set env port</h5><p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span></span><br></pre></td></tr></table></figure>

<h5 id="run-heroku-local-test-1"><a href="#run-heroku-local-test-1" class="headerlink" title="run heroku local test"></a>run heroku local test</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heroku <span class="built_in">local</span> web</span><br></pre></td></tr></table></figure>

<h5 id="develop-to-heroku-1"><a href="#develop-to-heroku-1" class="headerlink" title="develop to heroku"></a>develop to heroku</h5><p>add .gitignore</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_modules&#x2F;</span><br></pre></td></tr></table></figure>

<p>git init </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git status</span><br><span class="line">git commit -m <span class="string">&quot;1st commit&quot;</span></span><br><span class="line">git show-ref</span><br></pre></td></tr></table></figure>

<p>push to heroku</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># login - if never login</span></span><br><span class="line"><span class="comment"># heroku login</span></span><br><span class="line"><span class="comment"># create app</span></span><br><span class="line">heroku create</span><br><span class="line"><span class="comment"># list app - if want to see other app</span></span><br><span class="line"><span class="comment"># delete app - if need detele other app</span></span><br><span class="line"><span class="comment"># heroku lis</span></span><br><span class="line">git remote -v</span><br><span class="line">	heroku  https://git.heroku.com/mysterious-ravine-06292.git (fetch)</span><br><span class="line">	heroku  https://git.heroku.com/mysterious-ravine-06292.git (push)</span><br><span class="line"><span class="comment"># push to heroku</span></span><br><span class="line">git push heroku master</span><br><span class="line"><span class="comment"># open by local browser</span></span><br><span class="line">heroku open</span><br></pre></td></tr></table></figure>

<h5 id="develop-db-for-heroku"><a href="#develop-db-for-heroku" class="headerlink" title="develop db for heroku"></a>develop db for heroku</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># show logs for debug</span></span><br><span class="line">heroku logs -–tail</span><br><span class="line"><span class="comment"># add db</span></span><br><span class="line">heroku addons:create cleardb:ignite</span><br></pre></td></tr></table></figure>

<p>check models&#x2F;index.js see use_env_variable for db parameter</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">let sequelize;</span><br><span class="line">if (config.use_env_variable) &#123;</span><br><span class="line">  sequelize = new Sequelize(process.env[config.use_env_variable], config);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  sequelize = new Sequelize(config.database, config.username, config.password, config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>check heroku db env name</p>
<div style="maxwidth:1000px">
    <img src="/2021/08/03/express-1/pic2.png" class="" title="pic2">
</div>

<p>set config&#x2F;config.json</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;production&quot;: &#123;</span><br><span class="line">  &quot;username&quot;: &quot;root&quot;,</span><br><span class="line">  &quot;password&quot;: null,</span><br><span class="line">  &quot;database&quot;: &quot;database_production&quot;,</span><br><span class="line">  &quot;host&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">  &quot;dialect&quot;: &quot;mysql&quot;,</span><br><span class="line">  &quot;use_env_variable&quot;: &quot;CLEARDB_DATABASE_URL&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>commit + push to heroku</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m &quot;add db config&quot;</span><br><span class="line">git push heroku master</span><br></pre></td></tr></table></figure>

<p>add migrate script to package.json</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">  &quot;db:migrate&quot;: &quot;npx sequelize db:migrate&quot;,</span><br><span class="line">  &quot;start&quot;: &quot;npm run db:migrate &amp;&amp; node index.js&quot;,</span><br><span class="line">  &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>commit + push to heroku</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;add db migrate&quot;</span></span><br><span class="line">git push heroku master</span><br></pre></td></tr></table></figure>

<h5 id="heidisql-link-to-heroku-db"><a href="#heidisql-link-to-heroku-db" class="headerlink" title="heidisql link to heroku db"></a>heidisql link to heroku db</h5><div style="width:500px">
    <img src="/2021/08/03/express-1/pic3.png" class="" title="pic3">
</div>


<h3 id="AWS-部署-node-js-express-nginx"><a href="#AWS-部署-node-js-express-nginx" class="headerlink" title="AWS 部署(node.js + express + nginx)"></a>AWS 部署(node.js + express + nginx)</h3><h4 id="install-nginx-node-js-npm-pm2"><a href="#install-nginx-node-js-npm-pm2" class="headerlink" title="install nginx, node.js, npm, pm2"></a>install nginx, node.js, npm, pm2</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install nginx</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install nginx</span><br><span class="line"><span class="comment"># 順序有關係 - install node,npmx</span></span><br><span class="line">sudo apt-get install nodejs</span><br><span class="line">sudo apt-get install npm</span><br><span class="line"><span class="comment"># insuall pm2</span></span><br><span class="line">sudo npm install pm2 -g </span><br><span class="line"><span class="comment"># found error , upgrade npm</span></span><br><span class="line">sudo npm install -g npm@latest</span><br><span class="line">sudo npm install pm2 -g</span><br></pre></td></tr></table></figure>

<h4 id="install-mysql"><a href="#install-mysql" class="headerlink" title="install mysql"></a>install mysql</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install MySQL</span></span><br><span class="line">sudo apt install mysql-server</span><br><span class="line"><span class="comment"># Run the security script </span></span><br><span class="line">sudo mysql_secure_installation</span><br><span class="line"><span class="comment"># Creating MySQL User (robert)</span></span><br><span class="line">sudo mysql</span><br><span class="line">mysql&gt; CREATE USER <span class="string">&#x27;robert&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;passwrod&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改 root password Password Plugin to mysql_native_password for remote login</span></span><br><span class="line">mysql&gt; ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;passwrod&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授予 user 權限</span></span><br><span class="line">mysql&gt; GRANT ALL  ON mydb2.* TO <span class="string">&#x27;robert&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># create database - 特別要用反引號</span></span><br><span class="line">mysql&gt; CREATE DATABASE `mydb2`;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># free previous command cache </span></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="built_in">exit</span></span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>

<h4 id="其他-app-連至-MySQL"><a href="#其他-app-連至-MySQL" class="headerlink" title="其他 app 連至 MySQL"></a>其他 app 連至 MySQL</h4><h5 id="Inbound-Rules-新增-HTTP-TCP-port-3306"><a href="#Inbound-Rules-新增-HTTP-TCP-port-3306" class="headerlink" title="Inbound Rules 新增 HTTP TCP port:3306"></a>Inbound Rules 新增 HTTP TCP port:3306</h5><div style="maxwidth:1000px">
    <img src="/2021/08/03/express-1/pic4.png" class="" title="pic4">
</div>

<h5 id="mask-bind-address-允許連線主機"><a href="#mask-bind-address-允許連線主機" class="headerlink" title="mask bind-address(允許連線主機)"></a>mask bind-address(允許連線主機)</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/mysql/mysql.conf.d/mysqld.cnf</span><br><span class="line"><span class="comment"># --- 原來</span></span><br><span class="line">bind-address          = 127.0.0.1</span><br><span class="line"><span class="comment"># --- 修改後</span></span><br><span class="line"><span class="comment"># bind-address          = 127.0.0.1</span></span><br></pre></td></tr></table></figure>

<h5 id="root-localhost-改成"><a href="#root-localhost-改成" class="headerlink" title="root localhost 改成 %"></a>root localhost 改成 %</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -u root -p</span><br><span class="line">Enter password:</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT user,plugin,host FROM mysql.user;</span><br><span class="line">	+------------------+-----------------------+-----------+</span><br><span class="line">	| user             | plugin                | host      |</span><br><span class="line">	+------------------+-----------------------+-----------+</span><br><span class="line">	| debian-sys-maint | caching_sha2_password | localhost |</span><br><span class="line">	| mysql.infoschema | caching_sha2_password | localhost |</span><br><span class="line">	| mysql.session    | caching_sha2_password | localhost |</span><br><span class="line">	| mysql.sys        | caching_sha2_password | localhost |</span><br><span class="line">	| phpmyadmin       | caching_sha2_password | localhost |</span><br><span class="line">	| robert           | caching_sha2_password | localhost |</span><br><span class="line">	| root             | mysql_native_password | localhost |</span><br><span class="line">	+------------------+-----------------------+-----------+</span><br><span class="line">	7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use mysql;</span><br><span class="line">	Reading table information <span class="keyword">for</span> completion of table and column names</span><br><span class="line">	You can turn off this feature to get a quicker startup with -A</span><br><span class="line">	Database changed</span><br><span class="line"></span><br><span class="line">mysql&gt; update user <span class="built_in">set</span> host =<span class="string">&#x27;%&#x27;</span><span class="built_in">where</span> user =<span class="string">&#x27;root&#x27;</span> and host =<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">	Query OK, 1 row affected (0.01 sec)</span><br><span class="line">	Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT user,plugin,host FROM mysql.user;</span><br><span class="line">	+------------------+-----------------------+-----------+</span><br><span class="line">	| user             | plugin                | host      |</span><br><span class="line">	+------------------+-----------------------+-----------+</span><br><span class="line">	| root             | mysql_native_password | %         |</span><br><span class="line">	| debian-sys-maint | caching_sha2_password | localhost |</span><br><span class="line">	| mysql.infoschema | caching_sha2_password | localhost |</span><br><span class="line">	| mysql.session    | caching_sha2_password | localhost |</span><br><span class="line">	| mysql.sys        | caching_sha2_password | localhost |</span><br><span class="line">	| phpmyadmin       | caching_sha2_password | localhost |</span><br><span class="line">	| robert           | caching_sha2_password | localhost |</span><br><span class="line">	+------------------+-----------------------+-----------+</span><br><span class="line">	7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">	Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br><span class="line">	Bye</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># restart mysql</span></span><br><span class="line">sudo systemctl restart mysql</span><br></pre></td></tr></table></figure>

<h5 id="heidisq-port-3306-setting"><a href="#heidisq-port-3306-setting" class="headerlink" title="heidisq port 3306 setting"></a>heidisq port 3306 setting</h5><div style="width:500px">
    <img src="/2021/08/03/express-1/pic5.png" class="" title="pic5">
</div>

<h4 id="install-and-start-app"><a href="#install-and-start-app" class="headerlink" title="install and start app"></a>install and start app</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ftp load code ex3-sequelize</span></span><br><span class="line"><span class="comment"># install module and migrate db</span></span><br><span class="line">npm install</span><br><span class="line">sudo npx sequelize-cli db:migrate</span><br><span class="line"><span class="comment"># ftp load code ex3-sequelize</span></span><br><span class="line">npm install</span><br><span class="line">sudo npx sequelize-cli db:migrate</span><br><span class="line"><span class="comment"># fireware open port 3000 and 5000 for app using</span></span><br><span class="line"><span class="comment"># start app</span></span><br><span class="line">~/ex3-sequelize$ pm2 start index.js</span><br><span class="line">~/blog$ pm2 start index.js</span><br></pre></td></tr></table></figure>

<h4 id="run-nginx"><a href="#run-nginx" class="headerlink" title="run nginx"></a>run nginx</h4><p>configure nginx to web server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/nginx/sites-available/aaa.website</span><br><span class="line">sudo vim /etc/nginx/sites-available/bbb.website</span><br></pre></td></tr></table></figure>

<p>aaa.website</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">       listen <span class="number">80</span>;</span><br><span class="line">       server_name aaa.hot5656.website;</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">         proxy_pass http:<span class="comment">//127.0.0.1:3000;</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>bbb.website</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">       listen <span class="number">80</span>;</span><br><span class="line">       server_name bbb.hot5656.website;</span><br><span class="line"></span><br><span class="line">       location / &#123;</span><br><span class="line">         proxy_pass http:<span class="comment">//127.0.0.1:5000;</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>add soft link </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /etc/nginx/sites-available/aaa.website /etc/nginx/sites-enabled/</span><br><span class="line">sudo ln -s /etc/nginx/sites-available/bbb.website /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure>

<p>reload nginx </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl reload nginx</span><br><span class="line"><span class="comment"># check nginx log in need</span></span><br><span class="line">sudo nano /var/<span class="built_in">log</span>/nginx/error.log</span><br></pre></td></tr></table></figure>

<h3 id="npm-mysql"><a href="#npm-mysql" class="headerlink" title="npm mysql"></a>npm mysql</h3><h4 id="example-1"><a href="#example-1" class="headerlink" title="example #1"></a>example #1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install mysql</span></span><br><span class="line">npm install mysql</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// db.js</span></span><br><span class="line"><span class="keyword">var</span> mysql      = <span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> connection = mysql.createConnection(&#123;</span><br><span class="line">  host     : <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  user     : <span class="string">&#x27;robert&#x27;</span>,</span><br><span class="line">  password : <span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">  database : <span class="string">&#x27;app&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">connection.connect();</span><br><span class="line"> </span><br><span class="line">connection.query(<span class="string">&#x27;SELECT * from todos&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, results, fields</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">  <span class="built_in">console</span>.log(results[<span class="number">0</span>].content);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">connection.end();</span><br></pre></td></tr></table></figure>



<h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://expressjs.com/">Express</a></li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/mysql">npm mysql</a></li>
<li><a target="_blank" rel="noopener" href="https://expressjs.com/zh-tw/guide/using-middleware.html">Express 中介軟體</a></li>
<li><a target="_blank" rel="noopener" href="http://expressjs.com/en/resources/middleware/body-parser.html">body-parser</a></li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/connect-flash">connect-flash</a></li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/bcrypt">bcrypt</a></li>
<li><a target="_blank" rel="noopener" href="https://sequelize.org/">Sequelize</a></li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/sequelize-cli">sequelize&#x2F;cli</a></li>
<li><a target="_blank" rel="noopener" href="https://pm2.keymetrics.io/docs/usage/quick-start/">PM2</a></li>
<li><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-20-04">How To Install Nginx on Ubuntu 20.04</a></li>
<li><a target="_blank" rel="noopener" href="https://devcenter.heroku.com/articles/getting-started-with-nodejs?singlepage=true">Getting Started on Heroku with Node.js</a></li>
<li><a target="_blank" rel="noopener" href="https://devcenter.heroku.com/articles/cleardb">Heroku - ClearDB MySQL</a></li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/cors">npm CORS</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/express/" rel="tag"># express</a>
              <a href="/tags/node-js/" rel="tag"># node.js</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/07/25/tool-3/" rel="prev" title="前端 package build 練習">
                  <i class="fa fa-chevron-left"></i> 前端 package build 練習
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/08/14/express-2/" rel="next" title="Express practice">
                  Express practice <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Robert Kao</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="總字數">2.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">40:58</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  




  


<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://hot5656-blog.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://hot5656.github.io/2021/08/03/express-1/";
    this.page.identifier = "2021/08/03/express-1/";
    this.page.title = "Express";
    };
  NexT.utils.loadComments('#disqus_thread', () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://hot5656-blog.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
